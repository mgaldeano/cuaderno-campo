<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reportes | Cuaderno de Campo</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Select - versi√≥n compatible con Bootstrap 5 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Google Fonts Roboto -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="estilos.css">
    
    <style>
      /* Personalizaci√≥n Bootstrap Select para Bootstrap 5 */
      .bootstrap-select .dropdown-menu {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: 1px solid #dee2e6;
      }
      
      .bootstrap-select .dropdown-menu li a {
        padding: 8px 16px 8px 40px !important;
        font-family: 'Roboto', sans-serif;
        transition: all 0.2s ease;
      }
      
      .bootstrap-select .dropdown-menu li a span.check-mark {
        left: 12px;
        color: #0d6efd;
        font-size: 1.1em;
        font-weight: bold;
      }
      
      .bootstrap-select .dropdown-menu li.selected a {
        background-color: #e7f3ff;
        color: #0d6efd;
        font-weight: 500;
      }
      
      .bootstrap-select .dropdown-menu li a:hover {
        background-color: #f8f9fa;
      }
      
      .bootstrap-select .dropdown-menu li.selected a:hover {
        background-color: #d1ecf1;
      }
      
      .bootstrap-select > .dropdown-toggle {
        border-radius: 6px;
        border: 1px solid #ced4da;
        padding: 8px 12px;
        font-family: 'Roboto', sans-serif;
      }
      
      .bootstrap-select > .dropdown-toggle:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
      }
      
      /* Botones de acciones (Seleccionar todas/ninguna) */
      .bootstrap-select .bs-actionsbox {
        padding: 8px 12px;
        border-bottom: 1px solid #dee2e6;
        background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
        margin-bottom: 2px;
      }
      
      .bootstrap-select .bs-actionsbox .btn-group {
        width: 100%;
        display: flex;
        gap: 4px;
      }
      
      .bootstrap-select .bs-actionsbox .btn-group button {
        font-size: 11px;
        padding: 6px 12px;
        border-radius: 4px;
        border: 1px solid #0d6efd;
        background: #ffffff;
        color: #0d6efd;
        font-weight: 600;
        flex: 1;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.2s ease;
      }
      
      .bootstrap-select .bs-actionsbox .btn-group button:hover {
        background: #0d6efd;
        border-color: #0d6efd;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
      }
      
      /* Asegurar que el actionsBox siempre sea visible */
      .bootstrap-select.open .bs-actionsbox {
        display: block !important;
      }
    </style>
    
    <!-- jQuery (necesario para Bootstrap Select) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Bootstrap Select JS - versi√≥n beta para Bootstrap 5 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
    <!-- SheetJS para exportar a Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- jsPDF para exportar a PDF -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  </head>
  <body>
    <div id="header-container"></div>

    <!-- Navegaci√≥n din√°mica: se carga desde header.html en #header-container -->

    <main class="container py-4">
      <!-- Header Section -->
      <div class="container-fluid bg-light py-3 mb-4">
        <div class="container">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="h3 mb-1 text-primary font-weight-bold">
                <i class="bi bi-graph-up text-primary me-2"></i>
                Reportes y An√°lisis
              </h1>
              <p class="text-muted mb-0">Genere reportes detallados de sus actividades agr√≠colas</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Formulario de Filtros -->
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm border-0" style="border-radius: 16px;">
            <div class="card-header bg-white border-0 pt-4 pb-0">
              <h5 class="card-title mb-0 d-flex align-items-center">
                <i class="bi bi-funnel text-primary me-2"></i>
                <span>Configuraci√≥n del Reporte</span>
              </h5>
            </div>
            <div class="card-body p-4">
              <form id="reportes-filtros" class="mb-0">
                <div class="row mb-4">
                  <div class="col-md-6">
                    <label for="tipo-reporte" class="form-label font-weight-medium">
                      <i class="bi bi-file-earmark-bar-graph me-1"></i> Tipo de Reporte *
                    </label>
                    <select id="tipo-reporte" class="form-select" required>
                      <option value="riegos">üìä Riegos realizados</option>
                      <option value="riegos-regador">üë§ Riegos por regador</option>
                      <option value="agroquimicos">üß™ Aplicaciones de agroqu√≠micos</option>
                      <option value="fertilizaciones">üå± Fertilizaciones</option>
                      <option value="labores">üöú Labores de suelo</option>
                      <option value="bpa">‚úÖ Normas BPA (auditor√≠a)</option>
                    </select>
                  </div>
                </div>

                <!-- Filtros generales -->
                <div id="filtros-generales">
                  <div class="row mb-4">
                    <div class="col-md-4">
                      <label for="finca-reporte" class="form-label font-weight-medium">
                        <i class="bi bi-geo-alt me-1"></i> Fincas
                      </label>
                      <select id="finca-reporte" class="form-select selectpicker" multiple 
                              title="Seleccione fincas..." data-live-search="true">
                      </select>
                      <div class="form-text">Filtra por fincas seleccionadas</div>
                    </div>
                    <div class="col-md-4">
                      <label for="cuartel-reporte" class="form-label font-weight-medium">
                        <i class="bi bi-grid me-1"></i> Cuarteles
                      </label>
                      <select id="cuartel-reporte" class="form-select selectpicker" multiple 
                              title="Seleccione cuarteles..." data-live-search="true">
                      </select>
                      <div class="form-text">Filtra por cuarteles seleccionados</div>
                    </div>
                    <div class="col-md-4">
                      <label for="regador-reporte" class="form-label font-weight-medium">
                        <i class="bi bi-person me-1"></i> Regadores
                      </label>
                      <select id="regador-reporte" class="form-select selectpicker" multiple 
                              title="Seleccione regadores..." data-live-search="true">
                      </select>
                      <div class="form-text">Filtra por regadores seleccionados</div>
                    </div>
                  </div>

                  <div class="row mb-4">
                    <div class="col-md-6">
                      <label for="fecha-desde" class="form-label font-weight-medium">
                        <i class="bi bi-calendar-event me-1"></i> Fecha Desde
                      </label>
                      <input type="date" id="fecha-desde" class="form-control" value="2000-01-01" />
                      <div class="form-text">Filtra registros desde esta fecha</div>
                    </div>
                    <div class="col-md-6">
                      <label for="fecha-hasta" class="form-label font-weight-medium">
                        <i class="bi bi-calendar-check me-1"></i> Fecha Hasta
                      </label>
                      <input type="date" id="fecha-hasta" class="form-control" />
                      <div class="form-text">Filtra registros hasta esta fecha</div>
                    </div>
                  </div>
                </div>

                <!-- Contenedores para filtros espec√≠ficos seg√∫n rol -->
                <div id="filtros-productor" style="display:none;"></div>
                <div id="filtros-operador" style="display:none;"></div>

                <div class="d-flex justify-content-between align-items-center">
                  <button type="submit" class="btn btn-primary btn-lg px-4">
                    <i class="bi bi-play-circle me-2"></i>
                    Generar Reporte
                  </button>
                  <div>
                    <button id="exportar-excel" type="button" class="btn btn-success me-2">
                      <i class="bi bi-file-earmark-excel me-1"></i> Excel
                    </button>
                    <button id="exportar-csv" type="button" class="btn btn-info me-2">
                      <i class="bi bi-filetype-csv me-1"></i> CSV
                    </button>
                    <button id="exportar-pdf" type="button" class="btn btn-danger">
                      <i class="bi bi-file-earmark-pdf me-1"></i> PDF
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Resultados del Reporte -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="card shadow-sm border-0" style="border-radius: 16px;">
            <div class="card-header bg-white border-0 pt-4 pb-0">
              <h5 class="card-title mb-0 d-flex align-items-center">
                <i class="bi bi-table text-primary me-2"></i>
                <span>Resultados del Reporte</span>
                <span class="badge bg-primary ms-2" id="total-registros">0</span>
              </h5>
            </div>
            <div class="card-body p-4">
              <div id="reportes-resultado">
                <div class="text-center py-5 text-muted">
                  <i class="bi bi-graph-up-arrow fs-1 mb-3 d-block"></i>
                  <h5>Configure los filtros y genere su reporte</h5>
                  <p>Seleccione el tipo de reporte y configure los filtros para comenzar</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="container">
      <small><a href="privacidad.html">Privacidad</a> ‚Ä¢ <a href="terminos-condiciones.html">T√©rminos</a></small>
      <br>
      <small id="footer-version" style="color:#888;"></small>
    </footer>

    <!-- Script principal de reportes -->
    <script type="module">
      import { supabase } from "./supabaseClient.js";
      
      // Verificar autenticaci√≥n
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = "login.html";
        throw new Error("No autorizado");
      }
      
      // Cargar header
      fetch('header.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('header-container').innerHTML = html;
          import('./header.js');
        });

      // Variables globales para almacenar datos
      let todasLasFincas = [];
      let todosLosCuarteles = [];
      let todosLosRegadores = [];

      const contenedor = document.querySelector("#reportes-resultado");

      // Inicializaci√≥n despu√©s de que DOM est√© listo
      $(document).ready(function() {
        // Configurar fecha hasta como hoy
        const hoy = new Date().toISOString().split('T')[0];
        document.getElementById('fecha-hasta').value = hoy;

        // Inicializar Bootstrap Select
        $('.selectpicker').selectpicker({
          actionsBox: true,
          selectAllText: 'Todas',
          deselectAllText: 'Ninguna',
          countSelectedText: function(numSelected, numTotal) {
            return numSelected + ' de ' + numTotal + ' seleccionadas';
          },
          selectedTextFormat: 'count > 2',
          liveSearch: true,
          liveSearchPlaceholder: 'Buscar...',
          noneSelectedText: 'Seleccione opciones...',
          style: 'btn-outline-secondary'
        });

        // Cargar opciones iniciales
        cargarFincasReporte();
        cargarRegadoresReporte();

        // Configurar evento para cascada fincas ‚Üí cuarteles
        $('#finca-reporte').on('changed.bs.select', function() {
          cargarCuartelesReporte();
        });

        // Configurar formulario
        document.getElementById('reportes-filtros').addEventListener('submit', async (e) => {
          e.preventDefault();
          const tipoReporte = document.getElementById('tipo-reporte').value;
          await generarReportePorTipo(tipoReporte);
        });
      });

      // Funci√≥n para cargar fincas en el reporte
      async function cargarFincasReporte() {
        try {
          const { data: fincas, error } = await supabase
            .from('fincas')
            .select('id, nombre_finca, direccion, usuario_id')
            .eq('usuario_id', user.id)
            .order('nombre_finca');
          
          if (error) throw error;
          
          todasLasFincas = fincas || [];
          
          // Limpiar y repoblar el selector
          const selector = $('#finca-reporte');
          selector.empty();
          
          // Agregar opci√≥n "Todas"
          selector.append(`<option value="todas">Todas las fincas</option>`);
          
          todasLasFincas.forEach(finca => {
            const displayName = finca.nombre_finca || `Finca ${finca.id}`;
            selector.append(`<option value="${finca.id}">${displayName}</option>`);
          });
          
          // Refrescar Bootstrap Select
          selector.selectpicker('refresh');
          
        } catch (error) {
          console.error('Error cargando fincas:', error);
        }
      }

      // Funci√≥n para cargar cuarteles seg√∫n fincas seleccionadas
      async function cargarCuartelesReporte() {
        try {
          const fincasSeleccionadas = $('#finca-reporte').val();
          
          // Limpiar selector de cuarteles
          const selector = $('#cuartel-reporte');
          selector.empty();
          
          // Agregar opci√≥n "Todos"
          selector.append(`<option value="todos">Todos los cuarteles</option>`);
          
          let cuarteles = [];
          
          if (!fincasSeleccionadas || fincasSeleccionadas.length === 0) {
            selector.selectpicker('refresh');
            return;
          }
          
          // Si se seleccion√≥ "todas", obtener todas las fincas del usuario
          if (fincasSeleccionadas.includes('todas')) {
            const { data: todasFincas } = await supabase
              .from('fincas')
              .select('id')
              .eq('usuario_id', user.id);
            
            const fincaIds = todasFincas?.map(f => f.id) || [];
            
            const { data: cuartelesData, error } = await supabase
              .from('cuarteles')
              .select('id, nombre, finca_id')
              .in('finca_id', fincaIds)
              .order('nombre');
            
            if (error) throw error;
            cuarteles = cuartelesData || [];
          } else {
            // Filtrar "todas" de la selecci√≥n
            const fincaIds = fincasSeleccionadas.filter(id => id !== 'todas');
            
            if (fincaIds.length > 0) {
              const { data: cuartelesData, error } = await supabase
                .from('cuarteles')
                .select('id, nombre, finca_id')
                .in('finca_id', fincaIds)
                .order('nombre');
              
              if (error) throw error;
              cuarteles = cuartelesData || [];
            }
          }
          
          // Filtrar duplicados
          const cuartelesUnicos = cuarteles.filter((cuartel, index, self) => 
            index === self.findIndex(c => c.id === cuartel.id)
          );
          
          todosLosCuarteles = cuartelesUnicos;
          
          // Poblar selector con cuarteles √∫nicos
          cuartelesUnicos.forEach(cuartel => {
            const nombreCuartel = cuartel.nombre || `Cuartel ${cuartel.id}`;
            selector.append(`<option value="${cuartel.id}">${nombreCuartel}</option>`);
          });
          
          // Refrescar Bootstrap Select
          selector.selectpicker('refresh');
          
        } catch (error) {
          console.error('Error cargando cuarteles:', error);
        }
      }

      // Funci√≥n para cargar regadores
      async function cargarRegadoresReporte() {
        try {
          // Obtener regadores del productor actual
          const { data: regadores, error } = await supabase
            .from('usuarios')
            .select('id, nombre, email, rol')
            .eq('rol', 'operador')
            .order('nombre');
          
          if (error) throw error;
          
          todosLosRegadores = regadores || [];
          
          // Poblar selector de regadores
          const selector = $('#regador-reporte');
          selector.empty();
          
          // Agregar opci√≥n "Todos"
          selector.append(`<option value="todos">Todos los regadores</option>`);
          
          todosLosRegadores.forEach(regador => {
            const displayName = regador.nombre || regador.email || `Usuario ${regador.id}`;
            selector.append(`<option value="${regador.id}">${displayName}</option>`);
          });
          
          // Refrescar Bootstrap Select
          selector.selectpicker('refresh');
          
        } catch (error) {
          console.error('Error cargando regadores:', error);
        }
      }

      // Funci√≥n para generar reportes seg√∫n el tipo
      async function generarReportePorTipo(tipo) {
        try {
          contenedor.innerHTML = `
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
              <p class="mt-3">Generando reporte de ${tipo}...</p>
            </div>
          `;

          let data, error;
          let columns = [];
          let title = '';

          switch(tipo) {
            case 'riegos':
              ({ data, error } = await supabase
                .from("riegos")
                .select("id, fecha, finca_id, cuartel_id, horas_riego, volumen_agua, observaciones")
                .order("fecha", { ascending: false })
                .limit(100));
              columns = [
                { key: 'fecha', label: 'Fecha', icon: 'calendar3', format: 'date' },
                { key: 'finca_id', label: 'Finca ID', icon: 'geo-alt' },
                { key: 'cuartel_id', label: 'Cuartel ID', icon: 'grid' },
                { key: 'horas_riego', label: 'Horas', icon: 'clock' },
                { key: 'volumen_agua', label: 'Volumen (L)', icon: 'droplet' },
                { key: 'observaciones', label: 'Observaciones', icon: 'chat-text', format: 'truncate' }
              ];
              title = 'Riegos Realizados';
              break;

            case 'riegos-regador':
              ({ data, error } = await supabase
                .from("riegos")
                .select("id, fecha, operador_id, finca_id, cuartel_id, horas_riego, volumen_agua")
                .order("fecha", { ascending: false })
                .limit(100));
              columns = [
                { key: 'fecha', label: 'Fecha', icon: 'calendar3', format: 'date' },
                { key: 'operador_id', label: 'Regador ID', icon: 'person' },
                { key: 'finca_id', label: 'Finca ID', icon: 'geo-alt' },
                { key: 'cuartel_id', label: 'Cuartel ID', icon: 'grid' },
                { key: 'horas_riego', label: 'Horas', icon: 'clock' },
                { key: 'volumen_agua', label: 'Volumen (L)', icon: 'droplet' }
              ];
              title = 'Riegos por Regador';
              break;

            case 'agroquimicos':
              // Mostrar mensaje de funcionalidad futura
              contenedor.innerHTML = `
                <div class="text-center py-5 text-muted">
                  <i class="bi bi-tools fs-1 mb-3 d-block"></i>
                  <h5>Funcionalidad en desarrollo</h5>
                  <p>El reporte de aplicaciones de agroqu√≠micos estar√° disponible pr√≥ximamente</p>
                </div>
              `;
              return;

            case 'fertilizaciones':
              // Mostrar datos de fertilizantes como sustituto temporal
              ({ data, error } = await supabase
                .from("fertilizantes")
                .select("id, producto, formula, n, p, k")
                .order("producto")
                .limit(50));
              columns = [
                { key: 'producto', label: 'Producto', icon: 'flower1' },
                { key: 'formula', label: 'F√≥rmula', icon: 'calculator' },
                { key: 'n', label: 'N %', icon: 'arrow-up' },
                { key: 'p', label: 'P %', icon: 'arrow-right' },
                { key: 'k', label: 'K %', icon: 'arrow-down' }
              ];
              title = 'Fertilizantes Disponibles';
              break;

            case 'labores':
              // Mostrar mensaje de funcionalidad futura
              contenedor.innerHTML = `
                <div class="text-center py-5 text-muted">
                  <i class="bi bi-tools fs-1 mb-3 d-block"></i>
                  <h5>Funcionalidad en desarrollo</h5>
                  <p>El reporte de labores de suelo estar√° disponible pr√≥ximamente</p>
                </div>
              `;
              return;

            case 'bpa':
              // Mostrar mensaje de funcionalidad futura
              contenedor.innerHTML = `
                <div class="text-center py-5 text-muted">
                  <i class="bi bi-award fs-1 mb-3 d-block"></i>
                  <h5>Funcionalidad en desarrollo</h5>
                  <p>El reporte de normas BPA estar√° disponible pr√≥ximamente</p>
                </div>
              `;
              return;

            default:
              throw new Error('Tipo de reporte no reconocido');
          }

          if (error) throw error;

          if (!data || data.length === 0) {
            contenedor.innerHTML = `
              <div class="text-center py-5 text-muted">
                <i class="bi bi-inbox fs-1 mb-3 d-block"></i>
                <h5>No hay datos para ${title}</h5>
                <p>No se encontraron registros para este tipo de reporte</p>
              </div>
            `;
            return;
          }

          // Actualizar contador y t√≠tulo
          const totalElement = document.getElementById('total-registros');
          if (totalElement) {
            totalElement.textContent = data.length;
          }

          // Generar tabla din√°mica
          const tabla = document.createElement("table");
          tabla.className = "table table-hover";
          tabla.innerHTML = `
            <thead class="table-primary">
              <tr>
                ${columns.map(col => `<th><i class="bi bi-${col.icon} me-1"></i>${col.label}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
              ${data.map(row => `
                <tr>
                  ${columns.map(col => {
                    let value = row[col.key];
                    if (col.format === 'date' && value) {
                      value = new Date(value).toLocaleDateString('es-ES');
                    } else if (col.format === 'badge' && value) {
                      value = `<span class="badge bg-info">${value}</span>`;
                    } else if (col.format === 'truncate' && value) {
                      value = `<span class="text-truncate" style="max-width: 200px;" title="${value}">${value}</span>`;
                    } else if (!value) {
                      value = '-';
                    }
                    return `<td>${value}</td>`;
                  }).join('')}
                </tr>
              `).join('')}
            </tbody>
          `;
          
          contenedor.innerHTML = "";
          contenedor.appendChild(tabla);

        } catch (err) {
          console.error('Error generando reporte:', err);
          contenedor.innerHTML = `
            <div class="alert alert-danger" role="alert">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <strong>Error:</strong> ${err.message}
            </div>
          `;
        }
      }

      // Hacer funciones globales disponibles
      window.cargarFincasReporte = cargarFincasReporte;
      window.cargarCuartelesReporte = cargarCuartelesReporte;
      window.cargarRegadoresReporte = cargarRegadoresReporte;
      window.generarReportePorTipo = generarReportePorTipo;
    </script>
  </body>
</html>
