<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reportes | Cuaderno de Campo</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Select -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Google Fonts Roboto -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="estilos.css">
  </head>
  
  <body class="bg-light">
    <div id="header-container"></div>

    <div class="container-fluid py-4">
      <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
          <div class="card shadow-sm">
            <div class="card-body">
              <h1 class="h3 mb-4 text-primary">
                <i class="bi bi-bar-chart-line me-2"></i>Reportes
              </h1>

              <!-- Formulario de filtros -->
              <form id="reportes-filtros" class="mb-4">
                <!-- Selecci√≥n de tipo de reporte -->
                <div class="row mb-4">
                  <div class="col-md-6">
                    <label for="tipo-reporte" class="form-label font-weight-medium">
                      <i class="bi bi-list me-1"></i> Tipo de Reporte
                    </label>
                    <select id="tipo-reporte" class="form-select">
                      <option value="riegos">Riegos realizados</option>
                      <option value="riegos-regador">Riegos por regador</option>
                      <option value="agroquimicos">Aplicaciones agroqu√≠micos</option>
                      <option value="fertilizaciones">Fertilizaciones</option>
                      <option value="labores">Labores culturales</option>
                      <option value="bpa">Registros BPA</option>
                    </select>
                  </div>
                </div>

                <!-- Filtros generales -->
                <div id="filtros-riegos" style="display:none;">
                  <div class="row mb-4">
                    <div class="col-md-6">
                      <label for="finca-reporte" class="form-label font-weight-medium">
                        <i class="bi bi-geo-alt me-1"></i> Fincas
                      </label>
                      <select id="finca-reporte" class="form-select selectpicker" multiple 
                              title="Seleccione fincas..." data-live-search="true">
                      </select>
                      <div class="form-text">Filtra por fincas seleccionadas</div>
                    </div>
                    <div class="col-md-6">
                      <label for="cuartel-reporte" class="form-label font-weight-medium">
                        <i class="bi bi-grid me-1"></i> Cuarteles
                      </label>
                      <select id="cuartel-reporte" class="form-select selectpicker" multiple 
                              title="Seleccione cuarteles..." data-live-search="true">
                      </select>
                      <div class="form-text">Filtra por cuarteles seleccionados</div>
                    </div>
                  </div>

                  <div class="row mb-4">
                    <div class="col-md-6">
                      <label for="fecha-desde" class="form-label font-weight-medium">
                        <i class="bi bi-calendar-event me-1"></i> Fecha Desde
                      </label>
                      <input type="date" id="fecha-desde" class="form-control" value="2000-01-01" />
                    </div>
                    <div class="col-md-6">
                      <label for="fecha-hasta" class="form-label font-weight-medium">
                        <i class="bi bi-calendar-check me-1"></i> Fecha Hasta
                      </label>
                      <input type="date" id="fecha-hasta" class="form-control" />
                    </div>
                  </div>
                </div>

                <!-- Bot√≥n de generar reporte -->
                <div class="text-center">
                  <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-play-circle me-2"></i>Generar Reporte
                  </button>
                </div>
              </form>

              <!-- Resultados -->
              <div id="reportes-resultado"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
    <script src="header.js"></script>

    <script type="module">
      import { supabase } from "./supabaseClient.js";
      
      // Verificar autenticaci√≥n
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = 'login.html';
      }

      // Cargar header
      fetch('header.html')
        .then(response => response.text())
        .then(data => {
          document.getElementById('header-container').innerHTML = data;
        });

      // Variables globales
      let todasLasFincas = [];
      let cargandoCuarteles = false;

      // Inicializaci√≥n
      $(document).ready(function() {
        // Configurar fechas por defecto
        const hoy = new Date().toISOString().split('T')[0];
        document.getElementById('fecha-hasta').value = hoy;

        // Configurar evento para cambio de tipo de reporte
        $('#tipo-reporte').on('change', function() {
          const tipoSeleccionado = $(this).val();
          mostrarFiltrosSegunTipo(tipoSeleccionado);
        });

        // Mostrar filtros iniciales para riegos
        mostrarFiltrosSegunTipo('riegos');

        // Configurar formulario
        document.getElementById('reportes-filtros').addEventListener('submit', async (e) => {
          e.preventDefault();
          await generarReporte();
        });
      });

      // Funci√≥n para cargar fincas (basada en riego.html)
      async function cargarFincasReporte() {
        try {
          console.log('=== CARGA DE FINCAS ===');
          
          const fincaSelect = document.getElementById('finca-reporte');
          if (!fincaSelect) {
            console.error('‚ùå Elemento #finca-reporte no encontrado');
            return;
          }

          // Mostrar mensaje de carga
          fincaSelect.innerHTML = '<option disabled>Cargando fincas...</option>';
          $(fincaSelect).selectpicker('refresh');
          
          // Eliminar event listeners previos
          $(fincaSelect).off('changed.bs.select');
          
          const { data: fincas, error } = await supabase
            .from('fincas')
            .select('id, nombre_finca')
            .eq('usuario_id', user.id)
            .order('nombre_finca');
          
          if (error) throw error;
          
          todasLasFincas = fincas || [];
          console.log('üè† Fincas recibidas:', todasLasFincas.length);
          
          // Limpiar y llenar el selector
          fincaSelect.innerHTML = '';
          todasLasFincas.forEach(finca => {
            const option = document.createElement("option");
            option.value = finca.id;
            option.textContent = finca.nombre_finca;
            fincaSelect.appendChild(option);
          });
          
          // Refrescar Bootstrap Select
          $(fincaSelect).selectpicker('refresh');
          
          // Forzar recreaci√≥n con setTimeout
          setTimeout(() => {
            $(fincaSelect).selectpicker('destroy').selectpicker({
              style: 'btn-outline-secondary',
              size: 6,
              liveSearch: true,
              actionsBox: true,
              selectAllText: 'Todas las fincas',
              deselectAllText: 'Ninguna finca',
              noneSelectedText: 'Seleccione fincas...',
              countSelectedText: function(numSelected, numTotal) {
                return numSelected + ' fincas seleccionadas';
              }
            });
            
            // Reagregar event listener
            $(fincaSelect).on('changed.bs.select', function() {
              console.log('üéØ Evento changed.bs.select disparado en fincas');
              cargarCuartelesReporte();
            });
          }, 100);

          console.log('‚úÖ Fincas cargadas correctamente');
          
        } catch (error) {
          console.error('‚ùå Error cargando fincas:', error);
        }
      }

      // Funci√≥n para cargar cuarteles (basada en riego.html)
      async function cargarCuartelesReporte() {
        if (cargandoCuarteles) return;
        cargandoCuarteles = true;
        
        try {
          console.log('=== CARGA DE CUARTELES ===');
          
          const cuartelSelect = document.getElementById('cuartel-reporte');
          if (!cuartelSelect) {
            console.error('‚ùå Elemento #cuartel-reporte no encontrado');
            cargandoCuarteles = false;
            return;
          }

          const fincasSeleccionadas = $('#finca-reporte').val() || [];
          console.log('üîÑ Cargando cuarteles para fincas:', fincasSeleccionadas);
          
          // Eliminar event listeners previos
          $(cuartelSelect).off('changed.bs.select');
          
          if (fincasSeleccionadas.length === 0) {
            // Destruir completamente cuando no hay fincas
            $(cuartelSelect).selectpicker('destroy');
            cuartelSelect.innerHTML = '';
            cuartelSelect.disabled = true;
            $(cuartelSelect).selectpicker();
            cargandoCuarteles = false;
            return;
          }
          
          // Destruir y recrear el selector
          $(cuartelSelect).selectpicker('destroy');
          cuartelSelect.innerHTML = '<option disabled selected>Cargando cuarteles...</option>';
          cuartelSelect.disabled = false;
          $(cuartelSelect).selectpicker({
            style: 'btn-outline-secondary',
            size: 8,
            liveSearch: true,
            actionsBox: true,
            selectAllText: 'Todos los cuarteles',
            deselectAllText: 'Ning√∫n cuartel',
            noneSelectedText: 'Seleccione cuarteles...',
            countSelectedText: function(numSelected, numTotal) {
              return numSelected + ' cuarteles seleccionados';
            }
          });

          const { data: cuarteles, error } = await supabase
            .from('cuarteles')
            .select('id, nombre, finca_id, fincas(nombre_finca)')
            .in('finca_id', fincasSeleccionadas)
            .order('nombre');
          
          if (error) {
            console.error('Error al cargar cuarteles:', error);
            cuartelSelect.innerHTML = '<option disabled>Error al cargar</option>';
            $(cuartelSelect).selectpicker('refresh');
            cargandoCuarteles = false;
            return;
          }
          
          console.log('üì¶ Cuarteles recibidos:', cuarteles.length);
          
          // Limpiar completamente
          cuartelSelect.innerHTML = '';
          
          if (cuarteles.length === 0) {
            cuartelSelect.innerHTML = '<option disabled selected>No hay cuarteles disponibles</option>';
          } else {
            // Usar Map para unicidad
            const cuartelesUnicos = new Map();
            cuarteles.forEach(cuartel => {
              if (!cuartelesUnicos.has(cuartel.id)) {
                cuartelesUnicos.set(cuartel.id, cuartel);
              }
            });
            
            // Agregar opciones
            Array.from(cuartelesUnicos.values()).forEach(cuartel => {
              const option = document.createElement("option");
              option.value = cuartel.id;
              option.textContent = `${cuartel.nombre} (${cuartel.fincas.nombre_finca})`;
              option.dataset.fincaId = cuartel.finca_id;
              cuartelSelect.appendChild(option);
            });
          }
          
          $(cuartelSelect).selectpicker('refresh');
          console.log('‚úÖ Cuarteles cargados correctamente');
          
        } catch (error) {
          console.error('‚ùå Error cargando cuarteles:', error);
        } finally {
          cargandoCuarteles = false;
        }
      }

      // Mostrar filtros seg√∫n tipo de reporte
      function mostrarFiltrosSegunTipo(tipo) {
        console.log('Mostrando filtros para:', tipo);
        
        // Ocultar todos los filtros
        document.getElementById('filtros-riegos').style.display = 'none';

        // Mostrar filtros correspondientes
        if (['riegos', 'agroquimicos', 'fertilizaciones', 'labores', 'bpa', 'riegos-regador'].includes(tipo)) {
          document.getElementById('filtros-riegos').style.display = 'block';
          
          // Cargar fincas si no est√°n cargadas
          if (todasLasFincas.length === 0) {
            cargarFincasReporte();
          }
        }
      }

      // Funci√≥n para mostrar mensajes
      function mostrarMensaje(mensaje, tipo = 'info') {
        const alertClass = {
          'success': 'alert-success',
          'error': 'alert-danger',
          'warning': 'alert-warning',
          'info': 'alert-info'
        };
        
        const iconClass = {
          'success': 'bi-check-circle',
          'error': 'bi-exclamation-triangle',
          'warning': 'bi-exclamation-triangle',
          'info': 'bi-info-circle'
        };
        
        const resultadoDiv = document.getElementById('reportes-resultado');
        const mensajeHtml = `
          <div class="alert ${alertClass[tipo]} alert-dismissible fade show" role="alert">
            <i class="bi ${iconClass[tipo]} me-2"></i>
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        `;
        
        resultadoDiv.insertAdjacentHTML('afterbegin', mensajeHtml);
        
        // Auto-ocultar
        if (tipo === 'success' || tipo === 'info') {
          setTimeout(() => {
            const alert = resultadoDiv.querySelector('.alert');
            if (alert) alert.remove();
          }, 5000);
        }
      }

      // Funci√≥n principal para generar reportes
      async function generarReporte() {
        try {
          const tipoReporte = document.getElementById('tipo-reporte').value;
          const fechaDesde = document.getElementById('fecha-desde').value;
          const fechaHasta = document.getElementById('fecha-hasta').value;
          const fincasSeleccionadas = $('#finca-reporte').val() || [];
          const cuartelesSeleccionados = $('#cuartel-reporte').val() || [];
          
          if (!fechaDesde || !fechaHasta) {
            mostrarMensaje('Por favor seleccione el rango de fechas', 'warning');
            return;
          }
          
          mostrarMensaje('Generando reporte...', 'info');
          
          let datos = [];
          
          switch (tipoReporte) {
            case 'riegos':
              datos = await obtenerDatosRiegos(fechaDesde, fechaHasta, fincasSeleccionadas, cuartelesSeleccionados);
              break;
            case 'riegos-regador':
              datos = await obtenerDatosRiegosPorRegador(fechaDesde, fechaHasta, fincasSeleccionadas, cuartelesSeleccionados);
              break;
            case 'agroquimicos':
              datos = await obtenerDatosAgroquimicos(fechaDesde, fechaHasta, fincasSeleccionadas, cuartelesSeleccionados);
              break;
            case 'fertilizaciones':
              datos = await obtenerDatosFertilizaciones(fechaDesde, fechaHasta, fincasSeleccionadas, cuartelesSeleccionados);
              break;
            case 'labores':
              datos = await obtenerDatosLabores(fechaDesde, fechaHasta, fincasSeleccionadas, cuartelesSeleccionados);
              break;
            case 'bpa':
              datos = await obtenerDatosBPA(fechaDesde, fechaHasta, fincasSeleccionadas, cuartelesSeleccionados);
              break;
            default:
              mostrarMensaje('Tipo de reporte no v√°lido', 'error');
              return;
          }
          
          if (datos.length === 0) {
            mostrarMensaje('No se encontraron datos para los criterios seleccionados', 'warning');
            mostrarResultadosVacios();
            return;
          }
          
          mostrarResultados(datos, tipoReporte);
          mostrarMensaje(`Reporte generado: ${datos.length} registros encontrados`, 'success');
          
        } catch (error) {
          console.error('Error generando reporte:', error);
          mostrarMensaje('Error al generar el reporte: ' + error.message, 'error');
        }
      }

      // Obtener datos de riegos
      async function obtenerDatosRiegos(fechaDesde, fechaHasta, fincas, cuarteles) {
        let query = supabase
          .from('riegos')
          .select(`
            id, fecha, horas_riego, volumen_agua, observaciones, maquinaria, operador_id,
            fincas!finca_id(id, nombre_finca),
            cuarteles!cuartel_id(id, nombre),
            aplicadores_operarios!operador_id(nombre)
          `)
          .gte('fecha', fechaDesde)
          .lte('fecha', fechaHasta)
          .order('fecha', { ascending: false });
        
        if (fincas.length > 0) {
          query = query.in('finca_id', fincas);
        }
        
        if (cuarteles.length > 0) {
          query = query.in('cuartel_id', cuarteles);
        }
        
        const { data, error } = await query;
        if (error) throw error;
        
        return data || [];
      }

      // Obtener datos de riegos por regador
      async function obtenerDatosRiegosPorRegador(fechaDesde, fechaHasta, fincas, cuarteles) {
        const datos = await obtenerDatosRiegos(fechaDesde, fechaHasta, fincas, cuarteles);
        
        // Agrupar por regador
        const agrupados = {};
        datos.forEach(riego => {
          const regador = riego.aplicadores_operarios?.nombre || 'Sin regador';
          if (!agrupados[regador]) {
            agrupados[regador] = {
              regador: regador,
              total_riegos: 0,
              total_horas: 0,
              total_volumen: 0,
              fincas: new Set(),
              cuarteles: new Set()
            };
          }
          
          agrupados[regador].total_riegos++;
          agrupados[regador].total_horas += parseFloat(riego.horas_riego || 0);
          agrupados[regador].total_volumen += parseFloat(riego.volumen_agua || 0);
          agrupados[regador].fincas.add(riego.fincas?.nombre_finca || 'N/A');
          agrupados[regador].cuarteles.add(riego.cuarteles?.nombre || 'N/A');
        });
        
        // Convertir sets a arrays
        return Object.values(agrupados).map(item => ({
          ...item,
          fincas: Array.from(item.fincas).join(', '),
          cuarteles: Array.from(item.cuarteles).join(', '),
          total_horas: parseFloat(item.total_horas).toFixed(2),
          total_volumen: parseFloat(item.total_volumen).toFixed(2)
        }));
      }

      // Obtener datos de agroqu√≠micos
      async function obtenerDatosAgroquimicos(fechaDesde, fechaHasta, fincas, cuarteles) {
        let query = supabase
          .from('aplicaciones_agroquimicos')
          .select(`
            id, fecha, producto, dosis, volumen_agua, observaciones,
            fincas!finca_id(nombre_finca),
            cuarteles!cuartel_id(nombre),
            aplicadores_operarios!operador_id(nombre)
          `)
          .gte('fecha', fechaDesde)
          .lte('fecha', fechaHasta)
          .order('fecha', { ascending: false });
        
        if (fincas.length > 0) {
          query = query.in('finca_id', fincas);
        }
        
        if (cuarteles.length > 0) {
          query = query.in('cuartel_id', cuarteles);
        }
        
        const { data, error } = await query;
        if (error) throw error;
        
        return data || [];
      }

      // Obtener datos de fertilizaciones
      async function obtenerDatosFertilizaciones(fechaDesde, fechaHasta, fincas, cuarteles) {
        let query = supabase
          .from('aplicaciones_fertilizantes')
          .select(`
            id, fecha, producto, dosis, observaciones,
            fincas!finca_id(nombre_finca),
            cuarteles!cuartel_id(nombre),
            aplicadores_operarios!operador_id(nombre)
          `)
          .gte('fecha', fechaDesde)
          .lte('fecha', fechaHasta)
          .order('fecha', { ascending: false });
        
        if (fincas.length > 0) {
          query = query.in('finca_id', fincas);
        }
        
        if (cuarteles.length > 0) {
          query = query.in('cuartel_id', cuarteles);
        }
        
        const { data, error } = await query;
        if (error) throw error;
        
        return data || [];
      }

      // Obtener datos de labores culturales
      async function obtenerDatosLabores(fechaDesde, fechaHasta, fincas, cuarteles) {
        let query = supabase
          .from('labores_culturales')
          .select(`
            id, fecha, labor, observaciones, maquinaria,
            fincas!finca_id(nombre_finca),
            cuarteles!cuartel_id(nombre),
            aplicadores_operarios!operador_id(nombre)
          `)
          .gte('fecha', fechaDesde)
          .lte('fecha', fechaHasta)
          .order('fecha', { ascending: false });
        
        if (fincas.length > 0) {
          query = query.in('finca_id', fincas);
        }
        
        if (cuarteles.length > 0) {
          query = query.in('cuartel_id', cuarteles);
        }
        
        const { data, error } = await query;
        if (error) throw error;
        
        return data || [];
      }

      // Obtener datos de BPA
      async function obtenerDatosBPA(fechaDesde, fechaHasta, fincas, cuarteles) {
        const [riegos, agroquimicos, fertilizaciones, labores] = await Promise.all([
          obtenerDatosRiegos(fechaDesde, fechaHasta, fincas, cuarteles),
          obtenerDatosAgroquimicos(fechaDesde, fechaHasta, fincas, cuarteles),
          obtenerDatosFertilizaciones(fechaDesde, fechaHasta, fincas, cuarteles),
          obtenerDatosLabores(fechaDesde, fechaHasta, fincas, cuarteles)
        ]);
        
        const todosBPA = [
          ...riegos.map(r => ({ ...r, tipo_actividad: 'Riego', actividad: 'Riego' })),
          ...agroquimicos.map(a => ({ ...a, tipo_actividad: 'Agroqu√≠mico', actividad: a.producto })),
          ...fertilizaciones.map(f => ({ ...f, tipo_actividad: 'Fertilizaci√≥n', actividad: f.producto })),
          ...labores.map(l => ({ ...l, tipo_actividad: 'Labor Cultural', actividad: l.labor }))
        ];
        
        return todosBPA.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
      }

      // Mostrar resultados vac√≠os
      function mostrarResultadosVacios() {
        const resultadoDiv = document.getElementById('reportes-resultado');
        resultadoDiv.innerHTML = `
          <div class="text-center py-5">
            <i class="bi bi-inbox display-1 text-muted"></i>
            <h4 class="text-muted mt-3">No se encontraron registros</h4>
            <p class="text-muted">Intente ajustar los filtros de b√∫squeda</p>
          </div>
        `;
      }

      // Mostrar resultados
      function mostrarResultados(datos, tipoReporte) {
        const resultadoDiv = document.getElementById('reportes-resultado');
        
        let html = `
          <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="bi bi-table me-2"></i>
                Resultados del Reporte
                <span class="badge bg-primary ms-2">${datos.length} registros</span>
              </h5>
              <div class="btn-group">
                <button class="btn btn-success btn-sm" onclick="exportarExcel()">
                  <i class="bi bi-file-earmark-excel me-1"></i> Excel
                </button>
                <button class="btn btn-info btn-sm" onclick="exportarCSV()">
                  <i class="bi bi-file-earmark-text me-1"></i> CSV
                </button>
                <button class="btn btn-secondary btn-sm" onclick="imprimirReporte()">
                  <i class="bi bi-printer me-1"></i> Imprimir
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                ${generarTablaReporte(datos, tipoReporte)}
              </div>
            </div>
          </div>
        `;
        
        resultadoDiv.innerHTML = html;
        
        // Guardar datos para exportaci√≥n
        window.datosReporteActual = datos;
        window.tipoReporteActual = tipoReporte;
      }

      // Generar tabla seg√∫n tipo de reporte
      function generarTablaReporte(datos, tipoReporte) {
        switch (tipoReporte) {
          case 'riegos':
            return generarTablaRiegos(datos);
          case 'riegos-regador':
            return generarTablaRiegosPorRegador(datos);
          case 'agroquimicos':
            return generarTablaAgroquimicos(datos);
          case 'fertilizaciones':
            return generarTablaFertilizaciones(datos);
          case 'labores':
            return generarTablaLabores(datos);
          case 'bpa':
            return generarTablaBPA(datos);
          default:
            return '<p>Tipo de reporte no reconocido</p>';
        }
      }

      // Generar tabla de riegos
      function generarTablaRiegos(datos) {
        const encabezados = ['Fecha', 'Finca', 'Cuartel', 'Regador', 'Horas', 'Volumen (m¬≥)', 'Maquinaria', 'Observaciones'];
        
        let html = `
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>${encabezados.map(h => `<th>${h}</th>`).join('')}</tr>
            </thead>
            <tbody>
        `;
        
        datos.forEach(riego => {
          const fecha = new Date(riego.fecha).toLocaleDateString('es-ES');
          const horas = parseFloat(riego.horas_riego || 0).toFixed(1);
          const volumen = parseFloat(riego.volumen_agua || 0).toFixed(1);
          
          html += `
            <tr>
              <td>${fecha}</td>
              <td>${riego.fincas?.nombre_finca || 'N/A'}</td>
              <td>${riego.cuarteles?.nombre || 'N/A'}</td>
              <td>${riego.aplicadores_operarios?.nombre || 'N/A'}</td>
              <td>${horas}h</td>
              <td>${volumen}</td>
              <td>${riego.maquinaria || '-'}</td>
              <td>${riego.observaciones || '-'}</td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        return html;
      }

      // Generar tabla de riegos por regador
      function generarTablaRiegosPorRegador(datos) {
        const encabezados = ['Regador', 'Total Riegos', 'Total Horas', 'Total Volumen (m¬≥)', 'Fincas', 'Cuarteles'];
        
        let html = `
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>${encabezados.map(h => `<th>${h}</th>`).join('')}</tr>
            </thead>
            <tbody>
        `;
        
        datos.forEach(item => {
          html += `
            <tr>
              <td><strong>${item.regador}</strong></td>
              <td>${item.total_riegos}</td>
              <td>${item.total_horas}h</td>
              <td>${item.total_volumen}</td>
              <td><small>${item.fincas}</small></td>
              <td><small>${item.cuarteles}</small></td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        return html;
      }

      // Generar tabla de agroqu√≠micos
      function generarTablaAgroquimicos(datos) {
        const encabezados = ['Fecha', 'Finca', 'Cuartel', 'Producto', 'Dosis', 'Volumen Agua', 'Operador', 'Observaciones'];
        
        let html = `
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>${encabezados.map(h => `<th>${h}</th>`).join('')}</tr>
            </thead>
            <tbody>
        `;
        
        datos.forEach(aplicacion => {
          const fecha = new Date(aplicacion.fecha).toLocaleDateString('es-ES');
          
          html += `
            <tr>
              <td>${fecha}</td>
              <td>${aplicacion.fincas?.nombre_finca || 'N/A'}</td>
              <td>${aplicacion.cuarteles?.nombre || 'N/A'}</td>
              <td>${aplicacion.producto || 'N/A'}</td>
              <td>${aplicacion.dosis || '-'}</td>
              <td>${aplicacion.volumen_agua || '-'}</td>
              <td>${aplicacion.aplicadores_operarios?.nombre || 'N/A'}</td>
              <td>${aplicacion.observaciones || '-'}</td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        return html;
      }

      // Generar tabla de fertilizaciones
      function generarTablaFertilizaciones(datos) {
        const encabezados = ['Fecha', 'Finca', 'Cuartel', 'Producto', 'Dosis', 'Operador', 'Observaciones'];
        
        let html = `
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>${encabezados.map(h => `<th>${h}</th>`).join('')}</tr>
            </thead>
            <tbody>
        `;
        
        datos.forEach(aplicacion => {
          const fecha = new Date(aplicacion.fecha).toLocaleDateString('es-ES');
          
          html += `
            <tr>
              <td>${fecha}</td>
              <td>${aplicacion.fincas?.nombre_finca || 'N/A'}</td>
              <td>${aplicacion.cuarteles?.nombre || 'N/A'}</td>
              <td>${aplicacion.producto || 'N/A'}</td>
              <td>${aplicacion.dosis || '-'}</td>
              <td>${aplicacion.aplicadores_operarios?.nombre || 'N/A'}</td>
              <td>${aplicacion.observaciones || '-'}</td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        return html;
      }

      // Generar tabla de labores culturales
      function generarTablaLabores(datos) {
        const encabezados = ['Fecha', 'Finca', 'Cuartel', 'Labor', 'Maquinaria', 'Operador', 'Observaciones'];
        
        let html = `
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>${encabezados.map(h => `<th>${h}</th>`).join('')}</tr>
            </thead>
            <tbody>
        `;
        
        datos.forEach(labor => {
          const fecha = new Date(labor.fecha).toLocaleDateString('es-ES');
          
          html += `
            <tr>
              <td>${fecha}</td>
              <td>${labor.fincas?.nombre_finca || 'N/A'}</td>
              <td>${labor.cuarteles?.nombre || 'N/A'}</td>
              <td>${labor.labor || 'N/A'}</td>
              <td>${labor.maquinaria || '-'}</td>
              <td>${labor.aplicadores_operarios?.nombre || 'N/A'}</td>
              <td>${labor.observaciones || '-'}</td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        return html;
      }

      // Generar tabla de BPA
      function generarTablaBPA(datos) {
        const encabezados = ['Fecha', 'Tipo', 'Actividad', 'Finca', 'Cuartel', 'Operador', 'Observaciones'];
        
        let html = `
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>${encabezados.map(h => `<th>${h}</th>`).join('')}</tr>
            </thead>
            <tbody>
        `;
        
        datos.forEach(registro => {
          const fecha = new Date(registro.fecha).toLocaleDateString('es-ES');
          
          html += `
            <tr>
              <td>${fecha}</td>
              <td><span class="badge bg-secondary">${registro.tipo_actividad}</span></td>
              <td>${registro.actividad || 'N/A'}</td>
              <td>${registro.fincas?.nombre_finca || 'N/A'}</td>
              <td>${registro.cuarteles?.nombre || 'N/A'}</td>
              <td>${registro.aplicadores_operarios?.nombre || 'N/A'}</td>
              <td>${registro.observaciones || '-'}</td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        return html;
      }

      // FUNCIONES DE EXPORTACI√ìN
      window.exportarExcel = function() {
        if (!window.datosReporteActual) {
          mostrarMensaje('No hay datos para exportar', 'warning');
          return;
        }
        
        try {
          const datosParaExportar = prepararDatosParaExportacion(window.datosReporteActual, window.tipoReporteActual);
          const csv = convertirACSV(datosParaExportar);
          const blob = new Blob([csv], { type: 'application/vnd.ms-excel' });
          const url = window.URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = url;
          a.download = `reporte_${window.tipoReporteActual}_${new Date().toISOString().slice(0,10)}.xls`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          
          mostrarMensaje('Archivo Excel descargado correctamente', 'success');
        } catch (error) {
          console.error('Error exportando Excel:', error);
          mostrarMensaje('Error al exportar Excel: ' + error.message, 'error');
        }
      };

      window.exportarCSV = function() {
        if (!window.datosReporteActual) {
          mostrarMensaje('No hay datos para exportar', 'warning');
          return;
        }
        
        try {
          const datosParaExportar = prepararDatosParaExportacion(window.datosReporteActual, window.tipoReporteActual);
          const csv = convertirACSV(datosParaExportar);
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = window.URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = url;
          a.download = `reporte_${window.tipoReporteActual}_${new Date().toISOString().slice(0,10)}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          
          mostrarMensaje('Archivo CSV descargado correctamente', 'success');
        } catch (error) {
          console.error('Error exportando CSV:', error);
          mostrarMensaje('Error al exportar CSV: ' + error.message, 'error');
        }
      };

      window.imprimirReporte = function() {
        if (!window.datosReporteActual) {
          mostrarMensaje('No hay datos para imprimir', 'warning');
          return;
        }
        
        const contenido = document.getElementById('reportes-resultado').innerHTML;
        const ventanaImpresion = window.open('', '_blank');
        
        ventanaImpresion.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <title>Reporte - Cuaderno de Campo</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
              @media print {
                .btn { display: none !important; }
                .card { border: none !important; box-shadow: none !important; }
                body { font-size: 12px; }
                table { font-size: 11px; }
              }
            </style>
          </head>
          <body>
            <div class="container-fluid">
              <h2 class="text-center mb-4">Reporte - Cuaderno de Campo</h2>
              <p class="text-center text-muted">Generado el ${new Date().toLocaleString('es-ES')}</p>
              ${contenido}
            </div>
          </body>
          </html>
        `);
        
        ventanaImpresion.document.close();
        setTimeout(() => {
          ventanaImpresion.print();
        }, 500);
      };

      // Preparar datos para exportaci√≥n
      function prepararDatosParaExportacion(datos, tipoReporte) {
        switch (tipoReporte) {
          case 'riegos':
            return datos.map(r => ({
              'Fecha': new Date(r.fecha).toLocaleDateString('es-ES'),
              'Finca': r.fincas?.nombre_finca || 'N/A',
              'Cuartel': r.cuarteles?.nombre || 'N/A',
              'Regador': r.aplicadores_operarios?.nombre || 'N/A',
              'Horas': parseFloat(r.horas_riego || 0).toFixed(1),
              'Volumen (m¬≥)': parseFloat(r.volumen_agua || 0).toFixed(1),
              'Maquinaria': r.maquinaria || '-',
              'Observaciones': r.observaciones || '-'
            }));
          
          case 'riegos-regador':
            return datos.map(r => ({
              'Regador': r.regador,
              'Total Riegos': r.total_riegos,
              'Total Horas': r.total_horas,
              'Total Volumen (m¬≥)': r.total_volumen,
              'Fincas': r.fincas,
              'Cuarteles': r.cuarteles
            }));
          
          case 'agroquimicos':
            return datos.map(a => ({
              'Fecha': new Date(a.fecha).toLocaleDateString('es-ES'),
              'Finca': a.fincas?.nombre_finca || 'N/A',
              'Cuartel': a.cuarteles?.nombre || 'N/A',
              'Producto': a.producto || 'N/A',
              'Dosis': a.dosis || '-',
              'Volumen Agua': a.volumen_agua || '-',
              'Operador': a.aplicadores_operarios?.nombre || 'N/A',
              'Observaciones': a.observaciones || '-'
            }));
          
          case 'fertilizaciones':
            return datos.map(f => ({
              'Fecha': new Date(f.fecha).toLocaleDateString('es-ES'),
              'Finca': f.fincas?.nombre_finca || 'N/A',
              'Cuartel': f.cuarteles?.nombre || 'N/A',
              'Producto': f.producto || 'N/A',
              'Dosis': f.dosis || '-',
              'Operador': f.aplicadores_operarios?.nombre || 'N/A',
              'Observaciones': f.observaciones || '-'
            }));
          
          case 'labores':
            return datos.map(l => ({
              'Fecha': new Date(l.fecha).toLocaleDateString('es-ES'),
              'Finca': l.fincas?.nombre_finca || 'N/A',
              'Cuartel': l.cuarteles?.nombre || 'N/A',
              'Labor': l.labor || 'N/A',
              'Maquinaria': l.maquinaria || '-',
              'Operador': l.aplicadores_operarios?.nombre || 'N/A',
              'Observaciones': l.observaciones || '-'
            }));
          
          case 'bpa':
            return datos.map(b => ({
              'Fecha': new Date(b.fecha).toLocaleDateString('es-ES'),
              'Tipo': b.tipo_actividad,
              'Actividad': b.actividad || 'N/A',
              'Finca': b.fincas?.nombre_finca || 'N/A',
              'Cuartel': b.cuarteles?.nombre || 'N/A',
              'Operador': b.aplicadores_operarios?.nombre || 'N/A',
              'Observaciones': b.observaciones || '-'
            }));
          
          default:
            return datos;
        }
      }

      // Convertir a CSV
      function convertirACSV(datos) {
        if (datos.length === 0) return '';
        
        const encabezados = Object.keys(datos[0]);
        const filaEncabezados = encabezados.map(h => `"${h}"`).join(',');
        
        const filasDatos = datos.map(fila => 
          encabezados.map(encabezado => 
            `"${String(fila[encabezado] || '').replace(/"/g, '""')}"`
          ).join(',')
        );
        
        return [filaEncabezados, ...filasDatos].join('\n');
      }

      // Funci√≥n de soluci√≥n para debugging
      window.solucionarDropdownFincas = async function() {
        console.log('=== EJECUTANDO SOLUCI√ìN COMPLETA ===');
        
        try {
          const contenedor = document.getElementById('filtros-riegos');
          if (contenedor) {
            contenedor.style.display = 'block';
          }
          
          await cargarFincasReporte();
          
          console.log('‚úÖ Soluci√≥n aplicada correctamente');
          return true;
          
        } catch (error) {
          console.error('‚ùå Error en soluci√≥n:', error);
          return false;
        }
      };

      console.log('‚úÖ M√≥dulo de reportes cargado correctamente');
      console.log('üìã Funciones disponibles: exportarExcel(), exportarCSV(), imprimirReporte()');
      console.log('üîß Debug: window.solucionarDropdownFincas()');

    </script>
  </body>
</html>
