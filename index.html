<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inicio | Cuaderno de Campo</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- jQuery (necesario para dropdowns) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- Custom CSS -->
  <link rel="stylesheet" href="estilos.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
  
  <!-- CSS para ocultar contenido hasta verificar autenticaci√≥n -->
  <style>
    body {
      visibility: hidden;
    }
    body.authenticated {
      visibility: visible;
    }
    .loading-auth {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      visibility: visible;
    }
  </style>
</head>
<body>
  <!-- Indicador de carga mientras se verifica autenticaci√≥n -->
  <div class="loading-auth">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Verificando acceso...</span>
    </div>
    <p class="mt-2 text-muted">Verificando autenticaci√≥n...</p>
  </div>
  
  <div id="header-container"></div>
  
  <main class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h4>Bienvenido</h4>
    </div>
    <div class="dashboard-cards row" id="dashboard-cards">
      <!-- Tarjetas din√°micas -->
    </div>
    <footer class="container mt-5">
      <small><a href="#">Privacidad</a> ‚Ä¢ <a href="#">T√©rminos</a></small>
    </footer>
  </main>
  
  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Script principal del dashboard -->
  <script type="module">
    import { supabase } from "./supabaseClient.js";
    
    // Verificaci√≥n inmediata de autenticaci√≥n antes de cargar el dashboard
    async function verificacionPrevia() {
      try {
        const { data: { user }, error } = await supabase.auth.getUser();
        if (error || !user) {
          console.log('üîí Acceso no autorizado, redirigiendo al login...');
          window.location.replace("login-nuevo.html");
          return false;
        }
        return true;
      } catch (error) {
        console.log('üîí Error verificando autenticaci√≥n, redirigiendo al login...');
        window.location.replace("login-nuevo.html");
        return false;
      }
    }
    
    // Variables globales
    let currentUser = null;
    let dashboardData = {
      fincas: 0,
      cuarteles: 0,
      tareas: 0,
      reportes: 0
    };

    // Verificar autenticaci√≥n y cargar dashboard
    async function inicializarDashboard() {
      // Verificaci√≥n previa de autenticaci√≥n
      const estaAutenticado = await verificacionPrevia();
      if (!estaAutenticado) {
        return; // Ya se hizo la redirecci√≥n en verificacionPrevia()
      }
      
      try {
        // Obtener usuario ya verificado
        const { data: { user } } = await supabase.auth.getUser();
        currentUser = user;
        console.log('‚úÖ Dashboard iniciando para usuario:', user.email);
        
        // Cargar header
        await cargarHeader();
        
        // Cargar datos del dashboard
        await cargarDatosDashboard();
        
        // Renderizar dashboard
        renderizarDashboard();
        
        // Mostrar contenido ahora que est√° todo cargado
        mostrarContenido();
        
      } catch (error) {
        console.error('‚ùå Error inicializando dashboard:', error);
        // En desarrollo local, mostrar dashboard demo
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.protocol === 'file:') {
          console.log('üé≠ Modo demo para desarrollo local');
          cargarDashboardDemo();
          mostrarContenido();
        } else {
          console.log('üîí Error del sistema, redirigiendo al login...');
          window.location.replace("login-nuevo.html");
        }
      }
    }

    function mostrarContenido() {
      // Ocultar el indicador de carga
      const loadingIndicator = document.querySelector('.loading-auth');
      if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
      }
      
      // Mostrar el contenido del dashboard
      document.body.classList.add('authenticated');
      console.log('‚úÖ Contenido del dashboard visible');
    }

    async function cargarHeader() {
      try {
        const response = await fetch('header.html');
        const html = await response.text();
        document.getElementById('header-container').innerHTML = html;
        await import('./header.js');
        console.log('‚úÖ Header cargado');
      } catch (error) {
        console.warn('‚ö†Ô∏è Error cargando header:', error);
      }
    }

    async function cargarDatosDashboard() {
      if (!supabase || !currentUser) {
        return;
      }

      try {
        console.log('üìä Cargando datos del dashboard...');
        
        // Cargar datos en paralelo para mejor rendimiento
        const [fincasResult, cuartelesResult, tareasResult] = await Promise.all([
          supabase.from("fincas").select("id", { count: 'exact' }).eq("usuario_id", currentUser.id),
          supabase.from("cuarteles").select(`
            id,
            fincas!inner(usuario_id)
          `, { count: 'exact' }).eq("fincas.usuario_id", currentUser.id),
          supabase.from("tareas").select("id", { count: 'exact' }).eq("usuario_id", currentUser.id)
        ]);

        // Procesar resultados
        dashboardData.fincas = fincasResult.count || 0;
        dashboardData.cuarteles = cuartelesResult.count || 0;
        dashboardData.tareas = tareasResult.count || 0;
        dashboardData.reportes = 0; // Los reportes se calculan din√°micamente
        
        console.log('‚úÖ Datos dashboard cargados:', dashboardData);
        
      } catch (error) {
        console.error('‚ùå Error cargando datos dashboard:', error);
      }
    }

    function cargarDashboardDemo() {
      dashboardData = {
        fincas: 3,
        cuarteles: 8,
        tareas: 12,
        reportes: 5
      };
      console.log('üé≠ Dashboard demo cargado:', dashboardData);
      renderizarDashboard();
    }

    function renderizarDashboard() {
      const dashboardContainer = document.getElementById("dashboard-cards");
      
      const isDemoMode = location.protocol === 'file:' || !currentUser;
      const demoBadge = isDemoMode ? '<small class="text-warning">(demo)</small>' : '';
      
      dashboardContainer.innerHTML = `
        <div class='col-md-3 mb-4'>
          <a href='fincas.html' style='text-decoration:none;' class="dashboard-card-link">
            <div class='mui-card text-center h-100 border-0 shadow-sm' style="border-radius: 16px; transition: all 0.3s ease;">
              <div class="card-body d-flex flex-column justify-content-center" style="padding: 2rem;">
                <i class='bi bi-geo-alt-fill' style='font-size:3rem;color:#28a745;margin-bottom:1rem;'></i>
                <h6 class="text-muted mb-2">Fincas ${demoBadge}</h6>
                <h2 class="font-weight-bold text-dark mb-0">${dashboardData.fincas}</h2>
              </div>
            </div>
          </a>
        </div>
        <div class='col-md-3 mb-4'>
          <a href='cuarteles.html' style='text-decoration:none;' class="dashboard-card-link">
            <div class='mui-card text-center h-100 border-0 shadow-sm' style="border-radius: 16px; transition: all 0.3s ease;">
              <div class="card-body d-flex flex-column justify-content-center" style="padding: 2rem;">
                <i class='bi bi-grid-3x3-gap-fill' style='font-size:3rem;color:#1976d2;margin-bottom:1rem;'></i>
                <h6 class="text-muted mb-2">Cuarteles ${demoBadge}</h6>
                <h2 class="font-weight-bold text-dark mb-0">${dashboardData.cuarteles}</h2>
              </div>
            </div>
          </a>
        </div>
        <div class='col-md-3 mb-4'>
          <a href='tareas.html' style='text-decoration:none;' class="dashboard-card-link">
            <div class='mui-card text-center h-100 border-0 shadow-sm' style="border-radius: 16px; transition: all 0.3s ease;">
              <div class="card-body d-flex flex-column justify-content-center" style="padding: 2rem;">
                <i class='bi bi-journal-check' style='font-size:3rem;color:#43a047;margin-bottom:1rem;'></i>
                <h6 class="text-muted mb-2">Tareas ${demoBadge}</h6>
                <h2 class="font-weight-bold text-dark mb-0">${dashboardData.tareas}</h2>
              </div>
            </div>
          </a>
        </div>
        <div class='col-md-3 mb-4'>
          <a href='reportes.html' style='text-decoration:none;' class="dashboard-card-link">
            <div class='mui-card text-center h-100 border-0 shadow-sm' style="border-radius: 16px; transition: all 0.3s ease;">
              <div class="card-body d-flex flex-column justify-content-center" style="padding: 2rem;">
                <i class='bi bi-bar-chart-fill' style='font-size:3rem;color:#ffb300;margin-bottom:1rem;'></i>
                <h6 class="text-muted mb-2">Reportes ${demoBadge}</h6>
                <h2 class="font-weight-bold text-dark mb-0">${dashboardData.reportes}</h2>
              </div>
            </div>
          </a>
        </div>
      `;
      
      // Agregar efectos hover a las tarjetas
      const cardLinks = document.querySelectorAll('.dashboard-card-link');
      cardLinks.forEach(link => {
        const card = link.querySelector('.mui-card');
        link.addEventListener('mouseenter', () => {
          card.style.transform = 'translateY(-5px)';
          card.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
        });
        link.addEventListener('mouseleave', () => {
          card.style.transform = 'translateY(0)';
          card.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
        });
      });
      
      console.log('‚úÖ Dashboard renderizado');
    }

    // Inicializar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', inicializarDashboard);
    } else {
      inicializarDashboard();
    }
  </script>
  
  <!-- Scripts de jQuery para dropdowns -->
  <script>
    // Evita que el dropdown se cierre al hacer clic dentro del men√∫
    $(document).on('click', '.dropdown-menu', function (e) {
      e.stopPropagation();
    });
    
    // Mantener abierto el dropdown mientras el mouse est√© sobre el bot√≥n o el men√∫
    $(function() {
      var $dropdown = $('#nav-gestion');
      var $toggle = $('#gestionDropdown');
      var $menu = $('#gestion-dropdown-menu');

      $toggle.on('mouseenter', function() {
        $dropdown.addClass('show');
        $menu.addClass('show');
      });
      
      $dropdown.on('mouseleave', function() {
        $dropdown.removeClass('show');
        $menu.removeClass('show');
      });
    });
  </script>
</body>
</html>
