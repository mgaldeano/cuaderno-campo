<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cuarteles</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" />
    <style>
      .btn-small {
        font-size: 0.7em;
        padding: 0.1em 0.4em;
        margin: 0 0.1em;
        vertical-align: middle;
      }
      .cuartel-item {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 0.5em;
        flex-wrap: wrap;
        border-bottom: 1px solid #eee;
        padding: 0.5em 0;
      }
      .cuartel-info {
        flex: 1;
        min-width: 180px;
      }
      .cuartel-actions {
        display: flex;
        gap: 0.2em;
        align-items: center;
      }
      .info-secundaria {
        font-size: 0.85em;
        color: #666;
        display: block;
        margin-left: 1em;
      }
      #status.success { color: green; }
      #status.error { color: red; }
      #status.warn { color: orange; }
    </style>
  </head>
  <body>
    <div id="header-container"></div>
    <main class="container">
      <hgroup>
        <h2>Cuarteles</h2>
      </hgroup>
      <form id="cuartel-form">
        <fieldset>
          <legend>Datos principales</legend>
          <label for="finca_id">Finca</label>
          <select name="finca_id" id="finca_id" required>
            <option value="">Seleccionar finca...</option>
          </select>
          <label for="nombre_cuartel">Nombre del cuartel</label>
          <input type="text" name="nombre" id="nombre_cuartel" placeholder="Nombre del cuartel" required />
          <label for="superficie_cuartel">Superficie (ha)</label>
          <input type="number" name="superficie" id="superficie_cuartel" placeholder="Superficie (ha)" step="0.01" min="0" />
        </fieldset>
        <fieldset>
          <legend>Datos secundarios</legend>
          <label for="nro_viñedo">Nro Viñedo</label>
          <input type="text" name="nro_viñedo" id="nro_viñedo" placeholder="Nro Viñedo" />
          <label for="provincia">Provincia</label>
          <input type="text" name="provincia" id="provincia" placeholder="Provincia" />
          <label for="departamento">Departamento</label>
          <input type="text" name="departamento" id="departamento" placeholder="Departamento" />
          <label for="especie">Especie</label>
          <input type="text" name="especie" id="especie" placeholder="Especie" />
        </fieldset>
        <fieldset>
          <legend>Variedades</legend>
          <label for="variedades_cuartel">Variedades</label>
          <select id="variedades_cuartel" multiple size="3">
            <!-- Opciones generadas dinámicamente -->
          </select>
          <small>Puedes seleccionar hasta 3 variedades</small>
        </fieldset>
        <button type="submit">Guardar Cuartel</button>
        <button type="button" id="cancelEdit" style="display:none;">Cancelar</button>
      </form>
      <p id="status"></p>

      <h3>Cuarteles registrados</h3>
      <ul id="cuarteles-list"></ul>
    </main>
    <script type="module">
    import { supabase } from "./supabaseClient.js";
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      window.location.href = "login.html";
      throw new Error("No autorizado");
    }

      const form = document.getElementById("cuartel-form");
      const status = document.getElementById("status");
      const lista = document.getElementById("cuarteles-list");
      const fincaSelect = document.getElementById("finca_id");
      const nombreInput = document.getElementById("nombre_cuartel");
      const superficieInput = document.getElementById("superficie_cuartel");
      const nroViñedoInput = document.getElementById("nro_viñedo");
      const provinciaInput = document.getElementById("provincia");
      const departamentoInput = document.getElementById("departamento");
      const especieInput = document.getElementById("especie");
      const variedadInput = document.getElementById("variedad");
      const variedadesSelect = document.getElementById("variedades_cuartel");
      const cancelEditBtn = document.getElementById("cancelEdit");

      let editId = null;
      let fincasMap = {};
      let variedadesMap = {};

      // Obtener usuario actual
      // user ya está definido globalmente arriba
      const userId = user?.id;

      async function cargarFincas() {
        const { data, error } = await supabase
          .from("fincas")
          .select("id, nombre_finca")
          .eq("usuario_id", userId);

        fincaSelect.innerHTML = '<option value="">Seleccionar finca...</option>';
        fincasMap = {};
        if (error || !data) {
          status.textContent = "❌ Error cargando fincas";
          status.className = "error";
          return;
        }
        data.forEach(f => {
          fincasMap[f.id] = f.nombre_finca;
          const opt = document.createElement("option");
          opt.value = f.id;
          opt.textContent = f.nombre_finca;
          fincaSelect.appendChild(opt);
        });
      }

      async function cargarVariedades() {
        const { data, error } = await supabase
          .from("variedades")
          .select("id, nombre");
        variedadesSelect.innerHTML = "";
        variedadesMap = {};
        if (error || !data) return;
        data.forEach(v => {
          variedadesMap[v.id] = v.nombre;
          const opt = document.createElement("option");
          opt.value = v.id;
          opt.textContent = v.nombre;
          variedadesSelect.appendChild(opt);
        });
      }

      // Obtener variedades de un cuartel
      async function obtenerVariedadesCuartel(cuartelId) {
        const { data, error } = await supabase
          .from("cuartel_variedades")
          .select("variedad_id")
          .eq("cuartel_id", cuartelId);
        if (error || !data) return [];
        return data.map(v => v.variedad_id);
      }

      // Guardar variedades seleccionadas para un cuartel
      async function guardarVariedadesCuartel(cuartelId, variedadesSeleccionadas) {
        await supabase.from("cuartel_variedades").delete().eq("cuartel_id", cuartelId);
        for (const variedadId of variedadesSeleccionadas) {
          const { error } = await supabase.from("cuartel_variedades").insert({ cuartel_id: cuartelId, variedad_id: variedadId });
          if (error) console.error("Error insertando variedad:", variedadId, error);
        }
      }

      async function cargarCuarteles() {
        const { data, error } = await supabase
          .from("cuarteles")
          .select("*")
          .in("finca_id", Object.keys(fincasMap));

        if (error) {
          status.textContent = "❌ Error cargando cuarteles";
          status.className = "error";
          return;
        }
        lista.innerHTML = "";
        for (const c of data) {
          const variedadesIds = await obtenerVariedadesCuartel(c.id);
          const variedadesNombres = variedadesIds.map(id => variedadesMap[id]).filter(Boolean);
          const li = document.createElement("li");
          li.innerHTML = `
            <span class="cuartel-info">
              <strong>${c.nombre}</strong>
              <small class="info-secundaria">Finca: ${fincasMap[c.finca_id] || '-'}</small>
              ${c.superficie ? `<small class="info-secundaria">Superficie: ${c.superficie} ha</small>` : ""}
              ${c.nro_viñedo ? `<small class="info-secundaria">Viñedo: ${c.nro_viñedo}</small>` : ""}
              ${c.provincia ? `<small class="info-secundaria">Provincia: ${c.provincia}</small>` : ""}
              ${c.departamento ? `<small class="info-secundaria">Departamento: ${c.departamento}</small>` : ""}
              ${c.especie ? `<small class="info-secundaria">Especie: ${c.especie}</small>` : ""}
              ${variedadesNombres.length ? `<small class="info-secundaria">Variedades: ${variedadesNombres.join(", ")}</small>` : ""}
            </span>
            <span class="cuartel-actions">
              <button data-id="${c.id}" class="edit btn-small">Editar</button>
              <button data-id="${c.id}" class="delete btn-small">Eliminar</button>
            </span>
          `;
          li.classList.add("cuartel-item");
          lista.appendChild(li);
        }

        // Editar cuartel
        lista.querySelectorAll(".edit").forEach(btn => {
          btn.onclick = async () => {
            editId = btn.dataset.id;
            const cuartel = data.find(c => c.id == editId);
            fincaSelect.value = cuartel.finca_id;
            nombreInput.value = cuartel.nombre;
            superficieInput.value = cuartel.superficie || "";
            nroViñedoInput.value = cuartel.nro_viñedo || "";
            provinciaInput.value = cuartel.provincia || "";
            departamentoInput.value = cuartel.departamento || "";
            especieInput.value = cuartel.especie || "";
            // Cargar variedades seleccionadas
            const variedadesIds = await obtenerVariedadesCuartel(editId);
            Array.from(variedadesSelect.options).forEach(opt => {
              opt.selected = variedadesIds.includes(Number(opt.value));
            });
            status.textContent = "Editando cuartel #" + editId;
            status.className = "warn";
            cancelEditBtn.style.display = "";
          };
        });

        // Eliminar cuartel
        lista.querySelectorAll(".delete").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            if (!confirm("¿Seguro que deseas eliminar este cuartel?")) return;
            await supabase.from("cuartel_variedades").delete().eq("cuartel_id", id);
            const { error } = await supabase.from("cuarteles").delete().eq("id", id);
            if (error) {
              status.textContent = "❌ Error al eliminar";
              status.className = "error";
            } else {
              status.textContent = "✅ Cuartel eliminado";
              status.className = "success";
            }
            cargarCuarteles();
          };
        });
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        // Validaciones
        if (!fincaSelect.value || !nombreInput.value) {
          status.textContent = "⚠️ Debe completar finca y nombre";
          status.className = "warn";
          return;
        }
        if (superficieInput.value && Number(superficieInput.value) <= 0) {
          status.textContent = "⚠️ La superficie debe ser positiva";
          status.className = "warn";
          return;
        }
        const finca_id = fincaSelect.value;
        const nombre = nombreInput.value;
        const superficie = superficieInput.value ? Number(superficieInput.value) : null;
        const nro_viñedo = nroViñedoInput.value || null;
        const provincia = provinciaInput.value || null;
        const departamento = departamentoInput.value || null;
        const especie = especieInput.value || null;
        const variedadesSeleccionadas = Array.from(variedadesSelect.selectedOptions)
          .map(opt => opt.value)
          .filter(id => id) // filtra vacíos
          .slice(0, 3);
        console.log("Variedades seleccionadas:", variedadesSeleccionadas);

        let cuartelId = editId;
        if (editId) {
          // Editar cuartel
          const { error } = await supabase
            .from("cuarteles")
            .update({ finca_id, nombre, superficie, nro_viñedo, provincia, departamento, especie })
            .eq("id", editId);
          if (error) {
            status.textContent = "❌ Error al editar cuartel";
            status.className = "error";
          } else {
            await guardarVariedadesCuartel(editId, variedadesSeleccionadas);
            status.textContent = "✅ Cuartel editado";
            status.className = "success";
            form.reset();
            editId = null;
            cancelEditBtn.style.display = "none";
          }
        } else {
          // Crear cuartel
          const { data, error } = await supabase
            .from("cuarteles")
            .insert({ finca_id, nombre, superficie, nro_viñedo, provincia, departamento, especie })
            .select();
          if (error || !data || !data[0]) {
            status.textContent = "❌ Error al guardar cuartel";
            status.className = "error";
          } else {
            cuartelId = data[0].id;
            await guardarVariedadesCuartel(cuartelId, variedadesSeleccionadas);
            status.textContent = "✅ Cuartel registrado";
            status.className = "success";
            form.reset();
          }
        }
        cargarCuarteles();
      });

      cancelEditBtn.addEventListener("click", () => {
        form.reset();
        editId = null;
        status.textContent = "";
        status.className = "";
        cancelEditBtn.style.display = "none";
      });

      // Cargar header y manejar logout
      fetch('header.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('header-container').innerHTML = html;
          import('./header.js');
          // Manejo de logout (opcional, si no lo tienes en header.js)
          // Eliminar el manejo de logoutBtn ya que se maneja en header.js
        });

      await cargarFincas();
      await cargarVariedades();
      await cargarCuarteles();
    </script>
  </body>
</html>
