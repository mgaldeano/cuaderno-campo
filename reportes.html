<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reportes | Cuaderno de Campo</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Select - versi√≥n compatible con Bootstrap 5 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Google Fonts Roboto -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="estilos.css">
    <!-- jQuery (necesario para Bootstrap Select) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Bootstrap Select JS - versi√≥n beta para Bootstrap 5 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
    <style>
      /* Personalizaci√≥n Bootstrap Select para Bootstrap 5 */
      .bootstrap-select .dropdown-menu {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: 1px solid #dee2e6;
      }
      
      .bootstrap-select .dropdown-menu li a {
        padding: 8px 16px 8px 40px !important;
        font-family: 'Roboto', sans-serif;
        transition: all 0.2s ease;
      }
      
      .bootstrap-select .dropdown-menu li a span.check-mark {
        left: 12px;
        color: #0d6efd;
        font-size: 1.1em;
        font-weight: bold;
      }
      
      .bootstrap-select .dropdown-menu li.selected a {
        background-color: #e7f3ff;
        color: #0d6efd;
        font-weight: 500;
      }
      
      .bootstrap-select .dropdown-menu li a:hover {
        background-color: #f8f9fa;
      }
      
      .bootstrap-select .dropdown-menu li.selected a:hover {
        background-color: #d1ecf1;
      }
      
      .bootstrap-select > .dropdown-toggle {
        border-radius: 6px;
        border: 1px solid #ced4da;
        padding: 8px 12px;
        font-family: 'Roboto', sans-serif;
      }
      
      .bootstrap-select > .dropdown-toggle:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
      }
      
      /* Botones de acciones (Seleccionar todas/ninguna) */
      .bootstrap-select .bs-actionsbox {
        padding: 8px 12px;
        border-bottom: 1px solid #dee2e6;
        background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
        margin-bottom: 2px;
      }
      
      .bootstrap-select .bs-actionsbox .btn-group {
        width: 100%;
        display: flex;
        gap: 4px;
      }
      
      .bootstrap-select .bs-actionsbox .btn-group button {
        font-size: 11px;
        padding: 6px 12px;
        border-radius: 4px;
        border: 1px solid #0d6efd;
        background: #ffffff;
        color: #0d6efd;
        font-weight: 600;
        flex: 1;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.2s ease;
      }
      
      .bootstrap-select .bs-actionsbox .btn-group button:hover {
        background: #0d6efd;
        border-color: #0d6efd;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
      }
      
      /* Asegurar que el actionsBox siempre sea visible */
      .bootstrap-select.open .bs-actionsbox {
        display: block !important;
      }

      .btn-compact {
        font-size:0.95em !important;
        height:1.5em !important;
        width:auto !important;
        min-width:1.5em !important;
        padding:0 !important;
        background:#f5f5f5 !important;
        border:1px solid #bbb !important;
        color:#222 !important;
        border-radius:4px !important;
        box-shadow:none !important;
        display:inline-block !important;
      }
    </style>
    <!-- SheetJS para exportar a Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- jsPDF para exportar a PDF -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script type="module">
    // Reporte de tareas: campos usados seg√∫n la base de datos actual
    // id, tipo_tarea_old, fecha, cuartel_id, duracion, cant_agua, obs
    import { supabase } from "./supabaseClient.js";
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      window.location.href = "login.html";
      throw new Error("No autorizado");
    }
      const contenedor = document.querySelector("#reportes-resultado");

      async function cargarReporte() {
        const { data, error } = await supabase
          .from("tareas")
          .select("id, tipo_tarea_old, fecha, cuartel_id, duracion, cant_agua, obs")
          .order("fecha", { ascending: false });

        if (error) {
          contenedor.innerHTML = "<p>‚ùå Error al cargar el reporte</p>";
          return;
        }

        if (!data || data.length === 0) {
          contenedor.innerHTML = "<p>No hay tareas registradas a√∫n.</p>";
          return;
        }

        const tabla = document.createElement("table");
        tabla.innerHTML = `
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Tipo de Tarea</th>
              <th>Cuartel</th>
              <th>Duraci√≥n (min)</th>
              <th>Cant. Agua</th>
              <th>Observaciones</th>
            </tr>
          </thead>
          <tbody>
            ${data
              .map(
                t => `
              <tr>
                <td>${t.fecha ?? "-"}</td>
                <td>${t.tipo_tarea_old ?? "-"}</td>
                <td>${t.cuartel_id ?? "-"}</td>
                <td>${t.duracion ?? "-"}</td>
                <td>${t.cant_agua ?? "-"}</td>
                <td>${t.obs ?? ""}</td>
              </tr>
            `
              )
              .join("")}
          </tbody>
        `;
        contenedor.innerHTML = "";
        contenedor.appendChild(tabla);
      }

      cargarReporte();
    </script>
  </head>
  <body>
    <div id="header-container"></div>

    <!-- Navegaci√≥n din√°mica: se carga desde header.html en #header-container -->

    <main class="container py-4">
      <!-- Header Section -->
      <div class="container-fluid bg-light py-3 mb-4">
        <div class="container">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="h3 mb-1 text-primary font-weight-bold">
                <i class="bi bi-graph-up text-primary me-2"></i>
                Reportes y An√°lisis
              </h1>
              <p class="text-muted mb-0">Genere reportes detallados de sus actividades agr√≠colas</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Formulario de Filtros -->
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm border-0" style="border-radius: 16px;">
            <div class="card-header bg-white border-0 pt-4 pb-0">
              <h5 class="card-title mb-0 d-flex align-items-center">
                <i class="bi bi-funnel text-primary me-2"></i>
                <span>Configuraci√≥n del Reporte</span>
              </h5>
            </div>
            <div class="card-body p-4">
              <form id="reportes-filtros" class="mb-0">
                <div class="row mb-4">
                  <div class="col-md-6">
                    <label for="tipo-reporte" class="form-label font-weight-medium">
                      <i class="bi bi-file-earmark-bar-graph me-1"></i> Tipo de Reporte *
                    </label>
                    <select id="tipo-reporte" class="form-select" required>
                      <option value="riegos">üìä Riegos realizados</option>
                      <option value="riegos-regador">üë§ Riegos por regador</option>
                      <option value="agroquimicos">üß™ Aplicaciones de agroqu√≠micos</option>
                      <option value="fertilizaciones">üå± Fertilizaciones</option>
                      <option value="labores">üöú Labores de suelo</option>
                      <option value="bpa">‚úÖ Normas BPA (auditor√≠a)</option>
                    </select>
                  </div>
                </div>

                <!-- Filtros generales -->
                <div id="filtros-generales">
                  <div class="row mb-4">
                    <div class="col-md-6">
                      <label for="finca-reporte" class="form-label font-weight-medium">
                        <i class="bi bi-geo-alt me-1"></i> Fincas
                      </label>
                      <div class="mb-2">
                        <button type="button" id="finca-todo" class="btn btn-sm btn-outline-primary me-2">Seleccionar Todo</button>
                        <button type="button" id="finca-nada" class="btn btn-sm btn-outline-secondary">Deseleccionar Todo</button>
                      </div>
                      <select id="finca-reporte" class="form-select selectpicker" multiple 
                              title="Seleccione fincas..." data-live-search="true">
                      </select>
                      <div class="form-text">Filtra por fincas seleccionadas</div>
                    </div>
                    <div class="col-md-6">
                      <label for="cuartel-reporte" class="form-label font-weight-medium">
                        <i class="bi bi-grid me-1"></i> Cuarteles
                      </label>
                      <div class="mb-2">
                        <button type="button" id="cuartel-todo" class="btn btn-sm btn-outline-primary me-2">Seleccionar Todo</button>
                        <button type="button" id="cuartel-nada" class="btn btn-sm btn-outline-secondary">Deseleccionar Todo</button>
                      </div>
                      <select id="cuartel-reporte" class="form-select selectpicker" multiple 
                              title="Seleccione cuarteles..." data-live-search="true">
                      </select>
                      <div class="form-text">Filtra por cuarteles seleccionados</div>
                    </div>
                  </div>

                  <div class="row mb-4">
                    <div class="col-md-6">
                      <label for="fecha-desde" class="form-label font-weight-medium">
                        <i class="bi bi-calendar-event me-1"></i> Fecha Desde
                      </label>
                      <input type="date" id="fecha-desde" class="form-control" value="2000-01-01" />
                      <div class="form-text">Filtra registros desde esta fecha</div>
                    </div>
                    <div class="col-md-6">
                      <label for="fecha-hasta" class="form-label font-weight-medium">
                        <i class="bi bi-calendar-check me-1"></i> Fecha Hasta
                      </label>
                      <input type="date" id="fecha-hasta" class="form-control" />
                      <div class="form-text">Filtra registros hasta esta fecha</div>
                    </div>
                  </div>
                </div>

                <!-- Contenedores para filtros espec√≠ficos seg√∫n rol -->
                <div id="filtros-productor" style="display:none;"></div>
                <div id="filtros-operador" style="display:none;"></div>

                <div class="d-flex justify-content-between align-items-center">
                  <button type="submit" class="btn btn-primary btn-lg px-4">
                    <i class="bi bi-play-circle me-2"></i>
                    Generar Reporte
                  </button>
                  <div>
                    <button id="exportar-excel" type="button" class="btn btn-success me-2">
                      <i class="bi bi-file-earmark-excel me-1"></i> Excel
                    </button>
                    <button id="exportar-csv" type="button" class="btn btn-info me-2">
                      <i class="bi bi-filetype-csv me-1"></i> CSV
                    </button>
                    <button id="exportar-pdf" type="button" class="btn btn-danger">
                      <i class="bi bi-file-earmark-pdf me-1"></i> PDF
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Resultados del Reporte -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="card shadow-sm border-0" style="border-radius: 16px;">
            <div class="card-header bg-white border-0 pt-4 pb-0">
              <h5 class="card-title mb-0 d-flex align-items-center">
                <i class="bi bi-table text-primary me-2"></i>
                <span>Resultados del Reporte</span>
                <span class="badge bg-primary ms-2" id="total-registros">0</span>
              </h5>
            </div>
            <div class="card-body p-4">
              <div id="reportes-resultado">
                <div class="text-center py-5 text-muted">
                  <i class="bi bi-graph-up-arrow fs-1 mb-3 d-block"></i>
                  <h5>Configure los filtros y genere su reporte</h5>
                  <p>Seleccione el tipo de reporte y configure los filtros para comenzar</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="container">
      <small><a href="#">Privacidad</a> ‚Ä¢ <a href="#">T√©rminos</a></small>
      <br>
      <small id="footer-version" style="color:#888;"></small>
    </footer>
    <script type="module" src="reportes.js"></script>
    
    <!-- Script para Bootstrap Select en reportes -->
    <script type="module">
      import { supabase } from "./supabaseClient.js";
      
      // Hacer supabase disponible globalmente
      window.supabase = supabase;
      
      // Cargar header
      fetch('header.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('header-container').innerHTML = html;
          import('./header.js');
        });

      // Variables globales para almacenar datos
      let todasLasFincas = [];
      let todosLosCuarteles = [];

      $(document).ready(function() {
        // Configurar fecha hasta como hoy
        const hoy = new Date().toISOString().split('T')[0];
        document.getElementById('fecha-hasta').value = hoy;

        // Inicializar Bootstrap Select
        $('.selectpicker').selectpicker({
          actionsBox: true,
          selectAllText: 'Todas',
          deselectAllText: 'Ninguna',
          countSelectedText: function(numSelected, numTotal) {
            return numSelected + ' de ' + numTotal + ' seleccionadas';
          },
          selectedTextFormat: 'count > 2',
          liveSearch: true,
          liveSearchPlaceholder: 'Buscar...',
          noneSelectedText: 'Seleccione opciones...',
          style: 'btn-outline-secondary'
        });

        // Cargar opciones iniciales
        cargarFincasReporte();

        // Configurar botones de todo/nada
        $('#finca-todo').on('click', function() {
          $('#finca-reporte').selectpicker('selectAll');
          $('#finca-reporte').trigger('changed.bs.select');
        });
        
        $('#finca-nada').on('click', function() {
          $('#finca-reporte').selectpicker('deselectAll');
          $('#finca-reporte').trigger('changed.bs.select');
        });
        
        $('#cuartel-todo').on('click', function() {
          $('#cuartel-reporte').selectpicker('selectAll');
        });
        
        $('#cuartel-nada').on('click', function() {
          $('#cuartel-reporte').selectpicker('deselectAll');
        });

        // Configurar evento para cascada fincas ‚Üí cuarteles
        $('#finca-reporte').on('changed.bs.select', function() {
          cargarCuartelesReporte();
        });
      });

      // Funci√≥n para cargar fincas en el reporte
      async function cargarFincasReporte() {
        try {
          const { data: fincas, error } = await supabase
            .from('fincas')
            .select('id, nombre_finca')
            .order('nombre_finca');
          
          if (error) throw error;
          
          todasLasFincas = fincas || [];
          
          // Limpiar y repoblar el selector
          const selector = $('#finca-reporte');
          selector.empty();
          
          todasLasFincas.forEach(finca => {
            selector.append(`<option value="${finca.id}">${finca.nombre_finca}</option>`);
          });
          
          // Refrescar Bootstrap Select
          selector.selectpicker('refresh');
          
        } catch (error) {
          console.error('Error cargando fincas:', error);
          alert('Error al cargar las fincas: ' + error.message);
        }
      }

      // Funci√≥n para cargar cuarteles seg√∫n fincas seleccionadas
      async function cargarCuartelesReporte() {
        try {
          const fincasSeleccionadas = $('#finca-reporte').val();
          
          // Limpiar selector de cuarteles
          const selector = $('#cuartel-reporte');
          selector.empty();
          
          if (!fincasSeleccionadas || fincasSeleccionadas.length === 0) {
            selector.selectpicker('refresh');
            return;
          }
          
          // Obtener cuarteles de las fincas seleccionadas
          const { data: cuarteles, error } = await supabase
            .from('cuarteles')
            .select('*')
            .in('finca_id', fincasSeleccionadas)
            .order('nombre');
          
          if (error) throw error;
          
          // Usar Map para eliminar duplicados por ID
          const cuartelesMap = new Map();
          cuarteles.forEach(cuartel => {
            cuartelesMap.set(cuartel.id, cuartel);
          });
          
          todosLosCuarteles = Array.from(cuartelesMap.values());
          
          // Poblar selector con cuarteles √∫nicos
          todosLosCuarteles.forEach(cuartel => {
            selector.append(`<option value="${cuartel.id}">${cuartel.nombre}</option>`);
          });
          
          // Refrescar Bootstrap Select
          selector.selectpicker('refresh');
          
        } catch (error) {
          console.error('Error cargando cuarteles:', error);
          alert('Error al cargar los cuarteles: ' + error.message);
        }
      }

      // Hacer funciones globales disponibles
      window.cargarFincasReporte = cargarFincasReporte;
      window.cargarCuartelesReporte = cargarCuartelesReporte;
    </script>
    
    <script>
      window.addEventListener('DOMContentLoaded', () => {
        const tipoReporte = document.getElementById('tipo-reporte');
        const filtrosGenerales = document.getElementById('filtros-generales');
        if (tipoReporte) {
          tipoReporte.addEventListener('change', (e) => {
            if (e.target.value === 'riegos-regador') {
              if (filtrosGenerales) filtrosGenerales.style.display = 'none';
              if (window.renderRiegosPorRegadorUI) window.renderRiegosPorRegadorUI();
            } else {
              if (filtrosGenerales) filtrosGenerales.style.display = '';
              window.location.reload(); // recarga para mostrar el filtro est√°ndar
            }
          });
        }
      });
    </script>
  </body>
</html>