<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reportes | Cuaderno de Campo</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“Š</text></svg>">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Select - versiÃ³n compatible con Bootstrap 5 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Google Fonts Roboto -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="estilos.css">
    <!-- jQuery (necesario para Bootstrap Select) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Bootstrap Select JS - versiÃ³n beta para Bootstrap 5 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
    <style>
      /* PersonalizaciÃ³n Bootstrap Select para Bootstrap 5 */
      .bootstrap-select .dropdown-menu {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: 1px solid #dee2e6;
      }
      
      .bootstrap-select .dropdown-menu li a {
        padding: 8px 16px 8px 40px !important;
        font-family: 'Roboto', sans-serif;
        transition: all 0.2s ease;
      }
      
      .bootstrap-select .dropdown-menu li a span.check-mark {
        left: 12px;
        color: #0d6efd;
        font-size: 1.1em;
        font-weight: bold;
      }
      
      .bootstrap-select .dropdown-menu li.selected a {
        background-color: #e7f3ff;
        color: #0d6efd;
        font-weight: 500;
      }
      
      .bootstrap-select .dropdown-menu li a:hover {
        background-color: #f8f9fa;
      }
      
      .bootstrap-select .dropdown-menu li.selected a:hover {
        background-color: #d1ecf1;
      }
      
      .bootstrap-select > .dropdown-toggle {
        border-radius: 6px;
        border: 1px solid #ced4da;
        padding: 8px 12px;
        font-family: 'Roboto', sans-serif;
      }
      
      .bootstrap-select > .dropdown-toggle:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
      }
      
      /* Botones de acciones (Seleccionar todas/ninguna) */
      .bootstrap-select .bs-actionsbox {
        padding: 8px 12px;
        border-bottom: 1px solid #dee2e6;
        background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
        margin-bottom: 2px;
      }
      
      .bootstrap-select .bs-actionsbox .btn-group {
        width: 100%;
        display: flex;
        gap: 4px;
      }
      
      .bootstrap-select .bs-actionsbox .btn-group button {
        font-size: 11px;
        padding: 6px 12px;
        border-radius: 4px;
        border: 1px solid #0d6efd;
        background: #ffffff;
        color: #0d6efd;
        font-weight: 600;
        flex: 1;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.2s ease;
      }
      
      .bootstrap-select .bs-actionsbox .btn-group button:hover {
        background: #0d6efd;
        border-color: #0d6efd;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
      }
      
      /* Asegurar que el actionsBox siempre sea visible */
      .bootstrap-select.open .bs-actionsbox {
        display: block !important;
      }

      .btn-compact {
        font-size:0.95em !important;
        height:1.5em !important;
        width:auto !important;
        min-width:1.5em !important;
        padding:0 !important;
        background:#f5f5f5 !important;
        border:1px solid #bbb !important;
        color:#222 !important;
        border-radius:4px !important;
        box-shadow:none !important;
        display:inline-block !important;
      }
    </style>
    <!-- SheetJS para exportar a Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- jsPDF para exportar a PDF -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  </head>
  <body>
    <div id="header-container"></div>

    <!-- NavegaciÃ³n dinÃ¡mica: se carga desde header.html en #header-container -->

    <main class="container py-4">
      <!-- Header Section -->
      <div class="container-fluid bg-light py-3 mb-4">
        <div class="container">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="h3 mb-1 text-primary font-weight-bold">
                <i class="bi bi-graph-up text-primary me-2"></i>
                Reportes de Riegos
              </h1>
              <p class="text-muted mb-0">Genere reportes detallados de riegos por finca o por regador</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Selector de Tipo de Reporte -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card shadow-sm border-0" style="border-radius: 16px;">
            <div class="card-header bg-white border-0 pt-4 pb-0">
              <h5 class="card-title mb-0 d-flex align-items-center">
                <i class="bi bi-funnel text-primary me-2"></i>
                <span>Tipo de Reporte</span>
              </h5>
            </div>
            <div class="card-body p-4">
              <div class="row">
                <div class="col-md-6">
                  <label for="tipo-reporte" class="form-label font-weight-medium">
                    <i class="bi bi-file-earmark-bar-graph me-1"></i> Seleccione el tipo de reporte
                  </label>
                  <select id="tipo-reporte" class="form-select">
                    <option value="finca" selected>ðŸ“Š Riegos por Finca</option>
                    <option value="regador">ðŸ‘¤ Riegos por Regador</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Formulario de Filtros para Riegos por Finca -->
      <div id="filtros-finca" class="row mb-4">
        <div class="col-12">
          <div class="card shadow-sm border-0" style="border-radius: 16px;">
            <div class="card-header bg-white border-0 pt-4 pb-0">
              <h5 class="card-title mb-0 d-flex align-items-center">
                <i class="bi bi-geo-alt text-primary me-2"></i>
                <span>Filtros - Riegos por Finca</span>
              </h5>
            </div>
            <div class="card-body p-4">
              <form id="form-finca">
                <div class="row">
                  <div class="col-md-4">
                    <label for="finca-select" class="form-label font-weight-medium">
                      <i class="bi bi-geo-alt me-1"></i> Fincas *
                    </label>
                    <select id="finca-select" class="form-select selectpicker" multiple
                            title="Seleccione fincas..." data-live-search="true" data-actions-box="true">
                    </select>
                    <div class="form-text">Se generarÃ¡ un reporte por cada finca seleccionada</div>
                  </div>
                  <div class="col-md-3">
                    <label for="fecha-desde-finca" class="form-label font-weight-medium">
                      <i class="bi bi-calendar-event me-1"></i> Desde
                    </label>
                    <input type="date" id="fecha-desde-finca" class="form-control" value="2000-01-01" />
                  </div>
                  <div class="col-md-3">
                    <label for="fecha-hasta-finca" class="form-label font-weight-medium">
                      <i class="bi bi-calendar-check me-1"></i> Hasta
                    </label>
                    <input type="date" id="fecha-hasta-finca" class="form-control" />
                  </div>
                  <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                      <i class="bi bi-play-circle me-1"></i> Generar
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Formulario de Filtros para Riegos por Regador -->
      <div id="filtros-regador" class="row mb-4" style="display: none;">
        <div class="col-12">
          <div class="card shadow-sm border-0" style="border-radius: 16px;">
            <div class="card-header bg-white border-0 pt-4 pb-0">
              <h5 class="card-title mb-0 d-flex align-items-center">
                <i class="bi bi-person text-primary me-2"></i>
                <span>Filtros - Riegos por Regador</span>
              </h5>
            </div>
            <div class="card-body p-4">
              <form id="form-regador">
                <div class="row">
                  <div class="col-md-4">
                    <label for="regador-select" class="form-label font-weight-medium">
                      <i class="bi bi-person me-1"></i> Regador(es) *
                    </label>
                    <select id="regador-select" class="form-select selectpicker" multiple
                            title="Seleccione regador(es)..." data-live-search="true">
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label for="fecha-desde-regador" class="form-label font-weight-medium">
                      <i class="bi bi-calendar-event me-1"></i> Desde
                    </label>
                    <input type="date" id="fecha-desde-regador" class="form-control" value="2000-01-01" />
                  </div>
                  <div class="col-md-3">
                    <label for="fecha-hasta-regador" class="form-label font-weight-medium">
                      <i class="bi bi-calendar-check me-1"></i> Hasta
                    </label>
                    <input type="date" id="fecha-hasta-regador" class="form-control" />
                  </div>
                  <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                      <i class="bi bi-play-circle me-1"></i> Generar
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Resultados del Reporte -->
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm border-0" style="border-radius: 16px;">
            <div class="card-header bg-white border-0 pt-4 pb-0">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0 d-flex align-items-center">
                  <i class="bi bi-table text-primary me-2"></i>
                  <span>Resultados del Reporte</span>
                  <span class="badge bg-primary ms-2" id="total-registros">0</span>
                </h5>
                <div>
                  <button id="exportar-excel" type="button" class="btn btn-success btn-sm me-2">
                    <i class="bi bi-file-earmark-excel me-1"></i> Excel
                  </button>
                  <button id="exportar-csv" type="button" class="btn btn-info btn-sm me-2">
                    <i class="bi bi-filetype-csv me-1"></i> CSV
                  </button>
                  <button id="exportar-pdf" type="button" class="btn btn-danger btn-sm">
                    <i class="bi bi-file-earmark-pdf me-1"></i> PDF
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body p-4">
              <div id="reportes-resultado">
                <div class="text-center py-5 text-muted">
                  <i class="bi bi-graph-up-arrow fs-1 mb-3 d-block"></i>
                  <h5>Seleccione un tipo de reporte y configure los filtros</h5>
                  <p>Los resultados aparecerÃ¡n aquÃ­ una vez que genere el reporte</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="container">
      <small><a href="#">Privacidad</a> â€¢ <a href="#">TÃ©rminos</a></small>
      <br>
      <small id="footer-version" style="color:#888;"></small>
    </footer>
    
    <!-- Script para Bootstrap Select en reportes -->
    <script type="module">
      import { supabase } from "./supabaseClient.js";
      
      // Hacer supabase disponible globalmente
      window.supabase = supabase;
      
      // Cargar header
      fetch('header.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('header-container').innerHTML = html;
          import('./header.js');
        });

      $(document).ready(function() {
        // Configurar fecha hasta como hoy
        const hoy = new Date().toISOString().split('T')[0];
        document.getElementById('fecha-hasta-finca').value = hoy;
        document.getElementById('fecha-hasta-regador').value = hoy;

        // Inicializar Bootstrap Select
        $('.selectpicker').selectpicker({
          actionsBox: true,
          selectAllText: 'Seleccionar todas',
          deselectAllText: 'Deseleccionar todas',
          countSelectedText: function(numSelected, numTotal) {
            if (numSelected == 1) {
              return numSelected + ' finca seleccionada';
            } else {
              return numSelected + ' fincas seleccionadas';
            }
          },
          selectedTextFormat: 'count > 2',
          liveSearch: true,
          liveSearchPlaceholder: 'Buscar...',
          noneSelectedText: 'Seleccione fincas...',
          style: 'btn-outline-secondary'
        });

        // Cargar datos iniciales
        cargarFincas();
        cargarRegadores();

        // Configurar cambio de tipo de reporte
        $('#tipo-reporte').change(function() {
          const tipo = $(this).val();
          if (tipo === 'finca') {
            $('#filtros-finca').show();
            $('#filtros-regador').hide();
          } else {
            $('#filtros-finca').hide();
            $('#filtros-regador').show();
          }
        });

        // Configurar formularios
        $('#form-finca').submit(function(e) {
          e.preventDefault();
          generarReporteFinca();
        });

        $('#form-regador').submit(function(e) {
          e.preventDefault();
          generarReporteRegador();
        });
        
        // Event listeners para botones de exportaciÃ³n
        $('#exportar-excel').click(exportarExcel);
        $('#exportar-csv').click(exportarCSV);
        $('#exportar-pdf').click(exportarPDF);
      });

      // FunciÃ³n para cargar fincas
      async function cargarFincas() {
        try {
          const { data: fincas, error } = await supabase
            .from('fincas')
            .select('id, nombre_finca')
            .order('nombre_finca');
          
          if (error) throw error;
          
          const selector = $('#finca-select');
          selector.empty();
          
          fincas.forEach(finca => {
            selector.append(`<option value="${finca.id}">${finca.nombre_finca}</option>`);
          });
          
          // Reconfiguramos el selectpicker con los textos en espaÃ±ol
          selector.selectpicker('destroy').selectpicker({
            actionsBox: true,
            selectAllText: 'Seleccionar todas',
            deselectAllText: 'Deseleccionar todas',
            countSelectedText: function(numSelected, numTotal) {
              if (numSelected == 1) {
                return numSelected + ' finca seleccionada';
              } else {
                return numSelected + ' fincas seleccionadas';
              }
            },
            selectedTextFormat: 'count > 2',
            liveSearch: true,
            liveSearchPlaceholder: 'Buscar...',
            noneSelectedText: 'Seleccione fincas...',
            style: 'btn-outline-secondary'
          });
          
        } catch (error) {
          console.error('Error cargando fincas:', error);
          alert('Error al cargar las fincas: ' + error.message);
        }
      }

      // FunciÃ³n para cargar regadores
      async function cargarRegadores() {
        try {
          const { data: regadores, error } = await supabase
            .from('aplicadores_operarios')
            .select('id, nombre, apellido')
            .order('apellido', { ascending: true })
            .order('nombre', { ascending: true });
          
          if (error) throw error;
          
          const selector = $('#regador-select');
          selector.empty();
          
          regadores.forEach(regador => {
            const nombreCompleto = `${regador.apellido || ''}, ${regador.nombre}`.replace(/^, /, '');
            selector.append(`<option value="${regador.id}">${nombreCompleto}</option>`);
          });
          
          // Reconfiguramos el selectpicker para el selector de regadores
          selector.selectpicker('destroy').selectpicker({
            actionsBox: true,
            selectAllText: 'Seleccionar todos',
            deselectAllText: 'Deseleccionar todos',
            countSelectedText: function(numSelected, numTotal) {
              if (numSelected == 1) {
                return numSelected + ' regador seleccionado';
              } else {
                return numSelected + ' regadores seleccionados';
              }
            },
            selectedTextFormat: 'count > 2',
            liveSearch: true,
            liveSearchPlaceholder: 'Buscar regador...',
            noneSelectedText: 'Seleccione regador(es)...',
            style: 'btn-outline-secondary'
          });
          
        } catch (error) {
          console.error('Error cargando regadores:', error);
          alert('Error al cargar los regadores: ' + error.message);
        }
      }

      // FunciÃ³n para generar reporte por finca
      async function generarReporteFinca() {
        const fincaIds = $('#finca-select').val();
        const desde = $('#fecha-desde-finca').val();
        const hasta = $('#fecha-hasta-finca').val();

        if (!fincaIds || fincaIds.length === 0) {
          alert('Por favor, seleccione al menos una finca');
          return;
        }

        try {
          // Cargar datos de referencia primero
          const [fincasResult, cuartelesResult, aplicadoresResult] = await Promise.all([
            supabase.from('fincas').select('id, nombre_finca'),
            supabase.from('cuarteles').select('id, nombre'),
            supabase.from('aplicadores_operarios').select('id, nombre, apellido')
          ]);

          const fincasMap = {};
          fincasResult.data?.forEach(f => fincasMap[f.id] = f.nombre_finca);
          
          const cuartelesMap = {};
          cuartelesResult.data?.forEach(c => cuartelesMap[c.id] = c.nombre);
          
          const aplicadoresMap = {};
          aplicadoresResult.data?.forEach(a => {
            aplicadoresMap[a.id] = `${a.apellido || ''}, ${a.nombre}`.replace(/^, /, '');
          });

          // Consultar riegos para las fincas seleccionadas
          let query = supabase
            .from('riegos')
            .select('id, fecha, horas_riego, volumen_agua, observaciones, objetivo, finca_id, cuartel_id, operador_id')
            .in('finca_id', fincaIds);

          if (desde) query = query.gte('fecha', desde);
          if (hasta) query = query.lte('fecha', hasta);

          const { data: riegos, error } = await query.order('fecha', { ascending: false });

          if (error) throw error;

          // Mapear los datos
          const riegosConDatos = riegos.map(riego => ({
            ...riego,
            fincas: { nombre_finca: fincasMap[riego.finca_id] || '-' },
            cuarteles: { nombre: cuartelesMap[riego.cuartel_id] || '-' },
            aplicadores_operarios: riego.operador_id ? {
              nombre: aplicadoresMap[riego.operador_id]?.split(', ')[1] || '',
              apellido: aplicadoresMap[riego.operador_id]?.split(', ')[0] || ''
            } : null
          }));

          mostrarResultados(riegosConDatos, 'finca');

        } catch (error) {
          console.error('Error generando reporte:', error);
          alert('Error al generar el reporte: ' + error.message);
        }
      }

      // FunciÃ³n para generar reporte por regador
      async function generarReporteRegador() {
        const regadorIds = $('#regador-select').val();
        const desde = $('#fecha-desde-regador').val();
        const hasta = $('#fecha-hasta-regador').val();

        if (!regadorIds || regadorIds.length === 0) {
          alert('Por favor, seleccione al menos un regador');
          return;
        }

        try {
          // Cargar datos de referencia primero
          const [fincasResult, cuartelesResult, aplicadoresResult] = await Promise.all([
            supabase.from('fincas').select('id, nombre_finca'),
            supabase.from('cuarteles').select('id, nombre'),
            supabase.from('aplicadores_operarios').select('id, nombre, apellido')
          ]);

          const fincasMap = {};
          fincasResult.data?.forEach(f => fincasMap[f.id] = f.nombre_finca);
          
          const cuartelesMap = {};
          cuartelesResult.data?.forEach(c => cuartelesMap[c.id] = c.nombre);
          
          const aplicadoresMap = {};
          aplicadoresResult.data?.forEach(a => {
            aplicadoresMap[a.id] = `${a.apellido || ''}, ${a.nombre}`.replace(/^, /, '');
          });

          // Consultar riegos para los regadores seleccionados
          let query = supabase
            .from('riegos')
            .select('id, fecha, horas_riego, volumen_agua, observaciones, objetivo, finca_id, cuartel_id, operador_id')
            .in('operador_id', regadorIds);

          if (desde) query = query.gte('fecha', desde);
          if (hasta) query = query.lte('fecha', hasta);

          const { data: riegos, error } = await query.order('fecha', { ascending: false });

          if (error) throw error;

          // Mapear los datos
          const riegosConDatos = riegos.map(riego => ({
            ...riego,
            fincas: { nombre_finca: fincasMap[riego.finca_id] || '-' },
            cuarteles: { nombre: cuartelesMap[riego.cuartel_id] || '-' },
            aplicadores_operarios: riego.operador_id ? {
              nombre: aplicadoresMap[riego.operador_id]?.split(', ')[1] || '',
              apellido: aplicadoresMap[riego.operador_id]?.split(', ')[0] || ''
            } : null
          }));

          mostrarResultados(riegosConDatos, 'regador');

        } catch (error) {
          console.error('Error generando reporte:', error);
          alert('Error al generar el reporte: ' + error.message);
        }
      }

      // FunciÃ³n para mostrar resultados
      function mostrarResultados(datos, tipo) {
        const contenedor = $('#reportes-resultado');
        
        if (!datos || datos.length === 0) {
          contenedor.html(`
            <div class="text-center py-5 text-muted">
              <i class="bi bi-info-circle fs-1 mb-3 d-block"></i>
              <h5>No se encontraron registros</h5>
              <p>No hay riegos registrados para los filtros seleccionados</p>
            </div>
          `);
          $('#total-registros').text('0');
          return;
        }

        $('#total-registros').text(datos.length);

        // Si es reporte por finca, agrupar por finca
        if (tipo === 'finca') {
          // Agrupar datos por finca
          const datosPorFinca = {};
          datos.forEach(riego => {
            const nombreFinca = riego.fincas?.nombre_finca || 'Sin finca';
            if (!datosPorFinca[nombreFinca]) {
              datosPorFinca[nombreFinca] = [];
            }
            datosPorFinca[nombreFinca].push(riego);
          });

          // Generar HTML para cada finca
          const sectionesHTML = Object.keys(datosPorFinca).map(nombreFinca => {
            const riegosFinca = datosPorFinca[nombreFinca];
            return `
              <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                  <h5 class="mb-0">
                    <i class="bi bi-geo-alt-fill me-2"></i>
                    ${nombreFinca}
                  </h5>
                  <small>${riegosFinca.length} registro(s) de riego</small>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                      <thead class="table-light">
                        <tr>
                          <th>Fecha</th>
                          <th>Cuartel</th>
                          <th>Regador</th>
                          <th>Horas</th>
                          <th>Volumen (L)</th>
                          <th>Objetivo</th>
                          <th>Observaciones</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${riegosFinca.map(riego => `
                          <tr>
                            <td>${riego.fecha || '-'}</td>
                            <td>${riego.cuarteles?.nombre || '-'}</td>
                            <td>${riego.aplicadores_operarios ? 
                              `${riego.aplicadores_operarios.apellido || ''}, ${riego.aplicadores_operarios.nombre}`.replace(/^, /, '') : '-'}</td>
                            <td>${riego.horas_riego || '-'}</td>
                            <td>${riego.volumen_agua || '-'}</td>
                            <td>${riego.objetivo || '-'}</td>
                            <td>${riego.observaciones || '-'}</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            `;
          }).join('');

          contenedor.html(sectionesHTML);
        } else {
          // Reporte por regador - tabla Ãºnica
          const tabla = `
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="table-primary">
                  <tr>
                    <th>Fecha</th>
                    <th>Finca</th>
                    <th>Cuartel</th>
                    <th>Regador</th>
                    <th>Horas</th>
                    <th>Volumen (L)</th>
                    <th>Objetivo</th>
                    <th>Observaciones</th>
                  </tr>
                </thead>
                <tbody>
                  ${datos.map(riego => `
                    <tr>
                      <td>${riego.fecha || '-'}</td>
                      <td>${riego.fincas?.nombre_finca || '-'}</td>
                      <td>${riego.cuarteles?.nombre || '-'}</td>
                      <td>${riego.aplicadores_operarios ? 
                        `${riego.aplicadores_operarios.apellido || ''}, ${riego.aplicadores_operarios.nombre}`.replace(/^, /, '') : '-'}</td>
                      <td>${riego.horas_riego || '-'}</td>
                      <td>${riego.volumen_agua || '-'}</td>
                      <td>${riego.objetivo || '-'}</td>
                      <td>${riego.observaciones || '-'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;

          contenedor.html(tabla);
        }
        
        // Guardar datos para exportaciÃ³n
        window.ultimoReporte = datos;
        window.ultimoTipo = tipo;
      }

      // Funciones de exportaciÃ³n
      function exportarExcel() {
        if (!window.ultimoReporte || window.ultimoReporte.length === 0) {
          alert('No hay datos para exportar');
          return;
        }

        const datos = window.ultimoReporte.map(riego => ({
          'Fecha': riego.fecha || '',
          'Finca': riego.fincas?.nombre_finca || '',
          'Cuartel': riego.cuarteles?.nombre || '',
          'Regador': riego.aplicadores_operarios ? 
            `${riego.aplicadores_operarios.apellido || ''}, ${riego.aplicadores_operarios.nombre}`.replace(/^, /, '') : '',
          'Horas': riego.horas_riego || '',
          'Volumen (L)': riego.volumen_agua || '',
          'Objetivo': riego.objetivo || '',
          'Observaciones': riego.observaciones || ''
        }));

        const ws = XLSX.utils.json_to_sheet(datos);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Riegos');
        
        const nombreArchivo = `reporte_riegos_${window.ultimoTipo}_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, nombreArchivo);
      }

      function exportarCSV() {
        if (!window.ultimoReporte || window.ultimoReporte.length === 0) {
          alert('No hay datos para exportar');
          return;
        }

        const headers = ['Fecha', 'Finca', 'Cuartel', 'Regador', 'Horas', 'Volumen (L)', 'Objetivo', 'Observaciones'];
        const csvContent = [
          headers.join(','),
          ...window.ultimoReporte.map(riego => [
            riego.fecha || '',
            `"${riego.fincas?.nombre_finca || ''}"`,
            `"${riego.cuarteles?.nombre || ''}"`,
            `"${riego.aplicadores_operarios ? 
              `${riego.aplicadores_operarios.apellido || ''}, ${riego.aplicadores_operarios.nombre}`.replace(/^, /, '') : ''}"`,
            riego.horas_riego || '',
            riego.volumen_agua || '',
            `"${riego.objetivo || ''}"`,
            `"${riego.observaciones || ''}"`
          ].join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `reporte_riegos_${window.ultimoTipo}_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      async function exportarPDF() {
        if (!window.ultimoReporte || window.ultimoReporte.length === 0) {
          alert('No hay datos para exportar');
          return;
        }

        // FunciÃ³n para convertir imagen a base64
        function convertirImagenABase64(url) {
          return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = function() {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              canvas.width = this.width;
              canvas.height = this.height;
              ctx.drawImage(this, 0, 0);
              const dataURL = canvas.toDataURL('image/png');
              resolve(dataURL);
            };
            img.onerror = reject;
            img.src = url;
          });
        }

        // FunciÃ³n para limpiar caracteres especiales que pueden causar problemas en PDF
        function limpiarTexto(texto) {
          if (!texto) return '';
          return String(texto)
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '') // Remover acentos
            .replace(/[^\w\s\-,\.]/g, '') // Remover caracteres especiales excepto bÃ¡sicos
            .trim();
        }

        try {
          // Obtener datos de la organizaciÃ³n y usuario actual
          const [orgResult, userResult] = await Promise.all([
            supabase.from('organizaciones').select('nombre, logo_url').limit(1).single(),
            supabase.auth.getUser()
          ]);

          const nombreOrganizacion = orgResult.data?.nombre || 'OrganizaciÃ³n';
          const logoUrl = orgResult.data?.logo_url;
          const { data: { user } } = userResult;
          
          // Obtener datos del productor desde la tabla usuarios
          let nombreProductor = 'Sin nombre';
          console.log('Usuario actual:', user); // Debug
          
          if (user) {
            const { data: perfilData, error: perfilError } = await supabase
              .from('usuarios')
              .select('nombre')  // Solo nombre, no apellido (campo no existe en BD)
              .eq('id', user.id)
              .single();
            
            console.log('Datos del perfil:', perfilData, 'Error:', perfilError); // Debug
            
            if (perfilData && perfilData.nombre) {
              nombreProductor = perfilData.nombre;
            }
          }

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          
          // Configurar encoding para caracteres especiales
          doc.setLanguage("es");
          
          // Configurar encabezado con logo y datos de la organizaciÃ³n
          let yPosition = 20; // Reducir espacio inicial
          
          // Intentar cargar y mostrar el logo real
          try {
            const logoBase64 = await convertirImagenABase64('./logo.png');
            // Agregar logo real al PDF
            doc.addImage(logoBase64, 'PNG', 20, yPosition - 8, 25, 12);
          } catch (error) {
            console.log('No se pudo cargar el logo, usando placeholder:', error);
            // Fallback: rectÃ¡ngulo como placeholder del logo
            doc.setFillColor(240, 240, 240); // Gris claro
            doc.rect(20, yPosition - 8, 25, 12, 'F'); // RectÃ¡ngulo relleno
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text('LOGO', 28, yPosition - 2);
            doc.setTextColor(0, 0, 0); // Volver a negro
          }
          
          // Nombre de la organizaciÃ³n (a la derecha del logo)
          doc.setFontSize(14); // Cambiar de 16 a 14pt
          doc.setFont(undefined, 'bold');
          doc.text(limpiarTexto(nombreOrganizacion), 50, yPosition);
          
          yPosition += 10; // Reducir espacio
          doc.setFontSize(12); // Mantener 12pt para productor
          doc.setFont(undefined, 'normal');
          doc.text(`Productor: ${limpiarTexto(nombreProductor)}`, 20, yPosition);
          
          yPosition += 10; // Reducir espacio
          doc.setFontSize(10); // Cambiar de 14 a 10pt
          doc.setFont(undefined, 'bold');
          doc.text(`Reporte de Riegos por ${window.ultimoTipo === 'finca' ? 'Finca' : 'Regador'}`, 20, yPosition);
          
          yPosition += 8; // Reducir espacio
          doc.setFontSize(9); // Cambiar de 10 a 9pt
          doc.setFont(undefined, 'normal');
          doc.text(`Generado: ${new Date().toLocaleDateString('es-ES')} - ${new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}`, 20, yPosition);
          
          yPosition += 12; // Reducir espacio

          // Si es reporte por finca, agrupar por finca
          if (window.ultimoTipo === 'finca') {
            // Agrupar datos por finca
            const datosPorFinca = {};
            window.ultimoReporte.forEach(riego => {
              const nombreFinca = riego.fincas?.nombre_finca || 'Sin finca';
              if (!datosPorFinca[nombreFinca]) {
                datosPorFinca[nombreFinca] = [];
              }
              datosPorFinca[nombreFinca].push(riego);
            });

            // Generar PDF agrupado por finca
            Object.keys(datosPorFinca).forEach((nombreFinca, fincaIndex) => {
              if (fincaIndex > 0 || yPosition > 100) {
                doc.addPage();
                yPosition = 20;
              }

              // Encabezado de finca
              doc.setFontSize(14);
              doc.setFont(undefined, 'bold');
              // Reemplazar emoji por texto simple para evitar problemas de encoding
              doc.text(`FINCA: ${limpiarTexto(nombreFinca)}`, 20, yPosition);
              yPosition += 5;
              
              doc.setFontSize(10);
              doc.setFont(undefined, 'normal');
              doc.text(`${datosPorFinca[nombreFinca].length} registro(s) de riego`, 20, yPosition);
              yPosition += 10;

              // Headers de tabla para esta finca
              const headers = ['Fecha', 'Cuartel', 'Regador', 'Horas', 'Volumen (L)', 'Objetivo', 'Observaciones'];
              doc.setFontSize(8);
              doc.setFont(undefined, 'bold');
              let xPosition = 20;
              const columnWidths = [25, 25, 30, 15, 20, 25, 35];
              
              headers.forEach((header, index) => {
                doc.text(header, xPosition, yPosition);
                xPosition += columnWidths[index];
              });
              
              yPosition += 8;
              doc.setFont(undefined, 'normal');

              // Datos de la finca
              datosPorFinca[nombreFinca].forEach(riego => {
                if (yPosition > 270) {
                  doc.addPage();
                  yPosition = 20;
                }
                
                xPosition = 20;
                const rowData = [
                  limpiarTexto(riego.fecha || ''),
                  limpiarTexto(riego.cuarteles?.nombre || ''),
                  limpiarTexto(riego.aplicadores_operarios ? 
                    `${riego.aplicadores_operarios.apellido || ''}, ${riego.aplicadores_operarios.nombre}`.replace(/^, /, '') : ''),
                  limpiarTexto(riego.horas_riego || ''),
                  limpiarTexto(riego.volumen_agua || ''),
                  limpiarTexto(riego.objetivo || ''),
                  limpiarTexto(riego.observaciones || '')
                ];
                
                rowData.forEach((cell, index) => {
                  const maxLength = index === 6 ? 20 : 12; // Observaciones pueden ser mÃ¡s largas
                  const text = limpiarTexto(String(cell)).substring(0, maxLength);
                  doc.text(text, xPosition, yPosition);
                  xPosition += columnWidths[index];
                });
                yPosition += 6;
              });
              
              yPosition += 10; // Espacio entre fincas
            });
          } else {
            // Reporte por regador - tabla Ãºnica
            const tableData = window.ultimoReporte.map(riego => [
              limpiarTexto(riego.fecha || ''),
              limpiarTexto(riego.fincas?.nombre_finca || ''),
              limpiarTexto(riego.cuarteles?.nombre || ''),
              limpiarTexto(riego.aplicadores_operarios ? 
                `${riego.aplicadores_operarios.apellido || ''}, ${riego.aplicadores_operarios.nombre}`.replace(/^, /, '') : ''),
              limpiarTexto(riego.horas_riego || ''),
              limpiarTexto(riego.volumen_agua || ''),
              limpiarTexto(riego.objetivo || ''),
              limpiarTexto(riego.observaciones || '')
            ]);

            // Headers
            const headers = ['Fecha', 'Finca', 'Cuartel', 'Regador', 'Horas', 'Volumen', 'Objetivo', 'Observaciones'];
            doc.setFontSize(8);
            doc.setFont(undefined, 'bold');
            let xPosition = 20;
            const columnWidths = [22, 22, 22, 25, 15, 18, 22, 30];
            
            headers.forEach((header, index) => {
              doc.text(header, xPosition, yPosition);
              xPosition += columnWidths[index];
            });
            
            yPosition += 8;
            doc.setFont(undefined, 'normal');
            
            // Datos
            tableData.forEach(row => {
              if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
              }
              
              xPosition = 20;
              row.forEach((cell, index) => {
                const maxLength = index === 7 ? 18 : 12;
                const text = limpiarTexto(String(cell)).substring(0, maxLength);
                doc.text(text, xPosition, yPosition);
                xPosition += columnWidths[index];
              });
              yPosition += 6;
            });
          }

          // Guardar PDF
          const fechaHora = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
          doc.save(`${nombreOrganizacion}_Riegos_${window.ultimoTipo}_${nombreProductor}_${fechaHora}.pdf`);
          
        } catch (error) {
          console.error('Error generando PDF:', error);
          alert('Error al generar el PDF: ' + error.message);
        }
      }

      // Hacer funciones globales
      window.cargarFincas = cargarFincas;
      window.cargarRegadores = cargarRegadores;
      window.generarReporteFinca = generarReporteFinca;
      window.generarReporteRegador = generarReporteRegador;
    </script>
  </body>
</html>