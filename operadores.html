<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Operadores | Cuaderno de Campo</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Google Fonts Roboto -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
    <!-- Tu CSS personalizado -->
    <link rel="stylesheet" href="estilos.css">
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    .tabla-operadores-boton {
      font-size: 0.85em;
      padding: 2px 4px;
      border-radius: 4px;
      line-height: 1.2;
      margin: 0 1px;
      min-width: 48px;
      max-width: 64px;
      white-space: nowrap;
    }
    .logo-contraste {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      max-height: 56px;
      max-width: 120px;
      display: block;
    }
  </style>
  </head>
  <body>
    <div id="header-container"></div>
    <script>
      // Mejora contraste del logo si existe en el header
      document.addEventListener('DOMContentLoaded', () => {
        const observer = new MutationObserver(() => {
          const logo = document.querySelector('#header-container img[src="logo.png"]');
          if (logo && !logo.classList.contains('logo-contraste')) {
            logo.classList.add('logo-contraste');
          }
        });
        observer.observe(document.getElementById('header-container'), { childList: true, subtree: true });
      });
    </script>
    <script type="module">
      import { supabase } from "./supabaseClient.js";
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = "login-nuevo.html";
        throw new Error("No autorizado");
      }
      fetch('header.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('header-container').innerHTML = html;
          import('./header.js');
        });
    </script>

    <main class="container">
      <div class="container-fluid bg-light py-3 mb-4">
        <div class="container">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="h3 mb-1 text-primary font-weight-bold">
                <i class="bi bi-person-badge text-success me-2"></i>
                Gestión de Operadores
              </h1>
              <p class="text-muted mb-0">Administra los operadores y aplicadores</p>
            </div>
            <div class="d-flex align-items-center">
              <button id="toggle-form" class="btn btn-primary" type="button" style="background-color: #007bff !important; border-color: #007bff !important; color: #ffffff !important; font-weight: 600; box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);">
                <i class="bi bi-plus-circle me-1"></i> Agregar Operador
              </button>
            </div>
          </div>
        </div>
      </div>
      <div id="form-container" class="card-body" style="display:none;">
          <form id="operador-form" class="mb-0">
            <div class="row g-2">
              <div class="col-md-6">
                <label for="nombre" class="form-label">Nombre</label>
                <input type="text" id="nombre" name="nombre" class="form-control" required placeholder="Nombre del operador" />
              </div>
              <div class="col-md-6">
                <label for="apellido" class="form-label">Apellido</label>
                <input type="text" id="apellido" name="apellido" class="form-control" required placeholder="Apellido del operador" />
              </div>
              <div class="col-md-6">
                <label for="cuit" class="form-label">CUIT</label>
                <input type="text" id="cuit" name="cuit" class="form-control" placeholder="CUIT" />
              </div>
              <div class="col-md-6">
                <label for="telefono" class="form-label">Teléfono</label>
                <input type="text" id="telefono" name="telefono" class="form-control" placeholder="Teléfono" />
              </div>
              <div class="col-md-6">
                <label for="direccion" class="form-label">Dirección</label>
                <input type="text" id="direccion" name="direccion" class="form-control" placeholder="Dirección" />
              </div>
              <div class="col-md-6">
                <label for="rol" class="form-label">Rol</label>
                <select id="rol" name="rol" class="form-control" required>
                  <option value="operario">Operario</option>
                  <option value="aplicador">Aplicador</option>
                </select>
              </div>
            </div>
            <div class="mt-3">
            <button type="submit" class="btn btn-primary w-100 fw-bold d-flex align-items-center justify-content-center" style="background-color: #007bff !important; border-color: #007bff !important; color: #fff !important; font-weight: 600; box-shadow: 0 2px 4px rgba(0,123,255,0.2); font-size:1rem; gap:6px;">
              <i class="bi bi-plus-circle me-1"></i> Agregar Operador
            </button>
            </div>
          </form>
        </div>
      </div>
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <span class="fw-bold" style="font-size:1.1rem;"><i class="bi bi-list-ul me-2"></i>Lista de operadores</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
              <thead class="table-primary">
                <tr>
                  <th>Nombre</th>
                  <th>Apellido</th>
                  <th>CUIT</th>
                  <th>Teléfono</th>
                  <th>Dirección</th>
                  <th>Rol</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="operadores-list"></tbody>
            </table>
          </div>
        </div>
        <div class="card-footer bg-white border-0">
          <p id="status" class="mt-2 mb-0"></p>
        </div>
      </div>
    </main>

    <footer class="container">
      <small><a href="#">Privacidad</a> • <a href="#">Términos</a></small>
    </footer>

    <script type="module">
      import { supabase } from "./supabaseClient.js";

      const operadorForm = document.getElementById("operador-form");
      const operadoresList = document.getElementById("operadores-list");
      const status = document.getElementById("status");

      // Obtener usuario logueado
      let userId = null;
      (async () => {
        const { data: { user } } = await supabase.auth.getUser();
        userId = user.id;
        cargarOperadores();
      })();

      // Cargar operadores del usuario (con edición inline)
      async function cargarOperadores() {
        operadoresList.innerHTML = "";
        if (!userId) return;
        const { data, error } = await supabase
          .from("aplicadores_operarios")
          .select('id,nombre,apellido,cuit,telefono,direccion,rol,usuario_id')
          .eq("usuario_id", userId)
          .order("nombre", { ascending: true });
        if (error) {
          status.textContent = "Error al cargar operadores";
          return;
        }
        for (const op of data) {
          operadoresList.innerHTML += `
            <tr data-id="${op.id}">
              <td><span class="view">${op.nombre}</span><input class="edit" type="text" value="${op.nombre}" style="display:none;width:100%"></td>
              <td><span class="view">${op.apellido}</span><input class="edit" type="text" value="${op.apellido}" style="display:none;width:100%"></td>
              <td><span class="view">${op.cuit || ""}</span><input class="edit" type="text" value="${op.cuit || ""}" style="display:none;width:100%"></td>
              <td><span class="view">${op.telefono || ""}</span><input class="edit" type="text" value="${op.telefono || ""}" style="display:none;width:100%"></td>
              <td><span class="view">${op.direccion || ""}</span><input class="edit" type="text" value="${op.direccion || ""}" style="display:none;width:100%"></td>
              <td>
                <span class="view">${op.rol}</span>
                <select class="edit" style="display:none;width:100%">
                  <option value="operario" ${op.rol === "operario" ? "selected" : ""}>Operario</option>
                  <option value="aplicador" ${op.rol === "aplicador" ? "selected" : ""}>Aplicador</option>
                </select>
              </td>
              <td style="display:flex; gap:12px; justify-content:center; align-items:center;">
                <button class="editar tabla-operadores-boton" data-id="${op.id}">Editar</button>
                <button class="guardar tabla-operadores-boton" data-id="${op.id}" style="display:none">Guardar</button>
                <button class="cancelar tabla-operadores-boton" data-id="${op.id}" style="display:none">Cancelar</button>
                <button class="eliminar tabla-operadores-boton" data-id="${op.id}">Eliminar</button>
              </td>
            </tr>
          `;
        }
      }

      // Agregar operador
      operadorForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        status.textContent = "Agregando...";
        const form = e.target;
        if (!userId) {
          status.textContent = "Usuario no identificado";
          return;
        }
        const nuevo = {
          nombre: form.nombre.value,
          apellido: form.apellido.value,
          cuit: form.cuit.value,
          telefono: form.telefono.value,
          direccion: form.direccion.value,
          rol: form.rol.value,
          usuario_id: userId
        };
        const { error } = await supabase.from("aplicadores_operarios").insert([nuevo]);
        if (error) {
          status.textContent = "❌ Error al agregar: " + error.message;
        } else {
          status.textContent = "✅ Operador agregado";
          form.reset();
          cargarOperadores();
        }
      });

      // Manejar edición inline
      operadoresList.addEventListener("click", async (e) => {
        const tr = e.target.closest("tr");
        if (!tr) return;
        const id = tr.dataset.id;

        // Editar
        if (e.target.classList.contains("editar")) {
          tr.querySelectorAll(".view").forEach(el => el.style.display = "none");
          tr.querySelectorAll(".edit").forEach(el => el.style.display = "");
          tr.querySelector(".editar").style.display = "none";
          tr.querySelector(".guardar").style.display = "";
          tr.querySelector(".cancelar").style.display = "";
        }

        // Cancelar
        if (e.target.classList.contains("cancelar")) {
          tr.querySelectorAll(".view").forEach(el => el.style.display = "");
          tr.querySelectorAll(".edit").forEach(el => el.style.display = "none");
          tr.querySelector(".editar").style.display = "";
          tr.querySelector(".guardar").style.display = "none";
          tr.querySelector(".cancelar").style.display = "none";
        }

        // Guardar
        if (e.target.classList.contains("guardar")) {
          const edits = tr.querySelectorAll('.edit');
          const nombre = edits[0].value;
          const apellido = edits[1].value;
          const cuit = edits[2].value;
          const telefono = edits[3].value;
          const direccion = edits[4].value;
          const rol = edits[5].value;
          status.textContent = "Actualizando...";
          const { error } = await supabase.from("aplicadores_operarios")
            .update({ nombre, apellido, cuit, telefono, direccion, rol })
            .eq("id", id);
          if (error) {
            status.textContent = "❌ Error al actualizar";
          } else {
            status.textContent = "✅ Operador actualizado";
            cargarOperadores();
          }
        }

        // Eliminar (ya estaba implementado)
        if (e.target.classList.contains("eliminar")) {
          if (confirm("¿Eliminar este operador?")) {
            const { error } = await supabase.from("aplicadores_operarios").delete().eq("id", id);
            if (error) status.textContent = "❌ Error al eliminar";
            else {
              status.textContent = "✅ Operador eliminado";
              cargarOperadores();
            }
          }
        }
      });

      // Mostrar/Ocultar formulario
      const toggleFormBtn = document.getElementById("toggle-form");
      const formContainer = document.getElementById("form-container");

      // Mostrar/ocultar formulario de agregar operador
      toggleFormBtn.addEventListener("click", () => {
        if (formContainer.style.display === "none") {
          formContainer.style.display = "block";
          toggleFormBtn.innerHTML = '<i class="bi bi-x-circle"></i> Cerrar';
        } else {
          formContainer.style.display = "none";
          toggleFormBtn.innerHTML = '<i class="bi bi-person-plus"></i> Agregar operador';
        }
      });
    </script>
  </body>
</html>