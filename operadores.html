<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Operadores | Cuaderno de Campo</title>
    <!-- Bootstrap 4 -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <!-- Bootstrap Select -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.18/dist/css/bootstrap-select.min.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- PicoCSS (opcional) -->
    <link href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" rel="stylesheet" />
    <!-- Google Fonts Roboto -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
    <!-- Tu CSS personalizado -->
    <link rel="stylesheet" href="estilos.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Bootstrap Select JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.18/dist/js/bootstrap-select.min.js"></script>
  <style>
    .tabla-operadores-boton {
      font-size: 0.85em;
      padding: 2px 4px;
      border-radius: 4px;
      line-height: 1.2;
      margin: 0 1px;
      min-width: 48px;
      max-width: 64px;
      white-space: nowrap;
    }
  </style>
  </head>
  <body>
    <div id="header-container"></div>
    <script type="module">
    import { supabase } from "./supabaseClient.js";
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      window.location.href = "login.html";
      throw new Error("No autorizado");
    }
      fetch('header.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('header-container').innerHTML = html;
          import('./header.js');
        });
    </script>

    <main class="container">
      <hgroup>
        <h2>Gestión de Operadores</h2>
        <h3>Agregue, edite o elimine sus operarios y aplicadores</h3>
      </hgroup>
      <form id="operador-form">
        <label for="nombre">Nombre</label>
        <input type="text" id="nombre" name="nombre" required />

        <label for="apellido">Apellido</label>
        <input type="text" id="apellido" name="apellido" required />

        <label for="cuit">CUIT</label>
        <input type="text" id="cuit" name="cuit" />

        <label for="telefono">Teléfono</label>
        <input type="text" id="telefono" name="telefono" />

        <label for="direccion">Dirección</label>
        <input type="text" id="direccion" name="direccion" />

        <label for="rol">Rol</label>
        <select id="rol" name="rol" required>
          <option value="operario">Operario</option>
          <option value="aplicador">Aplicador</option>
        </select>

        <button type="submit">Agregar Operador</button>
      </form>

      <hr />
      <h3>Lista de operadores</h3>
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Apellido</th>
            <th>CUIT</th>
            <th>Teléfono</th>
            <th>Dirección</th>
            <th>Rol</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="operadores-list"></tbody>
      </table>
      <p id="status"></p>
    </main>

    <footer class="container">
      <small><a href="#">Privacidad</a> • <a href="#">Términos</a></small>
    </footer>

    <script type="module">
      import { supabase } from "./supabaseClient.js";

      const operadorForm = document.getElementById("operador-form");
      const operadoresList = document.getElementById("operadores-list");
      const status = document.getElementById("status");

      // Obtener usuario logueado
      let userId = null;
      (async () => {
        const { data: { user } } = await supabase.auth.getUser();
        userId = user.id;
        cargarOperadores();
      })();

      // Cargar operadores del usuario (con edición inline)
      async function cargarOperadores() {
        operadoresList.innerHTML = "";
        if (!userId) return;
        const { data, error } = await supabase
          .from("aplicadores_operarios")
          .select('id,nombre,apellido,cuit,telefono,direccion,rol,usuario_id')
          .eq("usuario_id", userId)
          .order("nombre", { ascending: true });
        if (error) {
          status.textContent = "Error al cargar operadores";
          return;
        }
        for (const op of data) {
          operadoresList.innerHTML += `
            <tr data-id="${op.id}">
              <td><span class="view">${op.nombre}</span><input class="edit" type="text" value="${op.nombre}" style="display:none;width:100%"></td>
              <td><span class="view">${op.apellido}</span><input class="edit" type="text" value="${op.apellido}" style="display:none;width:100%"></td>
              <td><span class="view">${op.cuit || ""}</span><input class="edit" type="text" value="${op.cuit || ""}" style="display:none;width:100%"></td>
              <td><span class="view">${op.telefono || ""}</span><input class="edit" type="text" value="${op.telefono || ""}" style="display:none;width:100%"></td>
              <td><span class="view">${op.direccion || ""}</span><input class="edit" type="text" value="${op.direccion || ""}" style="display:none;width:100%"></td>
              <td>
                <span class="view">${op.rol}</span>
                <select class="edit" style="display:none;width:100%">
                  <option value="operario" ${op.rol === "operario" ? "selected" : ""}>Operario</option>
                  <option value="aplicador" ${op.rol === "aplicador" ? "selected" : ""}>Aplicador</option>
                </select>
              </td>
              <td style="display:flex; gap:12px; justify-content:center; align-items:center;">
                <button class="editar tabla-operadores-boton" data-id="${op.id}">Editar</button>
                <button class="guardar tabla-operadores-boton" data-id="${op.id}" style="display:none">Guardar</button>
                <button class="cancelar tabla-operadores-boton" data-id="${op.id}" style="display:none">Cancelar</button>
                <button class="eliminar tabla-operadores-boton" data-id="${op.id}">Eliminar</button>
              </td>
            </tr>
          `;
        }
      }

      // Agregar operador
      operadorForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        status.textContent = "Agregando...";
        const form = e.target;
        if (!userId) {
          status.textContent = "Usuario no identificado";
          return;
        }
        const nuevo = {
          nombre: form.nombre.value,
          apellido: form.apellido.value,
          cuit: form.cuit.value,
          telefono: form.telefono.value,
          direccion: form.direccion.value,
          rol: form.rol.value,
          usuario_id: userId
        };
        const { error } = await supabase.from("aplicadores_operarios").insert([nuevo]);
        if (error) {
          status.textContent = "❌ Error al agregar: " + error.message;
        } else {
          status.textContent = "✅ Operador agregado";
          form.reset();
          cargarOperadores();
        }
      });

      // Manejar edición inline
      operadoresList.addEventListener("click", async (e) => {
        const tr = e.target.closest("tr");
        if (!tr) return;
        const id = tr.dataset.id;

        // Editar
        if (e.target.classList.contains("editar")) {
          tr.querySelectorAll(".view").forEach(el => el.style.display = "none");
          tr.querySelectorAll(".edit").forEach(el => el.style.display = "");
          tr.querySelector(".editar").style.display = "none";
          tr.querySelector(".guardar").style.display = "";
          tr.querySelector(".cancelar").style.display = "";
        }

        // Cancelar
        if (e.target.classList.contains("cancelar")) {
          tr.querySelectorAll(".view").forEach(el => el.style.display = "");
          tr.querySelectorAll(".edit").forEach(el => el.style.display = "none");
          tr.querySelector(".editar").style.display = "";
          tr.querySelector(".guardar").style.display = "none";
          tr.querySelector(".cancelar").style.display = "none";
        }

        // Guardar
        if (e.target.classList.contains("guardar")) {
          const edits = tr.querySelectorAll('.edit');
          const nombre = edits[0].value;
          const apellido = edits[1].value;
          const cuit = edits[2].value;
          const telefono = edits[3].value;
          const direccion = edits[4].value;
          const rol = edits[5].value;
          status.textContent = "Actualizando...";
          const { error } = await supabase.from("aplicadores_operarios")
            .update({ nombre, apellido, cuit, telefono, direccion, rol })
            .eq("id", id);
          if (error) {
            status.textContent = "❌ Error al actualizar";
          } else {
            status.textContent = "✅ Operador actualizado";
            cargarOperadores();
          }
        }

        // Eliminar (ya estaba implementado)
        if (e.target.classList.contains("eliminar")) {
          if (confirm("¿Eliminar este operador?")) {
            const { error } = await supabase.from("aplicadores_operarios").delete().eq("id", id);
            if (error) status.textContent = "❌ Error al eliminar";
            else {
              status.textContent = "✅ Operador eliminado";
              cargarOperadores();
            }
          }
        }
      });
    </script>
  </body>
</html>