<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fitosanitarios | Cuaderno de Campo</title>
    <link href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" rel="stylesheet" />
    <style>
      .fitos-btn {
        font-size: 0.85em;
        padding: 2px 10px;
        border-radius: 4px;
        line-height: 1.2;
        margin: 0 4px;
      }
      .fitos-btn + .fitos-btn {
        margin-left: 8px;
      }
      .fitos-search {
        display: flex;
        flex-wrap: wrap;
        gap: 1em;
        margin-bottom: 1em;
      }
      .fitos-search input {
        min-width: 180px;
      }
    </style>
  </head>
  <body>
    <div id="header-container"></div>
    <script type="module">
      fetch('header.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('header-container').innerHTML = html;
          import('./header.js');
        });
    </script>

    <main class="container">
      <hgroup>
        <h2>Gestión de Fitosanitarios</h2>
        <h3>Agregue, edite, elimine y busque fitosanitarios</h3>
      </hgroup>
      <form id="fitosanitario-form">
        <label for="nombre_comercial">Nombre comercial</label>
        <input type="text" id="nombre_comercial" name="nombre_comercial" required />

        <label for="principio_activo">Principio activo</label>
        <input type="text" id="principio_activo" name="principio_activo" required />

        <label for="formulacion">Formulación</label>
        <input type="text" id="formulacion" name="formulacion" />

        <label for="plaga_o_enfermedad">Plaga o enfermedad</label>
        <input type="text" id="plaga_o_enfermedad" name="plaga_o_enfermedad" />

        <label for="accion">Acción</label>
        <input type="text" id="accion" name="accion" />

        <label for="tc_tiempo_carencia">TC (tiempo de carencia)</label>
        <input type="text" id="tc_tiempo_carencia" name="tc_tiempo_carencia" />

        <label for="ct">CT</label>
        <input type="text" id="ct" name="ct" />

        <label for="dosis_marbete">Dosis de marbete</label>
        <input type="text" id="dosis_marbete" name="dosis_marbete" />

        <label for="unidad_marbete">Unidad de marbete</label>
        <input type="text" id="unidad_marbete" name="unidad_marbete" />

        <label for="lmr_senasa">LMR Senasa</label>
        <input type="text" id="lmr_senasa" name="lmr_senasa" />

        <label for="lmr_eu">LMR EU</label>
        <input type="text" id="lmr_eu" name="lmr_eu" />

        <label for="uso">Uso</label>
        <input type="text" id="uso" name="uso" />

        <label for="dosis_frecuente_100l">Dosis más frecuente 100 L de agua</label>
        <input type="text" id="dosis_frecuente_100l" name="dosis_frecuente_100l" />

        <label for="registro_para">Registro para (especies)</label>
        <input type="text" id="registro_para" name="registro_para" />

        <button type="submit">Agregar fitosanitario</button>
      </form>

      <hr />
      <h3>Búsqueda de fitosanitarios</h3>
      <div class="fitos-search">
        <input type="text" id="busca_nombre" placeholder="Nombre comercial..." />
        <input type="text" id="busca_pa" placeholder="Principio activo..." />
        <input type="text" id="busca_plaga" placeholder="Plaga o enfermedad..." />
        <input type="text" id="busca_registro" placeholder="Registro para..." />
        <button id="buscarBtn" type="button">Buscar</button>
        <button id="limpiarBtn" type="button">Limpiar</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Nombre comercial</th>
            <th>Principio activo</th>
            <th>Formulación</th>
            <th>Plaga o enfermedad</th>
            <th>Acción</th>
            <th>Dosis marbete</th>
      <table id="fitosanitariosTable" style="font-size:0.92em;">
            <th>Dosis más frecuente 100L</th>
            <th>TC</th>
            <th>CT</th>
            <th>LMR Senasa</th>
            <th>LMR EU</th>
            <th>Uso</th>
            <th>Registro para</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="fitos-list"></tbody>
      </table>
      <p id="status"></p>
    </main>

    <footer class="container">
      <small><a href="#">Privacidad</a> • <a href="#">Términos</a></small>
    </footer>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
      const supabase = createClient(
        "https://djvdjulfeuqohpnatdmt.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdmRqdWxmZXVxb2hwbmF0ZG10Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzNTYyMTEsImV4cCI6MjA2NzkzMjIxMX0.aD_klISxuwoGxMYtPq6XPARva8D32YkKFu7s_Ffq0fw"
      );

      const fitosForm = document.getElementById("fitosanitario-form");
      const fitosList = document.getElementById("fitos-list");
      const status = document.getElementById("status");
      const buscaNombre = document.getElementById("busca_nombre");
      const buscaPA = document.getElementById("busca_pa");
      const buscaPlaga = document.getElementById("busca_plaga");
      const buscaRegistro = document.getElementById("busca_registro");
      const buscarBtn = document.getElementById("buscarBtn");
      const limpiarBtn = document.getElementById("limpiarBtn");

      // Cargar fitosanitarios (con filtros)
      async function cargarFitos() {
        fitosList.innerHTML = "";
        let query = supabase.from("fitosanitarios").select("id,nombre_comercial,principio_activo,formulacion,plaga_o_enfermedad,accion,dosis_marbete,unidad_marbete,dosis_frecuente_100l,tc_tiempo_carencia,ct,lmr_senasa,lmr_eu,uso,registro_para");
        if (buscaNombre.value) query = query.ilike("nombre_comercial", `%${buscaNombre.value}%`);
        if (buscaPA.value) query = query.ilike("principio_activo", `%${buscaPA.value}%`);
        if (buscaPlaga.value) query = query.ilike("plaga_o_enfermedad", `%${buscaPlaga.value}%`);
        if (buscaRegistro.value) query = query.ilike("registro_para", `%${buscaRegistro.value}%`);
        const { data, error } = await query.order("nombre_comercial", { ascending: true });
        if (error) {
          status.textContent = "Error al cargar fitosanitarios";
          return;
        }
        for (const f of data) {
          fitosList.innerHTML += `
            <tr data-id="${f.id}">
              <td><span class="view">${f.nombre_comercial}</span><input class="edit" type="text" value="${f.nombre_comercial}" style="display:none;width:100%"></td>
              <td><span class="view">${f.principio_activo}</span><input class="edit" type="text" value="${f.principio_activo}" style="display:none;width:100%"></td>
              <td><span class="view">${f.formulacion || ""}</span><input class="edit" type="text" value="${f.formulacion || ""}" style="display:none;width:100%"></td>
              <td><span class="view">${f.plaga_o_enfermedad || ""}</span><input class="edit" type="text" value="${f.plaga_o_enfermedad || ""}" style="display:none;width:100%"></td>
              <td><span class="view">${f.accion || ""}</span><input class="edit" type="text" value="${f.accion || ""}" style="display:none;width:100%"></td>
              <td><span class="view">${f.dosis_marbete || ""}</span><input class="edit" type="text" value="${f.dosis_marbete || ""}" style="display:none;width:100%"></td>
              <td><span class="view">${f.unidad_marbete || ""}</span><input class="edit" type="text" value="${f.unidad_marbete || ""}" style="display:none;width:100%"></td>
              <td><span class="view">${f.dosis_frecuente_100l || ""}</span><input class="edit" type="text" value="${f.dosis_frecuente_100l || ""}" style="display:none;width:100%"></td>
              <td><span class="view">${f.tc_tiempo_carencia || ""}</span><input class="edit" type="text" value="${f.tc_tiempo_carencia || ""}" style="display:none;width:100%"></td>
              <td><span class="view">${f.ct || ""}</span><input class="edit" type="text" value="${f.ct || ""}" style="display:none;width:100%"></td>
              <td><span class="view">${f.lmr_senasa || ""}</span><input class="edit" type="text" value="${f.lmr_senasa || ""}" style="display:none;width:100%"></td>
              <td><span class="view">${f.lmr_eu || ""}</span><input class="edit" type="text" value="${f.lmr_eu || ""}" style="display:none;width:100%"></td>
              <td><span class="view">${f.uso || ""}</span><input class="edit" type="text" value="${f.uso || ""}" style="display:none;width:100%"></td>
              <td><span class="view">${f.registro_para || ""}</span><input class="edit" type="text" value="${f.registro_para || ""}" style="display:none;width:100%"></td>
              <td>
                <button class="editar fitos-btn" data-id="${f.id}">Editar</button>
                <button class="guardar fitos-btn" data-id="${f.id}" style="display:none">Guardar</button>
                <button class="cancelar fitos-btn" data-id="${f.id}" style="display:none">Cancelar</button>
                <button class="eliminar fitos-btn" data-id="${f.id}">Eliminar</button>
              </td>
            </tr>
          `;
        }
      }

      buscarBtn.addEventListener("click", cargarFitos);
      limpiarBtn.addEventListener("click", () => {
        buscaNombre.value = "";
        buscaPA.value = "";
        buscaPlaga.value = "";
        buscaRegistro.value = "";
        cargarFitos();
      });

      // Agregar fitosanitario
      fitosForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        status.textContent = "Agregando...";
        const form = e.target;
        const nuevo = {
          nombre_comercial: form.nombre_comercial.value,
          principio_activo: form.principio_activo.value,
          formulacion: form.formulacion.value,
          plaga_o_enfermedad: form.plaga_o_enfermedad.value,
          accion: form.accion.value,
          tc_tiempo_carencia: form.tc_tiempo_carencia.value,
          ct: form.ct.value,
          dosis_marbete: form.dosis_marbete.value,
          unidad_marbete: form.unidad_marbete.value,
          lmr_senasa: form.lmr_senasa.value,
          lmr_eu: form.lmr_eu.value,
          uso: form.uso.value,
          dosis_frecuente_100l: form.dosis_frecuente_100l.value,
          registro_para: form.registro_para.value
        };
        const { error } = await supabase.from("fitosanitarios").insert([nuevo]);
        if (error) {
          status.textContent = "❌ Error al agregar: " + error.message;
        } else {
          status.textContent = "✅ Fitosanitario agregado";
          form.reset();
          cargarFitos();
        }
      });

      // Manejar edición inline
      fitosList.addEventListener("click", async (e) => {
        const tr = e.target.closest("tr");
        if (!tr) return;
        const id = tr.dataset.id;

        // Editar
        if (e.target.classList.contains("editar")) {
          tr.querySelectorAll(".view").forEach(el => el.style.display = "none");
          tr.querySelectorAll(".edit").forEach(el => el.style.display = "");
          tr.querySelector(".editar").style.display = "none";
          tr.querySelector(".guardar").style.display = "";
          tr.querySelector(".cancelar").style.display = "";
        }

        // Cancelar
        if (e.target.classList.contains("cancelar")) {
          tr.querySelectorAll(".view").forEach(el => el.style.display = "");
          tr.querySelectorAll(".edit").forEach(el => el.style.display = "none");
          tr.querySelector(".editar").style.display = "";
          tr.querySelector(".guardar").style.display = "none";
          tr.querySelector(".cancelar").style.display = "none";
        }

        // Guardar
        if (e.target.classList.contains("guardar")) {
          const edits = tr.querySelectorAll('.edit');
          const nombre_comercial = edits[0].value;
          const principio_activo = edits[1].value;
          const formulacion = edits[2].value;
          const plaga_o_enfermedad = edits[3].value;
          const accion = edits[4].value;
          const dosis_marbete = edits[5].value;
          const unidad_marbete = edits[6].value;
          const dosis_frecuente_100l = edits[7].value;
          const tc_tiempo_carencia = edits[8].value;
          const ct = edits[9].value;
          const lmr_senasa = edits[10].value;
          const lmr_eu = edits[11].value;
          const uso = edits[12].value;
          const registro_para = edits[13].value;
          status.textContent = "Actualizando...";
          const { error } = await supabase.from("fitosanitarios")
            .update({ nombre_comercial, principio_activo, formulacion, plaga_o_enfermedad, accion, dosis_marbete, unidad_marbete, dosis_frecuente_100l, tc_tiempo_carencia, ct, lmr_senasa, lmr_eu, uso, registro_para })
            .eq("id", id);
          if (error) {
            status.textContent = "❌ Error al actualizar";
          } else {
            status.textContent = "✅ Fitosanitario actualizado";
            cargarFitos();
          }
        }

        // Eliminar
        if (e.target.classList.contains("eliminar")) {
          if (confirm("¿Eliminar este fitosanitario?")) {
            const { error } = await supabase.from("fitosanitarios").delete().eq("id", id);
            if (error) status.textContent = "❌ Error al eliminar";
            else {
              status.textContent = "✅ Fitosanitario eliminado";
              cargarFitos();
            }
          }
        }
      });

      // Cargar al inicio
      cargarFitos();
    </script>
  </body>
</html>
