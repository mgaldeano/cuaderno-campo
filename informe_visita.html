<!DOCTYPE html>
<html lang="es">
  <head>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Select CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
    <!-- Google Fonts Roboto -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Tu CSS personalizado -->
    <link rel="stylesheet" href="estilos.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Bootstrap Select JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Registrar Informe de Ingeniero | Cuaderno de Campo</title>
    
    <style>
    .logo-contraste {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      max-height: 56px;
      max-width: 120px;
      display: block;
    }
      .form-visita {
        max-width: 600px;
        margin: 2em auto;
        padding: 2em;
        background: #f9f9f9;
        border-radius: 8px;
        box-shadow: 0 2px 8px #0001;
      }
      .form-visita label { margin-top: 1em; }
      .form-visita .entidad-group { display: flex; gap: 1em; flex-wrap: wrap; }
    </style>
  </head>
  <body>
    <div id="header-container"></div>
    <script>
      // Mejora contraste del logo si existe en el header
      document.addEventListener('DOMContentLoaded', () => {
        const observer = new MutationObserver(() => {
          const logo = document.querySelector('#header-container img[src="logo.png"]');
          if (logo && !logo.classList.contains('logo-contraste')) {
            logo.classList.add('logo-contraste');
          }
        });
        observer.observe(document.getElementById('header-container'), { childList: true, subtree: true });
      });
    </script>
    <main class="container">
      <div class="container-fluid bg-light py-3 mb-4">
        <div class="container">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="h3 mb-1 text-primary font-weight-bold">
                <i class="bi bi-file-earmark-text text-success me-2"></i>
                Registrar Informe de Ingeniero
              </h1>
              <p class="text-muted mb-0">Registra informes técnicos de visitas a fincas y cuarteles</p>
            </div>
            <div class="d-flex align-items-center">
              <button id="toggle-form" class="btn btn-primary" type="button" style="background-color: #007bff !important; border-color: #007bff !important; color: #ffffff !important; font-weight: 600; box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);">
                <i class="bi bi-plus-circle me-1"></i> Agregar informe
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="collapse show mb-4" id="formulario-informe">
        <div class="row">
          <div class="col-12">
            <div class="card shadow-sm border-0" style="border-radius: 16px;">
              <div class="card-header bg-white border-0 pt-4 pb-0 d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0 d-flex align-items-center">
                  <i class="bi bi-plus-circle text-primary me-2"></i>
                  <span>Nuevo Informe de Ingeniero</span>
                </h5>
                <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#formulario-informe" aria-expanded="true" aria-controls="formulario-informe" id="toggle-form-btn">
                  <i class="bi bi-dash-circle me-1"></i> Ocultar Formulario
                </button>
              </div>
              <div class="card-body p-4">
                <form id="form-visita">
        <div class="mb-4">
          <label for="productor" class="form-label font-weight-medium">
            <i class="bi bi-person me-1"></i> Productor *
          </label>
          <select id="productor" class="form-select selectpicker" title="Seleccione el productor..." required></select>
        </div>
        <div class="mb-4">
          <label for="fincas" class="form-label font-weight-medium">
            <i class="bi bi-geo-alt me-1"></i> Fincas
          </label>
          <select id="fincas" class="form-select selectpicker" multiple title="Seleccione las fincas..."></select>
          <div class="form-text">Puede buscar y seleccionar múltiples fincas</div>
        </div>
        <div class="mb-4">
          <label for="cuarteles" class="form-label font-weight-medium">
            <i class="bi bi-grid me-1"></i> Cuarteles
          </label>
          <select id="cuarteles" class="form-select selectpicker" multiple title="Primero seleccione fincas..." disabled></select>
          <div class="form-text">Los cuarteles se cargan según las fincas seleccionadas</div>
        </div>
        <div class="row g-2 mb-2">
          <div class="col-md-6">
            <label for="fecha" class="form-label">Fecha</label>
            <input type="date" id="fecha" class="form-control" required />
          </div>
        </div>
        <label>Texto del informe
          <textarea id="texto" rows="5" required placeholder="Describa la visita, observaciones y recomendaciones..."></textarea>
        </label>
        <label>Adjuntar archivos
          <input type="file" id="adjuntos" multiple />
        </label>
        <button type="submit" class="btn btn-primary w-100 mt-3"><i class="bi bi-plus-circle me-1"></i>Registrar informe</button>
        <p id="status"></p>
      </form>
      </div>
      <div id="card-informes" class="card shadow-sm mt-4 w-100 mx-auto" style="max-width:100%;margin:2em auto;">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <span class="fw-bold" style="font-size:1.1rem;"><i class="bi bi-list-ul me-2"></i>Informes anteriores</span>
          <button id="toggle-informes" class="btn btn-outline-secondary btn-sm" type="button">
            <i class="bi bi-eye-slash"></i> Ocultar
          </button>
        </div>
        <div class="card-body p-0">
          <div class="p-3 pb-0">
            <form id="filtros-informes" class="row g-2 align-items-end mb-2">
              <div class="col-md-3">
                <label for="filtro-productor" class="form-label">Productor</label>
                <select id="filtro-productor" class="form-select selectpicker" title="Todos"></select>
              </div>
              <div class="col-md-3">
                <label for="filtro-finca" class="form-label">Finca</label>
                <select id="filtro-finca" class="form-select selectpicker" title="Todas"></select>
              </div>
              <div class="col-md-3">
                <label for="filtro-cuartel" class="form-label">Cuartel</label>
                <select id="filtro-cuartel" class="form-select selectpicker" title="Todos"></select>
              </div>
              <div class="col-md-3">
                <label for="filtro-fecha" class="form-label">Fecha</label>
                <input type="date" id="filtro-fecha" class="form-control" />
              </div>
            </form>
          </div>
          <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
      <div class="card shadow-sm mt-4" style="max-width:900px;margin:2em auto;">
        <div class="card-header bg-light">
          <span class="fw-bold" style="font-size:1.1rem;"><i class="bi bi-list-ul me-2"></i>Informes anteriores</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
              <thead class="table-primary">
                <tr>
                  <th>Fecha</th>
                  <th>Productor</th>
                  <th>Finca</th>
                  <th>Cuartel</th>
                  <th>Ingeniero</th>
                  <th>Texto</th>
                  <th>Adjuntos</th>
                </tr>
              </thead>
              <tbody id="informes-list"></tbody>
            </table>
          </div>
        </div>
        <div class="card-footer bg-white border-0">
          <p id="status-list" class="mt-2 mb-0"></p>
        </div>
      </div>
    </main>
    <script type="module">
      import { supabase } from "./supabaseClient.js";
      // Inicializar selectpicker
      $(function() {
        $('#productor, #fincas, #cuarteles, #filtro-productor, #filtro-finca, #filtro-cuartel').selectpicker();
      });

      // Mostrar/ocultar formulario con collapse Bootstrap
      const toggleFormBtn = document.getElementById("toggle-form-btn");

      // Cargar productores
      async function cargarProductores() {
        const { data, error } = await supabase.from("usuarios").select("id, nombre").eq("rol", "productor");
        $('#productor').html(data ? data.map(u => `<option value="${u.id}">${u.nombre}</option>`).join("") : "").selectpicker('refresh');
        $('#filtro-productor').html('<option value="">Todos</option>' + (data ? data.map(u => `<option value="${u.id}">${u.nombre}</option>`).join("") : "")).selectpicker('refresh');
      }
      // Cargar fincas según productor seleccionado
      async function cargarFincas(productorId) {
        $('#fincas').html('<option disabled>Cargando fincas...</option>').selectpicker('refresh');
        if (!productorId) {
          $('#fincas').html('<option value="">Seleccione un productor</option>').selectpicker('refresh');
          $('#cuarteles').html("").prop('disabled', true).selectpicker('refresh');
          return;
        }
        const cleanProductorId = String(productorId).trim();
        console.log('🟦 productorId:', productorId, 'typeof:', typeof productorId, 'clean:', cleanProductorId);
        const { data, error } = await supabase.from("fincas").select("id, nombre_finca").eq("usuario_id", cleanProductorId).order('nombre_finca');
        console.log('🔎 Fincas para productor', cleanProductorId, ':', data, 'error:', error);
        if (error) {
          $('#fincas').html('<option value="">Error al cargar fincas</option>');
          $('#fincas').selectpicker('refresh');
          $('#cuarteles').html("").prop('disabled', true).selectpicker('refresh');
          return;
        }
        if (!data || !data.length) {
          $('#fincas').html('<option value="">Sin fincas</option>');
          $('#fincas').selectpicker('refresh');
          $('#cuarteles').html("").prop('disabled', true).selectpicker('refresh');
        } else {
          $('#fincas').html(data.map(f => `<option value="${f.id}">${f.nombre_finca}</option>`).join(""));
          $('#fincas').selectpicker('refresh');
          $('#cuarteles').html("").prop('disabled', true).selectpicker('refresh');
        }
        // Mejorar selectpicker con liveSearch y actionsBox
        setTimeout(() => {
          $('#fincas').selectpicker('destroy').selectpicker({
            style: 'btn-outline-secondary',
            size: 6,
            liveSearch: true,
            actionsBox: true,
            selectAllText: 'Todas las fincas',
            deselectAllText: 'Ninguna finca',
            noneSelectedText: 'Seleccione fincas...',
            countSelectedText: function(numSelected, numTotal) {
              return numSelected + ' fincas seleccionadas';
            }
          });
        }, 100);
      }
      // Cargar cuarteles según finca
      async function cargarCuarteles(fincaIds) {
        if (!fincaIds.length) {
          $('#cuarteles').html("").prop('disabled', true).selectpicker('refresh');
          $('#filtro-cuartel').html('<option value="">Todos</option>').selectpicker('refresh');
          return;
        }
        const { data, error } = await supabase.from("cuarteles").select("id, nombre").in("finca_id", fincaIds);
        $('#cuarteles').html(data ? data.map(c => `<option value="${c.id}">${c.nombre}</option>`).join("") : "").prop('disabled', false).selectpicker('refresh');
        $('#filtro-cuartel').html('<option value="">Todos</option>' + (data ? data.map(c => `<option value="${c.id}">${c.nombre}</option>`).join("") : "")).selectpicker('refresh');
      }
      // Cargar informes anteriores with filters
      async function cargarInformes() {
        // Obtener filtros
        const filtroProductor = $('#filtro-productor').val();
        const filtroFinca = $('#filtro-finca').val();
        const filtroCuartel = $('#filtro-cuartel').val();
        const filtroFecha = $('#filtro-fecha').val();
        let query = supabase.from("visitas").select(`id, fecha, texto, id_productor, id_finca, id_cuartel, id_ingeniero, adjuntos, usuarios:usuario_id(nombre), fincas(nombre_finca), cuarteles(nombre), ingeniero: id_ingeniero(nombre)`).order('fecha', { ascending: false }).limit(50);
        if (filtroProductor) query = query.eq('id_productor', filtroProductor);
        if (filtroFinca) query = query.eq('id_finca', filtroFinca);
        if (filtroCuartel) query = query.eq('id_cuartel', filtroCuartel);
        if (filtroFecha) query = query.gte('fecha', filtroFecha);
        const { data, error } = await query;
        const tbody = document.getElementById('informes-list');
        tbody.innerHTML = '';
        if (error) {
          document.getElementById('status-list').textContent = 'Error al cargar informes';
          return;
        }
        if (!data || !data.length) {
          tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No hay informes registrados</td></tr>`;
          return;
        }
        for (const inf of data) {
          tbody.innerHTML += `
            <tr>
              <td>${inf.fecha ? inf.fecha.slice(0,10) : '-'}</td>
              <td>${inf.usuarios?.nombre || '-'}</td>
              <td>${inf.fincas?.nombre_finca || '-'}</td>
              <td>${inf.cuarteles?.nombre || '-'}</td>
              <td>${inf.ingeniero?.nombre || '-'}</td>
              <td>${inf.texto ? inf.texto.substring(0,60) + (inf.texto.length>60?'...':'') : '-'}</td>
              <td>${Array.isArray(inf.adjuntos) && inf.adjuntos.length ? inf.adjuntos.map(a => `<a href="${a.url}" target="_blank">${a.nombre}</a>`).join(', ') : '-'}</td>
            </tr>
          `;
        }
      }
      // Filtros funcionales
      $('#filtros-informes select, #filtros-informes input').on('change', cargarInformes);
      // Al cambiar productor, cargar fincas
      $('#productor').on('changed.bs.select', function(e) {
        cargarFincas($(this).val());
      });
      // Al cambiar fincas, cargar cuarteles
      $('#fincas').on('changed.bs.select', function(e) {
        const fincaIds = $(this).val() || [];
        cargarCuarteles(fincaIds);
      });
      // Ocultar/mostrar tarjeta de informes
      const cardInformes = document.getElementById('card-informes');
      const toggleInformesBtn = document.getElementById('toggle-informes');
      let informesVisible = true;
      toggleInformesBtn.addEventListener('click', () => {
        informesVisible = !informesVisible;
        cardInformes.querySelector('.card-body').style.display = informesVisible ? 'block' : 'none';
        cardInformes.querySelector('.card-footer').style.display = informesVisible ? 'block' : 'none';
        toggleInformesBtn.innerHTML = informesVisible ? '<i class="bi bi-eye-slash"></i> Ocultar' : '<i class="bi bi-eye"></i> Mostrar';
      });
      await cargarProductores();
      await cargarInformes();
      // Proponer fecha actual
      document.getElementById("fecha").value = new Date().toISOString().slice(0,10);
      // Form submit
      document.getElementById("form-visita").addEventListener("submit", async e => {
        e.preventDefault();
        const status = document.getElementById("status");
        status.textContent = "Guardando...";
        const id_productor = document.getElementById("productor").value;
        const fincaIds = Array.from(document.getElementById("fincas").selectedOptions).map(opt => opt.value);
        const cuartelIds = Array.from(document.getElementById("cuarteles").selectedOptions).map(opt => opt.value);
        const fecha = document.getElementById("fecha").value;
        const texto = document.getElementById("texto").value;
        const adjuntosInput = document.getElementById("adjuntos");
        // Validar al menos una entidad
        if (!id_productor && !fincaIds.length && !cuartelIds.length) {
          status.textContent = "Selecciona al menos productor, finca o cuartel.";
          return;
        }
        // Subir adjuntos (opcional, solo si hay archivos)
        let adjuntos = [];
        if (adjuntosInput.files.length) {
          for (const file of adjuntosInput.files) {
            const { data, error } = await supabase.storage.from("informes").upload(`${Date.now()}_${file.name}`, file);
            if (error) {
              status.textContent = `Error al subir archivo: ${file.name}`;
              return;
            }
            adjuntos.push({ url: data.path, nombre: file.name });
          }
        }
        // Registrar informe (uno por cuartel, o por finca, o solo productor)
        const id_ingeniero = (await supabase.auth.getUser()).data.user.id;
        let registros = [];
        if (cuartelIds.length) {
          registros = cuartelIds.map(id_cuartel => ({
            id_productor, id_finca: null, id_cuartel, id_ingeniero, fecha, texto, adjuntos
          }));
        } else if (fincaIds.length) {
          registros = fincaIds.map(id_finca => ({
            id_productor, id_finca, id_cuartel: null, id_ingeniero, fecha, texto, adjuntos
          }));
        } else {
          registros = [{ id_productor, id_finca: null, id_cuartel: null, id_ingeniero, fecha, texto, adjuntos }];
        }
        const { error } = await supabase.from("visitas").insert(registros);
        if (error) {
          status.textContent = "❌ Error al guardar: " + error.message;
        } else {
          status.textContent = `✅ Informe registrado correctamente.`;
          document.getElementById("form-visita").reset();
          document.getElementById("fincas").innerHTML = "";
          document.getElementById("cuarteles").innerHTML = "";
        }
      });
    </script>
    <script type="module">
      import { supabase } from "./supabaseClient.js";
      const { data: { user } } = await supabase.auth.getUser();
      console.log('user_metadata:', user?.user_metadata);
      if (!user) {
        window.location.href = "login.html";
        throw new Error("No autorizado");
      }
      fetch('header.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('header-container').innerHTML = html;
          import('./header.js');
        });
    </script>
  </body>
</html>
