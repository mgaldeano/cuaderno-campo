<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reportes | Cuaderno de Campo</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📊</text></svg>">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Select -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Google Fonts Roboto -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="estilos.css">
  </head>
  
  <body class="bg-light">
    <div id="header-container"></div>

    <div class="container-fluid py-4">
      <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
          <div class="card shadow-sm">
            <div class="card-body">
              <h1 class="h3 mb-4 text-primary">
                <i class="bi bi-bar-chart-line me-2"></i>Reportes
              </h1>

              <!-- Formulario de filtros -->
              <form id="reportes-filtros" class="mb-4">
                <!-- Selección de tipo de reporte -->
                <div class="row mb-4">
                  <div class="col-md-6">
                    <label for="tipo-reporte" class="form-label font-weight-medium">
                      <i class="bi bi-list me-1"></i> Tipo de Reporte
                    </label>
                    <select id="tipo-reporte" class="form-select">
                      <option value="riegos">Riegos realizados</option>
                      <option value="riegos-regador">Riegos por regador</option>
                      <option value="agroquimicos">Aplicaciones agroquímicos</option>
                      <option value="fertilizaciones">Fertilizaciones</option>
                      <option value="labores">Labores culturales</option>
                      <option value="bpa">Registros BPA</option>
                    </select>
                  </div>
                </div>

                <!-- Filtros generales (Riegos realizados) -->
                <div id="filtros-riegos" style="display:none;">
                  <div class="row mb-4">
                    <div class="col-md-6">
                      <label for="finca-reporte" class="form-label font-weight-medium">
                        <i class="bi bi-geo-alt me-1"></i> Fincas
                      </label>
                      <select id="finca-reporte" class="form-select selectpicker" multiple 
                              title="Seleccione fincas..." data-live-search="true">
                      </select>
                      <div class="form-text">Filtra por fincas seleccionadas</div>
                    </div>
                    <div class="col-md-6">
                      <label for="cuartel-reporte" class="form-label font-weight-medium">
                        <i class="bi bi-grid me-1"></i> Cuarteles
                      </label>
                      <select id="cuartel-reporte" class="form-select selectpicker" multiple 
                              title="Seleccione cuarteles..." data-live-search="true">
                      </select>
                      <div class="form-text">Filtra por cuarteles seleccionados</div>
                    </div>
                  </div>

                  <div class="row mb-4">
                    <div class="col-md-6">
                      <label for="fecha-desde" class="form-label font-weight-medium">
                        <i class="bi bi-calendar-event me-1"></i> Fecha Desde
                      </label>
                      <input type="date" id="fecha-desde" class="form-control" value="2000-01-01" />
                    </div>
                    <div class="col-md-6">
                      <label for="fecha-hasta" class="form-label font-weight-medium">
                        <i class="bi bi-calendar-check me-1"></i> Fecha Hasta
                      </label>
                      <input type="date" id="fecha-hasta" class="form-control" />
                    </div>
                  </div>
                </div>

                <!-- Botón de generar reporte -->
                <div class="text-center">
                  <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-play-circle me-2"></i>Generar Reporte
                  </button>
                </div>
              </form>

              <!-- Resultados -->
              <div id="reportes-resultado"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
    <script src="header.js"></script>

    <script type="module">
      import { supabase } from "./supabaseClient.js";
      
      // Verificar autenticación
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = 'login.html';
      }

      // Cargar header
      fetch('header.html')
        .then(response => response.text())
        .then(data => {
          document.getElementById('header-container').innerHTML = data;
        });

      // Variables globales
      let todasLasFincas = [];
      let todosLosCuarteles = [];

      // Inicialización después de que DOM esté listo
      $(document).ready(function() {
        // Configurar fechas por defecto
        const hoy = new Date().toISOString().split('T')[0];
        document.getElementById('fecha-hasta').value = hoy;

        // Configurar evento para cambio de tipo de reporte
        $('#tipo-reporte').on('change', function() {
          const tipoSeleccionado = $(this).val();
          mostrarFiltrosSegunTipo(tipoSeleccionado);
        });

        // Mostrar filtros iniciales para riegos
        mostrarFiltrosSegunTipo('riegos');

        // Configurar formulario
        document.getElementById('reportes-filtros').addEventListener('submit', async (e) => {
          e.preventDefault();
          // Lógica de generación de reportes aquí
        });
      });

      // Función para cargar fincas
      async function cargarFincasReporte() {
        try {
          console.log('=== CARGA DE FINCAS ===');
          
          const { data: fincas, error } = await supabase
            .from('fincas')
            .select('id, nombre_finca')
            .eq('usuario_id', user.id)
            .order('nombre_finca');
          
          if (error) throw error;
          
          todasLasFincas = fincas || [];
          console.log('Total fincas:', todasLasFincas.length);
          
          // Verificar que el elemento existe
          const selector = $('#finca-reporte');
          if (selector.length === 0) {
            console.error('❌ Elemento #finca-reporte no encontrado');
            return;
          }

          // Limpiar y destruir Bootstrap Select existente
          if (selector.hasClass('selectpicker')) {
            selector.selectpicker('destroy');
          }
          selector.empty();

          // Agregar opciones
          todasLasFincas.forEach(finca => {
            selector.append(`<option value="${finca.id}">${finca.nombre_finca}</option>`);
          });

          // Inicializar Bootstrap Select
          selector.selectpicker({
            actionsBox: true,
            selectAllText: 'Todas',
            deselectAllText: 'Ninguna',
            noneSelectedText: 'Seleccione fincas...',
            liveSearch: true
          });

          console.log('✅ Fincas cargadas exitosamente');
          
        } catch (error) {
          console.error('Error cargando fincas:', error);
        }
      }

      // Función para cargar cuarteles según fincas seleccionadas
      async function cargarCuartelesReporte() {
        try {
          console.log('=== CARGA DE CUARTELES ===');
          
          const fincasSeleccionadas = $('#finca-reporte').val() || [];
          console.log('Fincas seleccionadas:', fincasSeleccionadas);
          
          const selector = $('#cuartel-reporte');
          if (selector.length === 0) {
            console.error('❌ Elemento #cuartel-reporte no encontrado');
            return;
          }

          // Limpiar selector
          if (selector.hasClass('selectpicker')) {
            selector.selectpicker('destroy');
          }
          selector.empty();

          if (fincasSeleccionadas.length === 0) {
            console.log('No hay fincas seleccionadas');
          } else {
            // Cargar cuarteles de las fincas seleccionadas
            const { data: cuarteles, error } = await supabase
              .from('cuarteles')
              .select('id, nombre, finca_id')
              .in('finca_id', fincasSeleccionadas)
              .order('nombre');
            
            if (error) throw error;
            
            cuarteles.forEach(cuartel => {
              selector.append(`<option value="${cuartel.id}">${cuartel.nombre}</option>`);
            });
            
            console.log('Cuarteles cargados:', cuarteles.length);
          }

          // Reinicializar Bootstrap Select
          selector.selectpicker({
            actionsBox: true,
            selectAllText: 'Todas',
            deselectAllText: 'Ninguna',
            noneSelectedText: 'Seleccione cuarteles...',
            liveSearch: true
          });

          console.log('✅ Cuarteles actualizados');
          
        } catch (error) {
          console.error('Error cargando cuarteles:', error);
        }
      }

      // Función para mostrar filtros según el tipo de reporte
      function mostrarFiltrosSegunTipo(tipo) {
        console.log('Mostrando filtros para:', tipo);
        
        // Ocultar todos los filtros primero
        document.getElementById('filtros-riegos').style.display = 'none';

        // Mostrar el filtro correspondiente
        if (tipo === 'riegos' || tipo === 'agroquimicos' || tipo === 'fertilizaciones' || tipo === 'labores' || tipo === 'bpa') {
          document.getElementById('filtros-riegos').style.display = 'block';
          
          // Cargar fincas si no están cargadas
          if (todasLasFincas.length === 0) {
            cargarFincasReporte();
          }
        }
      }

      // Agregar evento para cambio de fincas
      $(document).on('changed.bs.select', '#finca-reporte', function() {
        console.log('>>> Fincas cambiadas, cargando cuarteles...');
        cargarCuartelesReporte();
      });

      // FUNCIÓN PARA SOLUCIONAR EL PROBLEMA DE DROPDOWN FINCAS
      window.solucionarDropdownFincas = async function() {
        console.log('=== SOLUCIONANDO DROPDOWN FINCAS ===');
        
        try {
          // 1. Mostrar contenedor
          const contenedor = document.getElementById('filtros-riegos');
          if (!contenedor) {
            console.error('❌ Contenedor no encontrado');
            return false;
          }
          contenedor.style.display = 'block';
          
          // 2. Verificar elemento finca-reporte
          let selectFincas = document.getElementById('finca-reporte');
          if (!selectFincas) {
            console.log('🔧 Recreando elemento finca-reporte...');
            const primeraColumna = contenedor.querySelector('.col-md-6');
            const label = primeraColumna.querySelector('label[for="finca-reporte"]');
            
            selectFincas = document.createElement('select');
            selectFincas.id = 'finca-reporte';
            selectFincas.className = 'form-select selectpicker';
            selectFincas.setAttribute('multiple', '');
            selectFincas.setAttribute('title', 'Seleccione fincas...');
            selectFincas.setAttribute('data-live-search', 'true');
            
            label.insertAdjacentElement('afterend', selectFincas);
          }
          
          // 3. Limpiar Bootstrap Select
          const $select = $(selectFincas);
          if ($select.hasClass('selectpicker')) {
            $select.selectpicker('destroy');
          }
          $('.bootstrap-select').remove();
          
          // 4. Cargar datos
          if (!todasLasFincas || todasLasFincas.length === 0) {
            const { data: fincas, error } = await supabase
              .from('fincas')
              .select('id, nombre_finca')
              .eq('usuario_id', user.id)
              .order('nombre_finca');
            
            if (error) throw error;
            todasLasFincas = fincas || [];
          }
          
          // 5. Poblar opciones
          $select.empty();
          todasLasFincas.forEach(finca => {
            $select.append(`<option value="${finca.id}">${finca.nombre_finca}</option>`);
          });
          
          // 6. Inicializar Bootstrap Select
          $select.selectpicker({
            actionsBox: true,
            selectAllText: 'Todas',
            deselectAllText: 'Ninguna',
            noneSelectedText: 'Seleccione fincas...',
            liveSearch: true
          });
          
          // 7. Agregar evento
          $select.on('changed.bs.select', function() {
            console.log('>>> Cargando cuarteles...');
            cargarCuartelesReporte();
          });
          
          console.log('✅ Dropdown funcional con', todasLasFincas.length, 'fincas');
          return true;
          
        } catch (error) {
          console.error('❌ Error:', error);
          return false;
        }
      };

      console.log('Función disponible: window.solucionarDropdownFincas()');

    </script>
  </body>
</html>
