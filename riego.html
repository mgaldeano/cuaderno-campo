<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Registrar Riego | Cuaderno de Campo</title>
    <link href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" rel="stylesheet" />
  </head>
  <body>
    <div id="header-container"></div>
    <script type="module">
      fetch('header.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('header-container').innerHTML = html;
          import('./header.js');
        });
    </script>

    <main class="container">
      <hgroup>
        <h2>Registrar Riego</h2>
        <h3>Complete los datos del riego realizado</h3>
      </hgroup>
      <form id="riego-form">
        <label for="labor">Labor</label>
        <input type="text" id="labor" name="labor" value="Riego" readonly />

        <label for="objetivo">Objetivo</label>
        <input type="text" id="objetivo" name="objetivo" placeholder="Objetivo del riego" required />

        <label>Fincas</label>
        <div id="fincas-checkboxes" style="display:flex; flex-wrap:wrap; gap:1em; margin-bottom:0.5em;"></div>
        <div style="display:flex; gap:0.5em; align-items:center;">
          <button type="button" id="fincaSelectAll" style="font-size:0.9em;">Seleccionar todos</button>
          <button type="button" id="fincaDeselectAll" style="font-size:0.9em;">Deseleccionar todo</button>
        </div>

        <label>Cuarteles</label>
        <div id="cuarteles-checkboxes" style="display:flex; flex-wrap:wrap; gap:1em; margin-bottom:0.5em;"></div>
        <div style="display:flex; gap:0.5em; align-items:center;">
          <button type="button" id="cuartelSelectAll" style="font-size:0.9em;">Seleccionar todos</button>
          <button type="button" id="cuartelDeselectAll" style="font-size:0.9em;">Deseleccionar todo</button>
        </div>

        <label for="variedad">Variedad</label>
        <input type="text" id="variedad" name="variedad" readonly />

        <label for="especie">Especie</label>
        <input type="text" id="especie" name="especie" readonly />

        <label for="operador">Operador responsable</label>
        <select id="operador" name="operador" required>
          <option value="">Seleccione un operario...</option>
        </select>

        <label for="fecha">Fecha de realización</label>
        <input type="date" id="fecha" name="fecha" required />

        <label for="maquinaria">Maquinaria utilizada</label>
        <input type="text" id="maquinaria" name="maquinaria" placeholder="(Opcional)" />

        <label for="horas_riego">Horas de riego</label>
        <input type="number" id="horas_riego" name="horas_riego" min="0" step="0.1" placeholder="Cantidad de horas" />

        <label for="volumen_agua">Volumen de agua (m³)</label>
        <input type="number" id="volumen_agua" name="volumen_agua" min="0" step="0.1" placeholder="Volumen aplicado" />

        <label for="observaciones">Observaciones</label>
        <textarea id="observaciones" name="observaciones" rows="2"></textarea>

        <button type="submit">Registrar riego</button>
      </form>
      <p id="status"></p>
    </main>

    <footer class="container">
      <small><a href="#">Privacidad</a> • <a href="#">Términos</a></small>
    </footer>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
      const supabase = createClient(
        "https://djvdjulfeuqohpnatdmt.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdmRqdWxmZXVxb2hwbmF0ZG10Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzNTYyMTEsImV4cCI6MjA2NzkzMjIxMX0.aD_klISxuwoGxMYtPq6XPARva8D32YkKFu7s_Ffq0fw"
      );

      // Elementos del DOM
      // const fincaSelect = document.getElementById("finca");
      // const cuartelSelect = document.getElementById("cuartel");
      const status = document.getElementById("status");
      const operadorSelect = document.getElementById("operador");
      const fincasDiv = document.getElementById("fincas-checkboxes");
      const cuartelesDiv = document.getElementById("cuarteles-checkboxes");

      // Cargar fincas al iniciar
      async function cargarFincas() {
        fincasDiv.innerHTML = '';
        const { data, error } = await supabase.from("fincas").select("id, nombre_finca");
        if (error) {
          status.textContent = "Error al cargar fincas";
          return;
        }
        data.forEach(finca => {
          const label = document.createElement("label");
          label.style.display = "flex";
          label.style.alignItems = "center";
          label.style.gap = "0.3em";
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.value = finca.id;
          checkbox.className = "finca-checkbox";
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(finca.nombre_finca));
          fincasDiv.appendChild(label);
        });
      }

      // Mostrar cuarteles según fincas seleccionadas
      async function mostrarCuartelesSeleccionados() {
        cuartelesDiv.innerHTML = '';
        const fincasSeleccionadas = Array.from(document.querySelectorAll('.finca-checkbox:checked')).map(cb => cb.value);
        if (fincasSeleccionadas.length === 0) return;
        const { data: cuarteles, error } = await supabase
          .from("cuarteles")
          .select("id, nombre, finca_id")
          .in("finca_id", fincasSeleccionadas);
        if (error) {
          status.textContent = "Error al cargar cuarteles";
          return;
        }
        cuarteles.forEach(cuartel => {
          const label = document.createElement("label");
          label.style.display = "flex";
          label.style.alignItems = "center";
          label.style.gap = "0.3em";
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.value = cuartel.id;
          checkbox.className = "cuartel-checkbox";
          checkbox.dataset.fincaId = cuartel.finca_id;
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(cuartel.nombre));
          cuartelesDiv.appendChild(label);
        });
      }

      // Escuchar cambios en fincas
      fincasDiv.addEventListener('change', mostrarCuartelesSeleccionados);

      // Al cambiar cuartel, cargar especie y variedades asociadas (solo el primero seleccionado)
      cuartelesDiv.addEventListener("change", async () => {
        const cuartelId = document.querySelector('.cuartel-checkbox:checked')?.value;
        if (!cuartelId) {
          document.getElementById("especie").value = "";
          document.getElementById("variedad").value = "";
          proponerObjetivo();
          return;
        }
        // Traer especie del cuartel
        const { data: cuartel, error: errorCuartel } = await supabase
          .from("cuarteles")
          .select("especie")
          .eq("id", cuartelId)
          .single();
        document.getElementById("especie").value = cuartel?.especie || "";
        // Traer variedades asociadas al cuartel (relación muchos a muchos)
        const { data: variedades, error: errorVar } = await supabase
          .from("cuartel_variedades")
          .select("variedades(nombre)")
          .eq("cuartel_id", cuartelId);
        if (!errorVar && variedades && variedades.length > 0) {
          document.getElementById("variedad").value = variedades.map(v => v.variedades.nombre).join(", ");
        } else {
          document.getElementById("variedad").value = "";
        }
        proponerObjetivo();
      });

      // Función para proponer objetivo sugerido
      function proponerObjetivo() {
        const objetivoInput = document.getElementById("objetivo");
        objetivoInput.value = "Reposición de agua en el suelo para el cultivo";
      }

      // Eliminado event listener de cuartelSelect (ya no existe select de cuartel)

      // Eliminado event listener de fincaSelect y cuartelSelect (ya no existen selects)

      // Proponer objetivo al cargar el formulario
      window.addEventListener('DOMContentLoaded', proponerObjetivo);

      // Guardar registro de riego
      document.getElementById("riego-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        status.textContent = "Guardando...";
        const form = e.target;
        const cuartelesSeleccionados = Array.from(document.querySelectorAll('.cuartel-checkbox:checked'));
        if (cuartelesSeleccionados.length === 0) {
          status.textContent = "Seleccione al menos un cuartel.";
          return;
        }
        const registros = [];
        for (const cuartelCb of cuartelesSeleccionados) {
          const fincaId = cuartelCb.dataset.fincaId;
          registros.push({
            finca_id: fincaId,
            cuartel_id: cuartelCb.value,
            variedad: form.variedad.value,
            especie: form.especie.value,
            operador_id: form.operador.value,
            fecha: form.fecha.value,
            maquinaria: form.maquinaria.value,
            horas_riego: form.horas_riego.value,
            volumen_agua: form.volumen_agua.value,
            observaciones: form.observaciones.value,
            labor: "Riego",
            objetivo: form.objetivo.value,
          });
        }
        const { error } = await supabase.from("riegos").insert(registros);
        if (error) {
          status.textContent = "❌ Error al guardar: " + error.message;
          console.error(error);
        } else {
          status.textContent = `✅ Riego registrado para ${registros.length} cuartel(es)`;
          form.reset();
          cuartelesDiv.innerHTML = '';
          operadorSelect.innerHTML = '<option value=\"\">Seleccione un operario...</option>';
        }
      });

      // Cargar operarios del usuario logueado
      const { data: { user } } = await supabase.auth.getUser();
      const userId = user.id;

      async function cargarOperarios() {
        operadorSelect.innerHTML = '<option value="">Seleccione un operario...</option>';
        const { data: operarios, error } = await supabase
          .from("aplicadores_operarios")
          .select("id, nombre")
          .eq("usuario_id", userId);
        if (error) {
          status.textContent = "Error al cargar operarios";
          return;
        }
        operarios.forEach(op => {
          const option = document.createElement("option");
          option.value = op.id;
          option.textContent = op.nombre;
          operadorSelect.appendChild(option);
        });
      }

      // Inicializar
      await cargarFincas();
      mostrarCuartelesSeleccionados();
      cargarOperarios();
    </script>
  </body>
</html>