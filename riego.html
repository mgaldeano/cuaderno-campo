<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Registrar Riego | Cuaderno de Campo</title>
    <link href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" rel="stylesheet" />
  </head>
  <body>
    <div id="header-container"></div>
    <script type="module">
      fetch('header.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('header-container').innerHTML = html;
          import('./header.js');
        });
    </script>

    <main class="container">
      <hgroup>
        <h2>Registrar Riego</h2>
        <h3>Complete los datos del riego realizado</h3>
      </hgroup>
      <form id="riego-form">
        <label for="labor">Labor</label>
        <input type="text" id="labor" name="labor" value="Riego" readonly />

        <label for="objetivo">Objetivo</label>
        <input type="text" id="objetivo" name="objetivo" placeholder="Objetivo del riego" required />

        <label>Fincas</label>
        <div id="fincas-checkboxes" style="display:flex; flex-wrap:wrap; gap:1em; margin-bottom:0.5em;"></div>
        <div style="display:flex; gap:0.3em; align-items:center; margin-bottom:0.5em;">
          <button type="button" id="fincaSelectAll" style="font-size:0.75em; padding:0.1em 0.5em; background:none; border:1px solid #bbb; color:#444;">✓</button>
          <button type="button" id="fincaDeselectAll" style="font-size:0.75em; padding:0.1em 0.5em; background:none; border:1px solid #bbb; color:#444;">✗</button>
          <span style="font-size:0.8em; color:#888;">Fincas</span>
        </div>

        <label>Cuarteles</label>
        <div id="cuarteles-checkboxes" style="display:flex; flex-wrap:wrap; gap:1em; margin-bottom:0.5em;"></div>
        <div style="display:flex; gap:0.3em; align-items:center; margin-bottom:0.5em;">
          <button type="button" id="cuartelSelectAll" style="font-size:0.75em; padding:0.1em 0.5em; background:none; border:1px solid #bbb; color:#444;">✓</button>
          <button type="button" id="cuartelDeselectAll" style="font-size:0.75em; padding:0.1em 0.5em; background:none; border:1px solid #bbb; color:#444;">✗</button>
          <span style="font-size:0.8em; color:#888;">Cuarteles</span>
        </div>

        <div id="tabla-cuarteles"></div>

        <label for="maquinaria">Maquinaria utilizada</label>
        <input type="text" id="maquinaria" name="maquinaria" placeholder="(Opcional)" />

        <button type="submit">Registrar riego</button>
      </form>
      <p id="status"></p>
    </main>

    <footer class="container">
      <small><a href="#">Privacidad</a> • <a href="#">Términos</a></small>
    </footer>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
      const supabase = createClient(
        "https://djvdjulfeuqohpnatdmt.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdmRqdWxmZXVxb2hwbmF0ZG10Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzNTYyMTEsImV4cCI6MjA2NzkzMjIxMX0.aD_klISxuwoGxMYtPq6XPARva8D32YkKFu7s_Ffq0fw"
      );

      const status = document.getElementById("status");
      const fincasDiv = document.getElementById("fincas-checkboxes");
      const cuartelesDiv = document.getElementById("cuarteles-checkboxes");
      const tablaCuartelesDiv = document.getElementById("tabla-cuarteles");

      // Cargar fincas al iniciar
      async function cargarFincas() {
        fincasDiv.innerHTML = '';
        const { data, error } = await supabase.from("fincas").select("id, nombre_finca");
        if (error) {
          status.textContent = "Error al cargar fincas";
          return;
        }
        data.forEach(finca => {
          const label = document.createElement("label");
          label.style.display = "flex";
          label.style.alignItems = "center";
          label.style.gap = "0.3em";
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.value = finca.id;
          checkbox.className = "finca-checkbox";
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(finca.nombre_finca));
          fincasDiv.appendChild(label);
        });
      }

      // Botones seleccionar/deseleccionar todos
      document.getElementById("fincaSelectAll").onclick = () => {
        fincasDiv.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = true);
        mostrarCuartelesSeleccionados();
      };
      document.getElementById("fincaDeselectAll").onclick = () => {
        fincasDiv.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = false);
        mostrarCuartelesSeleccionados();
      };
      document.getElementById("cuartelSelectAll").onclick = () => {
        cuartelesDiv.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = true);
        mostrarTablaCuarteles();
      };
      document.getElementById("cuartelDeselectAll").onclick = () => {
        cuartelesDiv.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = false);
        mostrarTablaCuarteles();
      };

      // Mostrar cuarteles según fincas seleccionadas
      async function mostrarCuartelesSeleccionados() {
        cuartelesDiv.innerHTML = '';
        tablaCuartelesDiv.innerHTML = '';
        const fincasSeleccionadas = Array.from(document.querySelectorAll('.finca-checkbox:checked')).map(cb => cb.value);
        if (fincasSeleccionadas.length === 0) return;
        const { data: cuarteles, error } = await supabase
          .from("cuarteles")
          .select("id, nombre, finca_id")
          .in("finca_id", fincasSeleccionadas);
        if (error) {
          status.textContent = "Error al cargar cuarteles";
          return;
        }
        cuarteles.forEach(cuartel => {
          const label = document.createElement("label");
          label.style.display = "flex";
          label.style.alignItems = "center";
          label.style.gap = "0.3em";
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.value = cuartel.id;
          checkbox.className = "cuartel-checkbox";
          checkbox.dataset.fincaId = cuartel.finca_id;
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(cuartel.nombre));
          cuartelesDiv.appendChild(label);
        });
        mostrarTablaCuarteles();
      }

      // Cargar operarios del usuario logueado
      const { data: { user } } = await supabase.auth.getUser();
      const userId = user.id;
      let operariosGlobal = [];
      async function cargarOperarios() {
        const { data: operarios, error } = await supabase
          .from("aplicadores_operarios")
          .select("id, nombre")
          .eq("usuario_id", userId);
        if (error) {
          status.textContent = "Error al cargar operarios";
          return [];
        }
        operariosGlobal = operarios;
        return operarios;
      }

      // Al cambiar cuarteles seleccionados, mostrar tabla editable
      cuartelesDiv.addEventListener("change", async () => {
        await mostrarTablaCuarteles();
      });

      async function mostrarTablaCuarteles() {
        tablaCuartelesDiv.innerHTML = "";
        const cuartelesSeleccionados = Array.from(document.querySelectorAll('.cuartel-checkbox:checked')).map(cb => cb.value);
        if (cuartelesSeleccionados.length === 0) return;
        // Traer info de cuarteles
        const { data: cuarteles, error } = await supabase
          .from("cuarteles")
          .select("id, nombre, especie, finca_id")
          .in("id", cuartelesSeleccionados);
        if (error) {
          status.textContent = "Error al cargar info de cuarteles";
          return;
        }
        // Traer variedades asociadas a cada cuartel
        const variedadesPorCuartel = {};
        for (const cuartel of cuarteles) {
          const { data: variedades, error: errorVar } = await supabase
            .from("cuartel_variedades")
            .select("variedades(nombre)")
            .eq("cuartel_id", cuartel.id);
          variedadesPorCuartel[cuartel.id] = (!errorVar && variedades && variedades.length > 0)
            ? variedades.map(v => v.variedades.nombre).join(", ") : "";
        }
        // Crear tabla
        let html = `<table style='font-size:0.95em;'><thead><tr>
          <th>Cuartel</th><th>Variedad</th><th>Especie</th><th>Operador</th><th>Fecha</th><th>Horas</th><th>Volumen (m³)</th><th>Obs.</th></tr></thead><tbody>`;
        // Obtener valores por defecto (primero seleccionado)
        let operadorDefault = operariosGlobal[0]?.id || "";
        let fechaDefault = new Date().toISOString().slice(0,10);
        let horasDefault = "";
        let volumenDefault = "";
        cuarteles.forEach((cuartel, idx) => {
          html += `<tr>
            <td>${cuartel.nombre}</td>
            <td><input type='text' value='${variedadesPorCuartel[cuartel.id]}' readonly style='width:7em;'/></td>
            <td><input type='text' value='${cuartel.especie || ""}' readonly style='width:6em;'/></td>
            <td><select class='operador-celda'>${operariosGlobal.map(op => `<option value='${op.id}' ${op.id===operadorDefault?"selected":""}>${op.nombre}</option>`).join("")}</select></td>
            <td><input type='date' class='fecha-celda' value='${fechaDefault}' style='width:8em;'/></td>
            <td><input type='number' class='horas-celda' min='0' step='0.1' value='${horasDefault}' style='width:5em;'/></td>
            <td><input type='number' class='volumen-celda' min='0' step='0.1' value='${volumenDefault}' style='width:7em;'/></td>
            <td><input type='text' class='obs-celda' style='width:10em;'/></td>
            <td style='display:none'><input type='hidden' class='cuartel-id' value='${cuartel.id}'/></td>
            <td style='display:none'><input type='hidden' class='finca-id' value='${cuartel.finca_id}'/></td>
          </tr>`;
        });
        html += `</tbody></table>`;
        tablaCuartelesDiv.innerHTML = html;

        // Lógica de autocompletado: al cambiar el primer operador/fecha/horas/volumen, propagar a los demás si están vacíos
        const filas = tablaCuartelesDiv.querySelectorAll('tbody tr');
        if (filas.length > 1) {
          // Operador
          filas[0].querySelector('.operador-celda').addEventListener('change', e => {
            const val = e.target.value;
            filas.forEach((fila, idx) => { if(idx>0 && !fila.querySelector('.operador-celda').value) fila.querySelector('.operador-celda').value = val; });
          });
          // Fecha
          filas[0].querySelector('.fecha-celda').addEventListener('change', e => {
            const val = e.target.value;
            filas.forEach((fila, idx) => { if(idx>0 && !fila.querySelector('.fecha-celda').value) fila.querySelector('.fecha-celda').value = val; });
          });
          // Horas
          filas[0].querySelector('.horas-celda').addEventListener('input', e => {
            const val = e.target.value;
            filas.forEach((fila, idx) => { if(idx>0 && !fila.querySelector('.horas-celda').value) fila.querySelector('.horas-celda').value = val; });
          });
          // Volumen
          filas[0].querySelector('.volumen-celda').addEventListener('input', e => {
            const val = e.target.value;
            filas.forEach((fila, idx) => { if(idx>0 && !fila.querySelector('.volumen-celda').value) fila.querySelector('.volumen-celda').value = val; });
          });
        }
      }

      // Proponer objetivo al cargar el formulario
      function proponerObjetivo() {
        const objetivoInput = document.getElementById("objetivo");
        objetivoInput.value = "Reposición de agua en el suelo para el cultivo";
      }
      window.addEventListener('DOMContentLoaded', proponerObjetivo);

      // Guardar registro de riego
      document.getElementById("riego-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        status.textContent = "Guardando...";
        const filas = tablaCuartelesDiv.querySelectorAll('tbody tr');
        if (filas.length === 0) {
          status.textContent = "Seleccione al menos un cuartel.";
          return;
        }
        const registros = [];
        for (const fila of filas) {
          registros.push({
            finca_id: fila.querySelector('.finca-id').value,
            cuartel_id: fila.querySelector('.cuartel-id').value,
            variedad: fila.querySelector('td:nth-child(2) input').value,
            especie: fila.querySelector('td:nth-child(3) input').value,
            operador_id: fila.querySelector('.operador-celda').value,
            fecha: fila.querySelector('.fecha-celda').value,
            maquinaria: document.getElementById('maquinaria')?.value || '',
            horas_riego: fila.querySelector('.horas-celda').value,
            volumen_agua: fila.querySelector('.volumen-celda').value,
            observaciones: fila.querySelector('.obs-celda').value,
            labor: "Riego",
            objetivo: document.getElementById('objetivo').value,
          });
        }
        const { error } = await supabase.from("riegos").insert(registros);
        if (error) {
          status.textContent = "❌ Error al guardar: " + error.message;
          console.error(error);
        } else {
          status.textContent = `✅ Riego registrado para ${registros.length} cuartel(es)`;
          document.getElementById("riego-form").reset();
          cuartelesDiv.innerHTML = '';
          tablaCuartelesDiv.innerHTML = '';
        }
      });

      // Inicializar
      await cargarFincas();
      await cargarOperarios();
      mostrarCuartelesSeleccionados();
    </script>
  </body>
</html>