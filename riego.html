<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Registrar Riego | Cuaderno de Campo</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>💧</text></svg>">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Select - versión compatible con Bootstrap 5 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Google Fonts Roboto -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
    <!-- Tu CSS personalizado -->
    <link rel="stylesheet" href="estilos.css">
    <!-- jQuery (necesario para Bootstrap Select) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Bootstrap Select JS - versión beta para Bootstrap 5 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
    <style>
      /* Personalización Bootstrap Select para Bootstrap 5 */
      .bootstrap-select .dropdown-menu {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: 1px solid #dee2e6;
      }
      
      .bootstrap-select .dropdown-menu li a {
        padding: 8px 16px 8px 40px !important;
        font-family: 'Roboto', sans-serif;
        transition: all 0.2s ease;
      }
      
      .bootstrap-select .dropdown-menu li a span.check-mark {
        left: 12px;
        color: #0d6efd;
        font-size: 1.1em;
        font-weight: bold;
      }
      
      .bootstrap-select .dropdown-menu li.selected a {
        background-color: #e7f3ff;
        color: #0d6efd;
        font-weight: 500;
      }
      
      .bootstrap-select .dropdown-menu li a:hover {
        background-color: #f8f9fa;
      }
      
      .bootstrap-select .dropdown-menu li.selected a:hover {
        background-color: #d1ecf1;
      }
      
      .bootstrap-select > .dropdown-toggle {
        border-radius: 6px;
        border: 1px solid #ced4da;
        padding: 8px 12px;
        font-family: 'Roboto', sans-serif;
      }
      
      .bootstrap-select > .dropdown-toggle:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
      }
      
      /* Botones de acciones (Seleccionar todas/ninguna) */
      .bootstrap-select .bs-actionsbox {
        padding: 8px 12px;
        border-bottom: 1px solid #dee2e6;
        background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
        margin-bottom: 2px;
      }
      
      .bootstrap-select .bs-actionsbox .btn-group {
        width: 100%;
        display: flex;
        gap: 4px;
      }
      
      .bootstrap-select .bs-actionsbox .btn-group button {
        font-size: 11px;
        padding: 6px 12px;
        border-radius: 4px;
        border: 1px solid #0d6efd;
        background: #ffffff;
        color: #0d6efd;
        font-weight: 600;
        flex: 1;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.2s ease;
      }
      
      .bootstrap-select .bs-actionsbox .btn-group button:hover {
        background: #0d6efd;
        border-color: #0d6efd;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
      }
      
      /* Asegurar que el actionsBox siempre sea visible */
      .bootstrap-select.open .bs-actionsbox {
        display: block !important;
      }
    </style>
  </head>
  <body>
    <div id="header-container"></div>

    <main class="container py-4">
      <!-- Header Section -->
      <div class="container-fluid bg-light py-3 mb-4">
        <div class="container">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="h3 mb-1 text-primary font-weight-bold">
                <i class="bi bi-droplet-half text-primary me-2"></i>
                Registrar Riego
              </h1>
              <p class="text-muted mb-0">Complete los datos del riego realizado</p>
            </div>
            <div class="d-flex align-items-center">
              <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" 
                      data-bs-target="#formulario-riego" aria-expanded="true" aria-controls="formulario-riego" id="toggle-form-btn">
                <i class="bi bi-dash-circle me-1"></i> Ocultar Formulario
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Formulario Colapsable -->
      <div class="collapse show mb-4" id="formulario-riego">
        <div class="row">
          <div class="col-12">
            <div class="card shadow-sm border-0" style="border-radius: 16px;">
              <div class="card-header bg-white border-0 pt-4 pb-0">
                <h5 class="card-title mb-0 d-flex align-items-center">
                  <i class="bi bi-droplet-half text-primary me-2"></i>
                  <span>Nuevo Registro de Riego</span>
                </h5>
              </div>
              <div class="card-body p-4">
                <form id="riego-form">
                  <div class="row mb-3">
                    <div class="col-md-3">
                      <label for="labor" class="form-label font-weight-medium">
                        <i class="bi bi-tag me-1"></i> Labor
                      </label>
                      <input type="text" class="form-control" id="labor" name="labor" value="Riego" readonly />
                    </div>
                    <div class="col-md-9">
                      <label for="objetivo" class="form-label font-weight-medium">
                        <i class="bi bi-target me-1"></i> Objetivo *
                      </label>
                      <input type="text" class="form-control" id="objetivo" name="objetivo" 
                             placeholder="Objetivo del riego" required 
                             value="Reposición de agua en el suelo para el cultivo" />
                    </div>
                  </div>

                  <!-- Fincas -->
                  <div class="mb-4">
                    <label for="fincas-select" class="form-label font-weight-medium">
                      <i class="bi bi-geo-alt me-1"></i> Fincas *
                    </label>
                    <select id="fincas-select" class="form-select selectpicker" multiple 
                            title="Seleccione las fincas...">
                    </select>
                    <div class="form-text">Puede buscar y seleccionar múltiples fincas</div>
                  </div>

                  <!-- Cuarteles -->
                  <div class="mb-4">
                    <label for="cuarteles-select" class="form-label font-weight-medium">
                      <i class="bi bi-grid me-1"></i> Cuarteles *
                    </label>
                    <select id="cuarteles-select" class="form-select selectpicker" multiple 
                            title="Primero seleccione fincas..."
                            disabled>
                    </select>
                    <div class="form-text">Los cuarteles se cargan según las fincas seleccionadas</div>
                  </div>

                  <!-- Tabla de cuarteles seleccionados -->
                  <div id="tabla-cuarteles" class="mb-4"></div>

                  <!-- Maquinaria -->
                  <div class="row mb-4">
                    <div class="col-md-6">
                      <label for="maquinaria" class="form-label font-weight-medium">
                        <i class="bi bi-gear me-1"></i> Maquinaria utilizada
                      </label>
                      <input type="text" class="form-control" id="maquinaria" name="maquinaria" 
                             placeholder="Especificar maquinaria (opcional)" />
                    </div>
                  </div>

                  <div class="d-flex justify-content-between align-items-center">
                    <button type="submit" class="btn btn-primary btn-lg px-4">
                      <i class="bi bi-check-circle me-2"></i>
                      Registrar Riego
                    </button>
                    <a href="tareas.html" class="btn btn-outline-secondary">
                      <i class="bi bi-arrow-left me-1"></i> Volver a Tareas
                    </a>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sección de Riegos Registrados -->
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm border-0" style="border-radius: 16px;">
            <div class="card-header bg-white border-0 pt-4 pb-0">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0 d-flex align-items-center">
                  <i class="bi bi-list-ul text-primary me-2"></i>
                  <span>Riegos Registrados</span>
                  <span class="badge bg-primary ms-2" id="total-riegos">0</span>
                </h5>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-secondary btn-sm" id="btn-actualizar-riegos">
                    <i class="bi bi-arrow-clockwise me-1"></i> Actualizar
                  </button>
                  <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" 
                          data-bs-target="#listado-riegos" aria-expanded="true" aria-controls="listado-riegos" id="toggle-list-btn">
                    <i class="bi bi-dash-circle me-1"></i> Ocultar Listado
                  </button>
                </div>
              </div>
            </div>
            <div class="collapse show" id="listado-riegos">
              <div class="card-body p-4">
                <!-- Filtros -->
                <div class="row mb-3">
                  <div class="col-md-3">
                    <label for="filtro-fecha-desde" class="form-label">Desde:</label>
                    <input type="date" class="form-control form-control-sm" id="filtro-fecha-desde">
                  </div>
                  <div class="col-md-3">
                    <label for="filtro-fecha-hasta" class="form-label">Hasta:</label>
                    <input type="date" class="form-control form-control-sm" id="filtro-fecha-hasta">
                  </div>
                  <div class="col-md-4">
                    <label for="filtro-finca" class="form-label">Finca:</label>
                    <select class="form-select form-select-sm" id="filtro-finca">
                      <option value="">Todas las fincas</option>
                    </select>
                  </div>
                  <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-outline-secondary btn-sm w-100" id="btn-aplicar-filtros">
                      <i class="bi bi-funnel me-1"></i> Filtrar
                    </button>
                  </div>
                </div>

                <!-- Tabla de riegos -->
                <div class="table-responsive">
                  <table class="table table-hover table-sm">
                    <thead class="table-light">
                      <tr>
                        <th>Fecha</th>
                        <th>Finca</th>
                        <th>Cuartel</th>
                        <th>Regador</th>
                        <th>Horas</th>
                        <th>Volumen (m³)</th>
                        <th>Observaciones</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody id="tabla-riegos-body">
                      <tr>
                        <td colspan="8" class="text-center py-4">
                          <div class="d-flex justify-content-center align-items-center">
                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                            Cargando riegos...
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- Paginación -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                  <div class="text-muted">
                    <small>Mostrando <span id="registros-desde">0</span> - <span id="registros-hasta">0</span> de <span id="total-registros">0</span> registros</small>
                  </div>
                  <nav aria-label="Paginación de riegos">
                    <ul class="pagination pagination-sm mb-0" id="paginacion-riegos">
                      <!-- La paginación se genera dinámicamente -->
                    </ul>
                  </nav>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="status"></div>
    </main>

    <footer class="container">
      <small><a href="#">Privacidad</a> • <a href="#">Términos</a></small>
    </footer>

    <!-- Botón de ayuda flotante -->
    <button id="ayuda-riego-btn" title="Ayuda" style="position:fixed; bottom:2em; right:2em; z-index:1000; background:#e0eaff; color:#234; border:1px solid #8ab; border-radius:50%; width:2.5em; height:2.5em; font-size:1.5em; box-shadow:0 2px 8px #0002; cursor:pointer;">?</button>
    <div id="ayuda-riego-modal" style="display:none; position:fixed; bottom:5em; right:2em; z-index:1001; background:#fff; color:#222; border:1px solid #8ab; border-radius:8px; box-shadow:0 2px 16px #0003; padding:1em 1.2em; max-width:320px; font-size:1em;">
      <div id="ayuda-riego-contenido" style="white-space:pre-line;"></div>
      <button id="cerrar-ayuda-riego" style="margin-top:0.7em; float:right; background:#e0eaff; color:#234; border:1px solid #8ab; border-radius:4px; padding:0.2em 0.8em; font-size:1em;">Cerrar</button>
    </div>

    <script type="module">
      import { supabase } from "./supabaseClient.js";

      // Validar login y obtener user
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = "login.html";
        throw new Error("No autorizado");
      }

      // Cargar header
      fetch('header.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('header-container').innerHTML = html;
          import('./header.js');
        });

      // --- Elementos del DOM ---
      const status = document.getElementById("status");
      const fincasSelect = document.getElementById("fincas-select");
      const cuartelesSelect = document.getElementById("cuarteles-select");
      const tablaCuartelesDiv = document.getElementById("tabla-cuarteles");
      const toggleBtn = document.getElementById('toggle-form-btn');
      const formulario = document.getElementById('formulario-riego');

      // Función para mostrar mensajes con estilo Bootstrap
      function mostrarStatus(mensaje, tipo = 'info') {
        const alertClass = tipo === 'success' ? 'alert-success' : 
                          tipo === 'error' ? 'alert-danger' : 
                          tipo === 'warning' ? 'alert-warning' : 'alert-info';
        
        const icon = tipo === 'success' ? 'bi-check-circle' : 
                    tipo === 'error' ? 'bi-exclamation-triangle' : 
                    tipo === 'warning' ? 'bi-exclamation-triangle' : 'bi-info-circle';
        
        status.innerHTML = `
          <div class="alert ${alertClass} d-flex align-items-center" role="alert">
            <i class="bi ${icon} me-2"></i>
            <div>${mensaje}</div>
          </div>
        `;
        
        // Auto-ocultar después de 5 segundos si es éxito
        if (tipo === 'success') {
          setTimeout(() => {
            status.innerHTML = '';
          }, 5000);
        }
      }

      // Toggle del formulario
      if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
          setTimeout(() => {
            const isVisible = formulario.classList.contains('show');
            toggleBtn.innerHTML = isVisible ? 
              '<i class="bi bi-dash-circle me-1"></i> Ocultar Formulario' : 
              '<i class="bi bi-plus-circle me-1"></i> Mostrar Formulario';
          }, 150);
        });
      }

      // Cargar fincas al iniciar
      async function cargarFincas() {
        try {
          // Mostrar mensaje de carga simple
          fincasSelect.innerHTML = '<option disabled>Cargando fincas...</option>';
          $(fincasSelect).selectpicker('refresh');
          
          // Eliminar event listeners previos para evitar duplicados
          $(fincasSelect).off('changed.bs.select');
          
          const { data, error } = await supabase.from("fincas").select("id, nombre_finca").order('nombre_finca');
          if (error) {
            mostrarStatus("Error al cargar fincas: " + error.message, 'error');
            return;
          }
          
          console.log('🏠 Fincas recibidas:', data.length);
          
          // Limpiar y llenar el selector
          fincasSelect.innerHTML = '';
          data.forEach(finca => {
            const option = document.createElement("option");
            option.value = finca.id;
            option.textContent = finca.nombre_finca;
            fincasSelect.appendChild(option);
          });
          
          // Refrescar Bootstrap Select con configuración específica
          $(fincasSelect).selectpicker('refresh');
          
          // Forzar la recreación del actionsBox si no aparece
          setTimeout(() => {
            $(fincasSelect).selectpicker('destroy').selectpicker({
              style: 'btn-outline-secondary',
              size: 6,
              liveSearch: true,
              actionsBox: true,
              selectAllText: 'Todas las fincas',
              deselectAllText: 'Ninguna finca',
              noneSelectedText: 'Seleccione fincas...',
              countSelectedText: function(numSelected, numTotal) {
                return numSelected + ' fincas seleccionadas';
              }
            });
            
            // Reagregar el event listener después de la recreación
            $(fincasSelect).on('changed.bs.select', function() {
              console.log('🎯 Evento changed.bs.select disparado en fincas (recreado)');
              cargarCuarteles();
            });
          }, 100);
          
          console.log('✅ Fincas cargadas correctamente');
          
        } catch (error) {
          mostrarStatus('Error de conexión: ' + error.message, 'error');
          console.error('❌ Error cargando fincas:', error);
        }
      }

      // Cargar cuarteles según fincas seleccionadas
      let cargandoCuarteles = false; // Flag para evitar cargas múltiples
      
      async function cargarCuarteles() {
        if (cargandoCuarteles) return; // Evitar cargas simultáneas
        cargandoCuarteles = true;
        
        try {
          const fincasSeleccionadas = $(fincasSelect).val() || [];
          console.log('🔄 Cargando cuarteles para fincas:', fincasSeleccionadas);
          
          // Limpiar tabla de cuarteles
          tablaCuartelesDiv.innerHTML = '';
          
          // Eliminar event listeners previos para evitar duplicados
          $(cuartelesSelect).off('changed.bs.select');
          
          if (fincasSeleccionadas.length === 0) {
            // DESTRUIR COMPLETAMENTE el selector cuando no hay fincas
            $(cuartelesSelect).selectpicker('destroy');
            cuartelesSelect.innerHTML = '';
            cuartelesSelect.disabled = true;
            $(cuartelesSelect).selectpicker();
            cargandoCuarteles = false;
            return;
          }
          
          // DESTRUIR Y RECREAR el selector para evitar acumulación
          $(cuartelesSelect).selectpicker('destroy');
          cuartelesSelect.innerHTML = '<option disabled selected>Cargando cuarteles...</option>';
          cuartelesSelect.disabled = false;
          $(cuartelesSelect).selectpicker({
            style: 'btn-outline-secondary',
            size: 8,
            liveSearch: true,
            actionsBox: true,
            selectAllText: 'Todos los cuarteles',
            deselectAllText: 'Ningún cuartel',
            noneSelectedText: 'Seleccione cuarteles...',
            countSelectedText: function(numSelected, numTotal) {
              return numSelected + ' cuarteles seleccionados';
            }
          });
          
          const { data: cuarteles, error } = await supabase
            .from("cuarteles")
            .select("id, nombre, finca_id, fincas(nombre_finca)")
            .in("finca_id", fincasSeleccionadas)
            .order('nombre');
          
          if (error) {
            mostrarStatus("Error al cargar cuarteles: " + error.message, 'error');
            cuartelesSelect.innerHTML = '<option disabled>Error al cargar</option>';
            $(cuartelesSelect).selectpicker('refresh');
            cargandoCuarteles = false;
            return;
          }
          
          console.log('📦 Cuarteles recibidos:', cuarteles.length);
          
          // LIMPIAR COMPLETAMENTE antes de agregar nuevos
          cuartelesSelect.innerHTML = '';
          
          if (cuarteles.length === 0) {
            cuartelesSelect.innerHTML = '<option disabled selected>No hay cuarteles disponibles</option>';
          } else {
            // Usar un Map para garantizar unicidad por ID
            const cuartelesUnicos = new Map();
            cuarteles.forEach(cuartel => {
              if (!cuartelesUnicos.has(cuartel.id)) {
                cuartelesUnicos.set(cuartel.id, cuartel);
              }
            });
            
            console.log('✨ Cuarteles únicos después de Map:', cuartelesUnicos.size);
            
            // Convertir Map a array y agregar opciones
            Array.from(cuartelesUnicos.values()).forEach(cuartel => {
              const option = document.createElement("option");
              option.value = cuartel.id;
              option.textContent = `${cuartel.nombre} (${cuartel.fincas.nombre_finca})`;
              option.dataset.fincaId = cuartel.finca_id;
              cuartelesSelect.appendChild(option);
            });
          }
          
          // Refrescar y reagregar event listener
          $(cuartelesSelect).selectpicker('refresh');
          
          // Event listener para cambios en selección de cuarteles
          $(cuartelesSelect).on('changed.bs.select', function() {
            console.log('🎯 Evento changed.bs.select disparado en cuarteles');
            mostrarTablaCuarteles();
          });
          
          console.log('✅ Cuarteles cargados sin duplicados');
          
        } catch (error) {
          mostrarStatus('Error de conexión: ' + error.message, 'error');
          cuartelesSelect.innerHTML = '<option disabled>Error de conexión</option>';
          $(cuartelesSelect).selectpicker('refresh');
          console.error('❌ Error cargando cuarteles:', error);
        } finally {
          cargandoCuarteles = false;
        }
      }

      // Cargar operarios del usuario logueado
      const userId = user.id;
      let operariosGlobal = [];
      async function cargarOperarios() {
        const { data: operarios, error } = await supabase
          .from("aplicadores_operarios")
          .select("id, nombre")
          .eq("usuario_id", userId);
        if (error) {
          mostrarStatus("Error al cargar operarios: " + error.message, 'error');
          return [];
        }
        operariosGlobal = operarios;
        return operarios;
      }

      async function mostrarTablaCuarteles() {
        tablaCuartelesDiv.innerHTML = "";
        const cuartelesSeleccionados = $(cuartelesSelect).val() || [];
        if (cuartelesSeleccionados.length === 0) return;
        
        try {
          // Traer info de cuarteles
          const { data: cuarteles, error } = await supabase
            .from("cuarteles")
            .select("id, nombre, especie, finca_id")
            .in("id", cuartelesSeleccionados);
          if (error) {
            mostrarStatus("Error al cargar info de cuarteles: " + error.message, 'error');
            return;
          }
          
          // Traer variedades asociadas a cada cuartel
          const variedadesPorCuartel = {};
          for (const cuartel of cuarteles) {
            const { data: variedades, error: errorVar } = await supabase
              .from("cuartel_variedades")
              .select("variedades(nombre)")
              .eq("cuartel_id", cuartel.id);
            variedadesPorCuartel[cuartel.id] = (!errorVar && variedades && variedades.length > 0)
              ? variedades.map(v => v.variedades.nombre).join(", ") : "";
          }
          
          // Crear tabla con Bootstrap 5
          let html = `
            <div class="table-responsive">
              <table class="table table-bordered table-sm">
                <thead class="table-light">
                  <tr>
                    <th>Cuartel</th><th>Fecha</th><th>Horas</th><th>Volumen (m³)</th>
                    <th>Regador</th><th>Observaciones</th><th>Variedad</th><th>Especie</th>
                  </tr>
                </thead>
                <tbody>`;
          
          // Obtener valores por defecto
          let operadorDefault = operariosGlobal[0]?.id || "";
          let fechaDefault = new Date().toISOString().slice(0,10);
          let horasDefault = "";
          let volumenDefault = "";
          
          cuarteles.forEach((cuartel, idx) => {
            html += `<tr>
              <td><strong>${cuartel.nombre}</strong></td>
              <td><input type='date' class='form-control form-control-sm fecha-celda' value='${fechaDefault}'/></td>
              <td><input type='number' class='form-control form-control-sm horas-celda' min='0' step='0.1' value='${horasDefault}' placeholder='0.0'/></td>
              <td><input type='number' class='form-control form-control-sm volumen-celda' min='0' step='0.1' value='${volumenDefault}' placeholder='0.0'/></td>
              <td><select class='form-select form-select-sm operador-celda'>${operariosGlobal.map(op => `<option value='${op.id}' ${op.id===operadorDefault?"selected":""}>${op.nombre}</option>`).join("")}</select></td>
              <td><input type='text' class='form-control form-control-sm obs-celda' placeholder='Observaciones'/></td>
              <td><input type='text' class='form-control form-control-sm' value='${variedadesPorCuartel[cuartel.id]}' readonly style='background-color: #f8f9fa;'/></td>
              <td><input type='text' class='form-control form-control-sm' value='${cuartel.especie || ""}' readonly style='background-color: #f8f9fa;'/></td>
              <td style='display:none'><input type='hidden' class='cuartel-id' value='${cuartel.id}'/></td>
              <td style='display:none'><input type='hidden' class='finca-id' value='${cuartel.finca_id}'/></td>
            </tr>`;
          });
          html += `</tbody></table></div>`;
          tablaCuartelesDiv.innerHTML = html;

          // Lógica de autocompletado: al cambiar el primer regador/fecha/horas/volumen, propagar a los demás
          const filas = tablaCuartelesDiv.querySelectorAll('tbody tr');
          if (filas.length > 1) {
            // Regador: propaga al hacer click o change
            const propagaRegador = e => {
              const val = filas[0].querySelector('.operador-celda').value;
              filas.forEach((fila, idx) => { if(idx>0) fila.querySelector('.operador-celda').value = val; });
            };
            filas[0].querySelector('.operador-celda').addEventListener('change', propagaRegador);
            filas[0].querySelector('.operador-celda').addEventListener('click', propagaRegador);
            // Fecha
            filas[0].querySelector('.fecha-celda').addEventListener('change', e => {
              const val = e.target.value;
              filas.forEach((fila, idx) => { if(idx>0) fila.querySelector('.fecha-celda').value = val; });
            });
            // Horas
            filas[0].querySelector('.horas-celda').addEventListener('change', e => {
              const val = e.target.value;
              filas.forEach((fila, idx) => { if(idx>0 && !fila.querySelector('.horas-celda').value) fila.querySelector('.horas-celda').value = val; });
            });
            // Volumen
            filas[0].querySelector('.volumen-celda').addEventListener('change', e => {
              const val = e.target.value;
              filas.forEach((fila, idx) => { if(idx>0 && !fila.querySelector('.volumen-celda').value) fila.querySelector('.volumen-celda').value = val; });
            });
          }
        } catch (error) {
          mostrarStatus('Error de conexión: ' + error.message, 'error');
        }
      }

      // Proponer objetivo al cargar el formulario o tras resetear
      function proponerObjetivo() {
        const objetivoInput = document.getElementById("objetivo");
        if (objetivoInput) {
          objetivoInput.value = "Reposición de agua en el suelo para el cultivo";
        }
      }
      window.addEventListener('DOMContentLoaded', proponerObjetivo);
      // También tras resetear el formulario
      document.getElementById("riego-form").addEventListener("reset", proponerObjetivo);

      // Guardar registro de riego
      document.getElementById("riego-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        mostrarStatus("Guardando registro de riego...", 'info');
        
        const filas = tablaCuartelesDiv.querySelectorAll('tbody tr');
        if (filas.length === 0) {
          mostrarStatus("Seleccione al menos un cuartel para registrar el riego", 'warning');
          return;
        }
        
        const registros = [];
        for (const fila of filas) {
          const fecha = fila.querySelector('.fecha-celda').value;
          const operador = fila.querySelector('.operador-celda').value;
          
          if (!fecha || !operador) {
            mostrarStatus("Complete la fecha y seleccione un regador para todos los cuarteles", 'warning');
            return;
          }
          
          registros.push({
            finca_id: fila.querySelector('.finca-id').value,
            cuartel_id: fila.querySelector('.cuartel-id').value,
            operador_id: operador,
            fecha: fecha,
            maquinaria: document.getElementById('maquinaria')?.value || '',
            horas_riego: fila.querySelector('.horas-celda').value || 0,
            volumen_agua: fila.querySelector('.volumen-celda').value || 0,
            observaciones: fila.querySelector('.obs-celda').value,
            labor: "Riego",
            objetivo: document.getElementById('objetivo').value,
          });
        }
        
        try {
          const { error } = await supabase.from("riegos").insert(registros);
          if (error) {
            mostrarStatus("Error al guardar riego: " + error.message, 'error');
            console.error(error);
          } else {
            mostrarStatus(`Riego registrado exitosamente para ${registros.length} cuartel(es)`, 'success');
            document.getElementById("riego-form").reset();
            tablaCuartelesDiv.innerHTML = '';
            // Limpiar selectores con Bootstrap Select
            $(fincasSelect).val(null).trigger('change');
            $(cuartelesSelect).val(null).trigger('change');
            // Asegurar que el objetivo propuesto se reponga tras reset
            proponerObjetivo();
            // Actualizar listado de riegos
            setTimeout(() => cargarRiegos(1), 500);
          }
        } catch (error) {
          mostrarStatus('Error de conexión: ' + error.message, 'error');
        }
      });

      // Inicializar y esperar a que jQuery esté completamente disponible
      $(document).ready(async function() {
        console.log('🔧 Inicializando Bootstrap Select...');
        
        // Verificar que los elementos existen
        if (!fincasSelect || !cuartelesSelect) {
          console.error('❌ Elementos select no encontrados');
          return;
        }

        // Configuración específica para cada selector con actionsBox
        try {
          // Configurar selectores individualmente para asegurar actionsBox
          $('#fincas-select').selectpicker({
            style: 'btn-outline-secondary',
            size: 6,
            liveSearch: true,
            actionsBox: true,
            selectAllText: 'Todas las fincas',
            deselectAllText: 'Ninguna finca',
            noneSelectedText: 'Seleccione fincas...',
            countSelectedText: function(numSelected, numTotal) {
              return numSelected + ' fincas seleccionadas';
            },
            multipleSeparator: ', '
          });

          $('#cuarteles-select').selectpicker({
            style: 'btn-outline-secondary', 
            size: 8,
            liveSearch: true,
            actionsBox: true,
            selectAllText: 'Todos los cuarteles',
            deselectAllText: 'Ningún cuartel',
            noneSelectedText: 'Seleccione cuarteles...',
            countSelectedText: function(numSelected, numTotal) {
              return numSelected + ' cuarteles seleccionados';
            },
            multipleSeparator: ', '
          });
          
          console.log('✅ Bootstrap Select inicializado globalmente');
          
          // Verificar que actionsBox esté presente
          setTimeout(() => {
            const actionsBoxFincas = $(fincasSelect).next('.dropdown-menu').find('.bs-actionsbox');
            const actionsBoxCuarteles = $(cuartelesSelect).next('.dropdown-menu').find('.bs-actionsbox');
            console.log('🎛️ ActionsBox Fincas encontrado:', actionsBoxFincas.length > 0);
            console.log('🎛️ ActionsBox Cuarteles encontrado:', actionsBoxCuarteles.length > 0);
          }, 500);

          // DESPUÉS cargar datos
          console.log('📊 Cargando datos...');
          await cargarFincas();
          await cargarOperarios();
          console.log('✅ Inicialización completa');
          
        } catch (error) {
          console.error('❌ Error en inicialización:', error);
        }
      });

      // --- FUNCIONES PARA LISTADO DE RIEGOS ---
      
      // Variables para paginación
      let paginaActual = 1;
      const registrosPorPagina = 10;
      let totalRegistros = 0;
      let datosRiegos = [];

      // Toggle del listado
      const toggleListBtn = document.getElementById('toggle-list-btn');
      const listadoRiegos = document.getElementById('listado-riegos');
      
      if (toggleListBtn) {
        toggleListBtn.addEventListener('click', function() {
          setTimeout(() => {
            const isVisible = listadoRiegos.classList.contains('show');
            toggleListBtn.innerHTML = isVisible ? 
              '<i class="bi bi-dash-circle me-1"></i> Ocultar Listado' : 
              '<i class="bi bi-plus-circle me-1"></i> Mostrar Listado';
          }, 150);
        });
      }

      // Exponer funciones globalmente ANTES de cualquier uso
      window.cargarRiegos = function(pagina = 1) {
        return cargarRiegos(pagina);
      };
      window.aplicarFiltros = function() {
        return aplicarFiltros();
      };

      // Cargar riegos con paginación
      async function cargarRiegos(pagina = 1) {
        try {
          paginaActual = pagina;
          const tbody = document.getElementById('tabla-riegos-body');
          
          // Mostrar spinner
          tbody.innerHTML = `
            <tr>
              <td colspan="8" class="text-center py-4">
                <div class="d-flex justify-content-center align-items-center">
                  <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                  Cargando riegos...
                </div>
              </td>
            </tr>
          `;

          // Obtener filtros
          const fechaDesde = document.getElementById('filtro-fecha-desde').value;
          const fechaHasta = document.getElementById('filtro-fecha-hasta').value;
          const fincaId = document.getElementById('filtro-finca').value;

          // Construir query base para contar
          let countQuery = supabase
            .from('riegos')
            .select('id', { count: 'exact', head: true });

          // Aplicar filtros al conteo
          if (fechaDesde) {
            countQuery = countQuery.gte('fecha', fechaDesde);
          }
          if (fechaHasta) {
            countQuery = countQuery.lte('fecha', fechaHasta);
          }
          if (fincaId) {
            countQuery = countQuery.eq('finca_id', fincaId);
          }

          // Obtener total para paginación
          const { count, error: countError } = await countQuery;
          if (countError) throw countError;
          
          totalRegistros = count || 0;

          // Construir query para datos - usando relaciones explícitas
          let dataQuery = supabase
            .from('riegos')
            .select(`
              id, fecha, horas_riego, volumen_agua, observaciones, maquinaria, operador_id,
              fincas!finca_id(nombre_finca),
              cuarteles!cuartel_id(nombre)
            `)
            .order('fecha', { ascending: false });

          // Aplicar filtros a los datos
          if (fechaDesde) {
            dataQuery = dataQuery.gte('fecha', fechaDesde);
          }
          if (fechaHasta) {
            dataQuery = dataQuery.lte('fecha', fechaHasta);
          }
          if (fincaId) {
            dataQuery = dataQuery.eq('finca_id', fincaId);
          }

          // Aplicar paginación
          const desde = (pagina - 1) * registrosPorPagina;
          const hasta = desde + registrosPorPagina - 1;
          
          const { data: riegos, error: dataError } = await dataQuery
            .range(desde, hasta);

          if (dataError) throw dataError;

          datosRiegos = riegos || [];
          
          // Obtener información de operarios por separado si hay registros
          if (datosRiegos.length > 0) {
            const operarioIds = [...new Set(datosRiegos.map(r => r.operador_id).filter(id => id))];
            if (operarioIds.length > 0) {
              const { data: operarios } = await supabase
                .from('aplicadores_operarios')
                .select('id, nombre')
                .in('id', operarioIds);
              
              // Mapear operarios a un objeto para acceso rápido
              const operariosMap = {};
              if (operarios) {
                operarios.forEach(op => {
                  operariosMap[op.id] = op.nombre;
                });
              }
              
              // Agregar información de operarios a los datos
              datosRiegos.forEach(riego => {
                riego.operario_nombre = operariosMap[riego.operador_id] || 'N/A';
              });
            }
          }
          
          // Actualizar contador
          document.getElementById('total-riegos').textContent = totalRegistros;
          
          // Renderizar tabla
          renderizarTablaRiegos();
          
          // Actualizar paginación
          actualizarPaginacion();

        } catch (error) {
          console.error('Error cargando riegos:', error);
          mostrarStatus('Error al cargar riegos: ' + error.message, 'error');
          
          const tbody = document.getElementById('tabla-riegos-body');
          tbody.innerHTML = `
            <tr>
              <td colspan="8" class="text-center py-4 text-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Error al cargar los datos
              </td>
            </tr>
          `;
        }
      }

      // Renderizar tabla de riegos
      function renderizarTablaRiegos() {
        const tbody = document.getElementById('tabla-riegos-body');
        
        if (datosRiegos.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" class="text-center py-4 text-muted">
                <i class="bi bi-inbox me-2"></i>
                No se encontraron registros de riego
              </td>
            </tr>
          `;
          return;
        }

        const html = datosRiegos.map(riego => {
          const fecha = new Date(riego.fecha).toLocaleDateString('es-ES');
          const horas = riego.horas_riego ? parseFloat(riego.horas_riego).toFixed(1) : '0.0';
          const volumen = riego.volumen_agua ? parseFloat(riego.volumen_agua).toFixed(1) : '0.0';
          
          return `
            <tr>
              <td>${fecha}</td>
              <td>${riego.fincas?.nombre_finca || 'N/A'}</td>
              <td>${riego.cuarteles?.nombre || 'N/A'}</td>
              <td>${riego.operario_nombre || 'N/A'}</td>
              <td>${horas}h</td>
              <td>${volumen} m³</td>
              <td>${riego.observaciones || '-'}</td>
              <td>
                <div class="btn-group btn-group-sm" role="group">
                  <button class="btn btn-outline-primary btn-sm" onclick="editarRiego(${riego.id})" title="Editar">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm" onclick="eliminarRiego(${riego.id})" title="Eliminar">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
        
        tbody.innerHTML = html;
      }

      // Actualizar paginación
      function actualizarPaginacion() {
        const totalPaginas = Math.ceil(totalRegistros / registrosPorPagina);
        const paginacion = document.getElementById('paginacion-riegos');
        
        // Actualizar información de registros
        const desde = (paginaActual - 1) * registrosPorPagina + 1;
        const hasta = Math.min(paginaActual * registrosPorPagina, totalRegistros);
        
        document.getElementById('registros-desde').textContent = totalRegistros > 0 ? desde : 0;
        document.getElementById('registros-hasta').textContent = hasta;
        document.getElementById('total-registros').textContent = totalRegistros;

        if (totalPaginas <= 1) {
          paginacion.innerHTML = '';
          return;
        }

        let html = '';
        
        // Botón anterior
        html += `
          <li class="page-item ${paginaActual === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="cargarRiegos(${paginaActual - 1}); return false;">
              <i class="bi bi-chevron-left"></i>
            </a>
          </li>
        `;

        // Páginas
        const inicio = Math.max(1, paginaActual - 2);
        const fin = Math.min(totalPaginas, paginaActual + 2);

        if (inicio > 1) {
          html += `<li class="page-item"><a class="page-link" href="#" onclick="cargarRiegos(1); return false;">1</a></li>`;
          if (inicio > 2) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
          }
        }

        for (let i = inicio; i <= fin; i++) {
          html += `
            <li class="page-item ${i === paginaActual ? 'active' : ''}">
              <a class="page-link" href="#" onclick="cargarRiegos(${i}); return false;">${i}</a>
            </li>
          `;
        }

        if (fin < totalPaginas) {
          if (fin < totalPaginas - 1) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
          }
          html += `<li class="page-item"><a class="page-link" href="#" onclick="cargarRiegos(${totalPaginas}); return false;">${totalPaginas}</a></li>`;
        }

        // Botón siguiente
        html += `
          <li class="page-item ${paginaActual === totalPaginas ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="cargarRiegos(${paginaActual + 1}); return false;">
              <i class="bi bi-chevron-right"></i>
            </a>
          </li>
        `;

        paginacion.innerHTML = html;
      }

      // Aplicar filtros
      async function aplicarFiltros() {
        // Mostrar indicador de carga en el botón
        const btnFiltrar = document.getElementById('btn-aplicar-filtros');
        const textoOriginal = btnFiltrar.innerHTML;
        btnFiltrar.innerHTML = '<div class="spinner-border spinner-border-sm me-1" role="status"></div> Filtrando...';
        btnFiltrar.disabled = true;
        
        try {
          paginaActual = 1;
          await cargarRiegos(1);
        } finally {
          // Restaurar botón
          btnFiltrar.innerHTML = textoOriginal;
          btnFiltrar.disabled = false;
        }
      }

      // Cargar fincas para filtro
      async function cargarFincasFiltro() {
        try {
          const { data: fincas, error } = await supabase
            .from('fincas')
            .select('id, nombre_finca')
            .order('nombre_finca');

          if (error) throw error;

          const select = document.getElementById('filtro-finca');
          select.innerHTML = '<option value="">Todas las fincas</option>';
          
          fincas.forEach(finca => {
            const option = document.createElement('option');
            option.value = finca.id;
            option.textContent = finca.nombre_finca;
            select.appendChild(option);
          });

        } catch (error) {
          console.error('Error cargando fincas para filtro:', error);
        }
      }

      // Funciones para acciones de riegos
      window.editarRiego = function(id) {
        // TODO: Implementar edición de riego
        mostrarStatus('Función de edición en desarrollo', 'info');
      };

      window.eliminarRiego = function(id) {
        if (confirm('¿Está seguro de que desea eliminar este registro de riego?')) {
          eliminarRiegoConfirmado(id);
        }
      };

      async function eliminarRiegoConfirmado(id) {
        try {
          mostrarStatus('Eliminando registro...', 'info');
          
          const { error } = await supabase
            .from('riegos')
            .delete()
            .eq('id', id);

          if (error) throw error;

          mostrarStatus('Registro eliminado exitosamente', 'success');
          await cargarRiegos(paginaActual);

        } catch (error) {
          console.error('Error eliminando riego:', error);
          mostrarStatus('Error al eliminar: ' + error.message, 'error');
        }
      }

      // Inicializar listado de riegos
      setTimeout(async () => {
        // Establecer fechas por defecto (último mes)
        const hoy = new Date();
        const haceUnMes = new Date();
        haceUnMes.setMonth(haceUnMes.getMonth() - 1);
        
        document.getElementById('filtro-fecha-desde').value = haceUnMes.toISOString().slice(0, 10);
        document.getElementById('filtro-fecha-hasta').value = hoy.toISOString().slice(0, 10);
        
        await cargarFincasFiltro();
        await cargarRiegos(1);
        
        // Debounce para filtros automáticos
        let filtroTimeout;
        const aplicarFiltrosDebounced = () => {
          clearTimeout(filtroTimeout);
          filtroTimeout = setTimeout(aplicarFiltros, 300);
        };
        
        // Event listeners para filtros automáticos con debounce
        document.getElementById('filtro-fecha-desde').addEventListener('change', aplicarFiltrosDebounced);
        document.getElementById('filtro-fecha-hasta').addEventListener('change', aplicarFiltrosDebounced);
        document.getElementById('filtro-finca').addEventListener('change', aplicarFiltrosDebounced);
        
        // Event listeners para botones
        document.getElementById('btn-actualizar-riegos').addEventListener('click', () => cargarRiegos(paginaActual));
        document.getElementById('btn-aplicar-filtros').addEventListener('click', aplicarFiltros);
      }, 1000);

      // Ayuda general flotante (carga dinámica desde archivo txt externo solo la primera vez)
      document.addEventListener('DOMContentLoaded', () => {
        const ayudaBtn = document.getElementById('ayuda-riego-btn');
        const ayudaModal = document.getElementById('ayuda-riego-modal');
        const ayudaContenido = document.getElementById('ayuda-riego-contenido');
        let ayudaCargada = false;
        const AYUDA_VERSION = 'v1.2';
        if (ayudaBtn && ayudaModal && ayudaContenido) {
          ayudaBtn.onclick = async () => {
            console.log('Ayuda Riego', AYUDA_VERSION, 'click');
            if (!ayudaCargada) {
              try {
                const res = await fetch('ayuda_riego.txt?_v=' + AYUDA_VERSION);
                const txt = await res.text();
                console.log('Ayuda cargada:', txt.slice(0, 60));
                ayudaContenido.textContent = txt;
                ayudaCargada = true;
              } catch (e) {
                ayudaContenido.textContent = 'No se pudo cargar la ayuda.';
                console.error('Error cargando ayuda:', e);
                ayudaCargada = true;
              }
            }
            ayudaModal.style.display = 'block';
          };
          // Delegación para cerrar el modal
          ayudaModal.addEventListener('click', e => {
            if (e.target.id === 'cerrar-ayuda-riego') {
              ayudaModal.style.display = 'none';
            }
          });
          window.addEventListener('click', e => {
            if (ayudaModal.style.display === 'block' && !ayudaModal.contains(e.target) && e.target !== ayudaBtn) {
              ayudaModal.style.display = 'none';
            }
          });
        }
      });
    </script>
  </body>
</html>